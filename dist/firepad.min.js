!function(t,e){"undefined"!=typeof module&&module.exports?module.exports=t():"function"==typeof e.define&&e.define.amd?define(t):e.Firepad=t()}(function(){var e,w,N,I,H,r,h,i,B,U,W,k={title_page:/^((?:title|credit|author[s]?|source|notes|draft date|date|contact|copyright)\:)/gim,scene_heading:/^((?:\*{0,3}_?)?(?:(?:int|ext|i\/e|est)[. ]).+)|^(?:\.(?!\.+))(.+)/i,scene_number:/( *#(.+)# *)/,transition:/^((?:FADE (?:TO BLACK|OUT)|CUT TO BLACK)\.|.+ TO\:)|^(?:> *)(.+)/,character:/^[A-Z*_][0-9A-Z (._\-',)]*[A-Z*_)]$/,dialogue:/^([A-Z*_][0-9A-Z (._\-',)]*[A-Z*_)])(\^?)?(?:\n(?!\n+))([\s\S]+)/,parenthetical:/^(\(.+\))$/,lyrics:/^~(.+)/g,action:/^(.+)/g,centered:/^(?:> *)(.+)(?: *<)(\n.+)*/g,section:/^(#+)(?: *)(.*)/,synopsis:/^(?:\=(?!\=+) *)(.*)/,note:/^(?:\[{2}(?!\[+))(.+)(?:\]{2}(?!\[+))$/,note_inline:/(?:\[{2}(?!\[+))([\s\S]+?)(?:\]{2}(?!\[+))/g,boneyard:/(^\/\*|^\*\/)$/g,page_break:/^\={3,}$/,line_break:/^ {2}$/,emphasis:/(_|\*{1,3}|_\*{1,3}|\*{1,3}_)(.+)(_|\*{1,3}|_\*{1,3}|\*{1,3}_)/g,bold_italic_underline:/(_{1}\*{3}(?=.+\*{3}_{1})|\*{3}_{1}(?=.+_{1}\*{3}))(.+?)(\*{3}_{1}|_{1}\*{3})/g,bold_underline:/(_{1}\*{2}(?=.+\*{2}_{1})|\*{2}_{1}(?=.+_{1}\*{2}))(.+?)(\*{2}_{1}|_{1}\*{2})/g,italic_underline:/(?:_{1}\*{1}(?=.+\*{1}_{1})|\*{1}_{1}(?=.+_{1}\*{1}))(.+?)(\*{1}_{1}|_{1}\*{1})/g,bold_italic:/(\*{3}(?=.+\*{3}))(.+?)(\*{3})/g,bold:/(\*{2}(?=.+\*{2}))(.+?)(\*{2})/g,italic:/(\*{1}(?=.+\*{1}))(.+?)(\*{1})/g,underline:/(_{1}(?=.+_{1}))(.+?)(_{1})/g,splitter:/\n{2,}/g,cleaner:/^\n+|\n+$/,standardizer:/\r\n|\r/g,whitespacer:/^\t+|^ {3,}/gm},Y={clean:function(t){return t.replace(k.boneyard,"\n$1\n").replace(k.standardizer,"\n").replace(k.cleaner,"").replace(k.whitespacer,"")},tokenize:function(t,e){var n,r,i,o,s,a=t.map(function(t){return t.text}).join("\n"),c=Y.clean(a).split(k.splitter),l=0,h=e?{}:[];for(i in c){var p=c[i],d=[],u=!1;if(!u&&k.title_page.test(p)){for(o=0,s=(n=p.replace(k.title_page,"\n$1").split(k.splitter)).length;o<s;o++)y=n[o].replace(k.cleaner,"").split(/\:\n*/),d.push({type:y[0].trim().toLowerCase().replace(" ","_"),text:y[1].trim()});u=!0}if(!u&&(n=p.match(k.scene_heading))&&((g=n[1]||n[2]).indexOf("  ")!==g.length-2&&((r=g.match(k.scene_number))&&(r=r[2],g=g.replace(k.scene_number,"")),d.push({type:"scene_heading",text:g,scene_number:r||void 0})),u=!0),!u&&(n=p.match(k.centered))&&(d.push({type:"centered",text:n[0].replace(/>|</g,"")}),u=!0),!u&&(n=p.match(k.transition))&&(d.push({type:"transition",text:n[1]||n[2]}),u=!0),!u&&(n=p.match(k.dialogue))&&n[1].indexOf("  ")!==n[1].length-2){var f,g,y=(n[3]+"\n").split(/(?:^|\n+)(\(.+\))(?:\n+)/);for((dual_diaglogue=!!n[2])&&d.push({type:"dual_dialogue_begin"}),d.push({type:"dialogue_begin",dual:dual_diaglogue?"right":void 0}),d.push({type:"character",text:n[1].trim()}),o=0,s=y.length;o<s;o++)0<(g=y[o].trim()).length&&(f=k.parenthetical.test(g)?"parenthetical":"dialogue",d.push({type:f,text:g}));d.push({type:"dialogue_end"}),dual_diaglogue&&d.push({type:"dual_dialogue_end"}),u=!0}!u&&(n=p.match(k.section))&&(d.push({type:"section",text:n[2],depth:n[1].length}),u=!0),!u&&(n=p.match(k.synopsis))&&(d.push({type:"synopsis",text:n[1]}),u=!0),!u&&(n=p.match(k.note))&&(d.push({type:"note",text:n[1]}),u=!0),!u&&(n=p.match(k.boneyard))&&(d.push({type:"/"===n[0][0]?"boneyard_begin":"boneyard_end"}),u=!0),!u&&k.page_break.test(p)&&(d.push({type:"page_break"}),u=!0),!u&&k.line_break.test(p)&&(d.push({type:"line_break"}),u=!0),!u&&k.lyrics.test(p)&&(d.push({type:"lyrics",text:p}),u=!0),u||d.push({type:"action",text:p});for(var m=0;m<d.length;m++){var _=d[m];if(_.text)for(var b=_.text.split("\n"),v=0;v<b.length;v++){var E=b[v],C=JSON.parse(JSON.stringify(_)),L=!1,x=null;for(C.text=E;!L&&l<t.length;)0<=t[l].text.indexOf(E)&&(x=t[l].line,L=!0),l++;e?x&&(h[x]=C):h.push(C)}else e||h.push(_)}}return h}},j={parse:function(t,e,n){void 0===n&&"function"==typeof e?(n=e,e={}):void 0===e&&(e={});var r=e.tokens||!1,e=e.html||!1,i={};if(r)i.tokens=Y.tokenize(t,!0);else if(e){var o,s,a=[],c=[],l=Y.tokenize(t,!1);for(s in l)switch((o=l[s]).text=j.lexer(o.text),o.type){case"title":a.push("<h1>"+o.text+"</h1>");break;case"credit":a.push('<p class="credit">'+o.text+"</p>");break;case"author":case"authors":a.push('<p class="authors">'+o.text+"</p>");break;case"source":a.push('<p class="source">'+o.text+"</p>");break;case"notes":a.push('<p class="notes">'+o.text+"</p>");break;case"draft_date":a.push('<p class="draft-date">'+o.text+"</p>");break;case"date":a.push('<p class="date">'+o.text+"</p>");break;case"contact":a.push('<p class="contact">'+o.text+"</p>");break;case"copyright":a.push('<p class="copyright">'+o.text+"</p>");break;case"scene_heading":c.push("<h2"+(o.scene_number?' id="'+o.scene_number+'">':">")+o.text+"</h2>");break;case"transition":c.push('<p class="transition">'+o.text+"</p>");break;case"dual_dialogue_begin":c.push('<div class="dual-dialogue">');break;case"dialogue_begin":c.push('<div class="dialogue'+(o.dual?" "+o.dual:"")+'">');break;case"character":c.push("<h4>"+o.text.replace(/^@/,"")+"</h4>");break;case"parenthetical":c.push('<p class="parenthetical">'+o.text+"</p>");break;case"dialogue":c.push("<p>"+o.text+"</p>");break;case"dialogue_end":case"dual_dialogue_end":c.push("</div>");break;case"section":c.push('<p class="section" data-depth="'+o.depth+'">'+o.text+"</p>");break;case"synopsis":c.push('<p class="synopsis">'+o.text+"</p>");break;case"note":c.push("\x3c!-- "+o.text+" --\x3e");break;case"boneyard_begin":c.push("\x3c!-- ");break;case"boneyard_end":c.push(" --\x3e");break;case"lyrics":c.push('<p class="lyrics">'+o.text+"</p>");break;case"action":c.push("<p>"+o.text+"</p>");break;case"centered":c.push('<p class="centered">'+o.text+"</p>");break;case"page_break":c.push("<hr />");break;case"line_break":c.push("<br />")}i.title_page_html=a.join(""),i.script_html=c.join("")}return"function"==typeof n?n(i):i},lexer:function(t){if(t){var e,n,r,i={note:"\x3c!-- $1 --\x3e",line_break:"<br />",bold_italic_underline:'<strong><em><span style="text-decoration:underline">$2</span></em></strong>',bold_underline:'<strong><span style="text-decoration:underline">$2</span></strong>',italic_underline:'<em><span style="text-decoration:underline">$1</span></em>',bold_italic:"<strong><em>$2</em></strong>",bold:"<strong>$2</strong>",italic:"<em>$2</em>",underline:'<span style="text-decoration:underline">$2</span>'},o=["bold_italic_underline","bold_underline","italic_underline","bold_italic","bold","italic","underline"];for(r in t=t.replace(k.note_inline,i.note).replace(/\\\*/g,"[star]").replace(/\\_/g,"[underline]").replace(/\n/g,i.line_break),o)(n=k[e=o[r]]).test(t)&&(t=t.replace(n,i[e]));return t.replace(/\[star\]/g,"*").replace(/\[underline\]/g,"_").trim()}}};function q(t,e){this.pos=t,this.length=e}function t(t){this.type=t,this.chars=null,this.text=null,this.attributes=null,"insert"===t?(this.text=arguments[1],e.assert("string"==typeof this.text),this.attributes=arguments[2]||{},e.assert("object"==typeof this.attributes)):"delete"===t?(this.chars=arguments[1],e.assert("number"==typeof this.chars)):"retain"===t&&(this.chars=arguments[1],e.assert("number"==typeof this.chars),this.attributes=arguments[2]||{},e.assert("object"==typeof this.attributes))}function l(t,e){if(!t)throw new Error("AnnotationList assertion failed"+(e?": "+e:""))}function p(t,e){this.pos=t,this.length=e.length,this.annotation=e.annotation,this.attachedObject_=e.attachedObject}function V(t,e){this.pos=t,this.length=e.length,this.annotation=e.annotation,this.node_=e}function n(t){this.head_=new d(0,N),this.changeHandler_=t}function d(t,e){this.length=t,this.annotation=e,this.attachedObject=null,this.next=null}function o(t,e,n,r,i){this.ref_=t,this.ready_=!1,this.firebaseCallbacks_=[],this.zombie_=!1,this.deviceId_=e||t.push().key,this.color_=r||null,this.name_=i||null,this.document_=new I,this.revision_=0,this.pendingReceivedRevisions_={},n=n||t.push().key,this.setUserId(n);var e=t.root.child(".info/connected"),o=this;this.firebaseOn_(e,"value",function(t){!0===t.val()&&o.initializeUserData_()},this),this.on("ready",function(){o.monitorCursors_()}),setTimeout(function(){o.monitorHistory_()},0)}function J(t,e){if(!t)throw new Error(e||"assertion error")}function u(t){if(t<0)return"";if(0===t)return"A0";for(var e="";0<t;){var n=t%r.length,e=r[n]+e;t=(t-=n)/r.length}return r[e.length+9]+e}function K(t){J(0<t.length&&t[0]===r[t.length+8]);for(var e=0,n=1;n<t.length;n++)e=(e*=r.length)+r.indexOf(t[n]);return e}function s(t){this.imageInsertionUI=t,this.element_=this.makeElement_()}function $(){this.element_=this.makeElement_()}function a(){this.entities_={};var i=["src","alt","width","height","style","class"];this.register("img",{render:function(t){B.assert(t.src,"image entity should have 'src'!");for(var e=["src","alt","width","height","style","class"],n="<img ",r=0;r<e.length;r++){var i=e[r];i in t&&(n+=" "+i+'="'+t[i]+'"')}return n+=">"},fromElement:function(t){for(var e={},n=0;n<i.length;n++){var r=i[n];t.hasAttribute(r)&&(e[r]=t.getAttribute(r))}return e}})}function G(t,e){if(!(this instanceof G))return new G(t,e);this.type=t,this.info=e||{}}(P=P||{}).utils={},P.utils.makeEventEmitter=function(t,e){t.prototype.allowedEvents_=e,t.prototype.on=function(t,e,n){this.validateEventType_(t),this.eventListeners_=this.eventListeners_||{},this.eventListeners_[t]=this.eventListeners_[t]||[],this.eventListeners_[t].push({callback:e,context:n})},t.prototype.off=function(t,e){this.validateEventType_(t),this.eventListeners_=this.eventListeners_||{};for(var n=this.eventListeners_[t]||[],r=0;r<n.length;r++)if(n[r].callback===e)return void n.splice(r,1)},t.prototype.trigger=function(t){this.eventListeners_=this.eventListeners_||{};for(var e=this.eventListeners_[t]||[],n=0;n<e.length;n++)e[n].callback.apply(e[n].context,Array.prototype.slice.call(arguments,1))},t.prototype.validateEventType_=function(t){if(this.allowedEvents_){for(var e=!1,n=0;n<this.allowedEvents_.length;n++)if(this.allowedEvents_[n]===t){e=!0;break}if(!e)throw new Error('Unknown event "'+t+'"')}}},P.utils.elt=function(t,e,n){var r,i=document.createElement(t);if("string"==typeof e)P.utils.setTextContent(i,e);else if(e)for(var o=0;o<e.length;++o)i.appendChild(e[o]);for(r in n||{})i.setAttribute(r,n[r]);return i},P.utils.setTextContent=function(t,e){t.innerHTML="",t.appendChild(document.createTextNode(e))},P.utils.on=function(t,e,n,r){t.addEventListener?t.addEventListener(e,n,r||!1):t.attachEvent&&t.attachEvent("on"+e,n)},P.utils.off=function(t,e,n,r){t.removeEventListener?t.removeEventListener(e,n,r||!1):t.detachEvent&&t.detachEvent("on"+e,n)},P.utils.preventDefault=function(t){t.preventDefault?t.preventDefault():t.returnValue=!1},P.utils.stopPropagation=function(t){t.stopPropagation?t.stopPropagation():t.cancelBubble=!0},P.utils.stopEvent=function(t){P.utils.preventDefault(t),P.utils.stopPropagation(t)},P.utils.stopEventAnd=function(e){return function(t){return e(t),P.utils.stopEvent(t),!1}},P.utils.trim=function(t){return t.replace(/^\s+/g,"").replace(/\s+$/g,"")},P.utils.stringEndsWith=function(t,e){for(var n="string"==typeof e?[e]:e,r=0;r<n.length;r++){e=n[r];if(-1!==t.indexOf(e,t.length-e.length))return!0}return!1},P.utils.assert=function(t,e){if(!t)throw new Error(e||"assertion error")},P.utils.log=function(){if("undefined"!=typeof console&&void 0!==console.log){for(var t=["Firepad:"],e=0;e<arguments.length;e++)t.push(arguments[e]);console.log.apply(console,t)}},(P=P||{}).Span=(q.prototype.end=function(){return this.pos+this.length},q),(P=P||{}).TextOp=(e=P.utils,t.prototype.isInsert=function(){return"insert"===this.type},t.prototype.isDelete=function(){return"delete"===this.type},t.prototype.isRetain=function(){return"retain"===this.type},t.prototype.equals=function(t){return this.type===t.type&&this.text===t.text&&this.chars===t.chars&&this.attributesEqual(t.attributes)},t.prototype.attributesEqual=function(t){for(var e in this.attributes)if(this.attributes[e]!==t[e])return!1;for(e in t)if(this.attributes[e]!==t[e])return!1;return!0},t.prototype.hasEmptyAttributes=function(){var t,e=!0;for(t in this.attributes){e=!1;break}return e},t),(P=P||{}).TextOperation=function(){"use strict";var i=P.TextOp,y=P.utils;function d(){if(!this||this.constructor!==d)return new d;this.ops=[],this.baseLength=0,this.targetLength=0}function o(t){var e=t.ops;switch(e.length){case 1:return e[0];case 2:return e[0].isRetain()?e[1]:e[1].isRetain()?e[0]:null;case 3:if(e[0].isRetain()&&e[2].isRetain())return e[1]}return null}function s(t){return t.ops[0].isRetain()?t.ops[0].chars:0}return d.prototype.equals=function(t){if(this.baseLength!==t.baseLength)return!1;if(this.targetLength!==t.targetLength)return!1;if(this.ops.length!==t.ops.length)return!1;for(var e=0;e<this.ops.length;e++)if(!this.ops[e].equals(t.ops[e]))return!1;return!0},d.prototype.retain=function(t,e){if("number"!=typeof t||t<0)throw new Error("retain expects a positive integer.");var n;return 0!==t&&(this.baseLength+=t,this.targetLength+=t,e=e||{},(n=0<this.ops.length?this.ops[this.ops.length-1]:null)&&n.isRetain()&&n.attributesEqual(e)?n.chars+=t:this.ops.push(new i("retain",t,e))),this},d.prototype.insert=function(t,e){if("string"!=typeof t)throw new Error("insert expects a string");var n,r;return""!==t&&(e=e||{},this.targetLength+=t.length,n=0<this.ops.length?this.ops[this.ops.length-1]:null,r=1<this.ops.length?this.ops[this.ops.length-2]:null,n&&n.isInsert()&&n.attributesEqual(e)?n.text+=t:n&&n.isDelete()?r&&r.isInsert()&&r.attributesEqual(e)?r.text+=t:(this.ops[this.ops.length-1]=new i("insert",t,e),this.ops.push(n)):this.ops.push(new i("insert",t,e))),this},d.prototype.delete=function(t){if("number"!=typeof(t="string"==typeof t?t.length:t)||t<0)throw new Error("delete expects a positive integer or a string");var e;return 0!==t&&(this.baseLength+=t,(e=0<this.ops.length?this.ops[this.ops.length-1]:null)&&e.isDelete()?e.chars+=t:this.ops.push(new i("delete",t))),this},d.prototype.isNoop=function(){return 0===this.ops.length||1===this.ops.length&&this.ops[0].isRetain()&&this.ops[0].hasEmptyAttributes()},d.prototype.clone=function(){for(var t=new d,e=0;e<this.ops.length;e++)this.ops[e].isRetain()?t.retain(this.ops[e].chars,this.ops[e].attributes):this.ops[e].isInsert()?t.insert(this.ops[e].text,this.ops[e].attributes):t.delete(this.ops[e].chars);return t},d.prototype.toString=function(){return(Array.prototype.map||function(t){for(var e=[],n=0,r=this.length;n<r;n++)e[n]=t(this[n]);return e}).call(this.ops,function(t){return t.isRetain()?"retain "+t.chars:t.isInsert()?"insert '"+t.text+"'":"delete "+t.chars}).join(", ")},d.prototype.toJSON=function(){for(var t=[],e=0;e<this.ops.length;e++)this.ops[e].hasEmptyAttributes()||t.push(this.ops[e].attributes),"retain"===this.ops[e].type?t.push(this.ops[e].chars):"insert"===this.ops[e].type?t.push(this.ops[e].text):"delete"===this.ops[e].type&&t.push(-this.ops[e].chars);return 0===t.length&&t.push(0),t},d.fromJSON=function(t){for(var e=new d,n=0,r=t.length;n<r;n++){var i=t[n],o={};"object"==typeof i&&(o=i,i=t[++n]),"number"==typeof i?0<i?e.retain(i,o):e.delete(-i):(y.assert("string"==typeof i),e.insert(i,o))}return e},d.prototype.apply=function(t,e,n){if(e=e||[],n=n||[],t.length!==this.baseLength)throw new Error("The operation's base length must be equal to the string's length.");for(var r,i,o=[],s=0,a=0,c=this.ops,l=0,h=c.length;l<h;l++){var p=c[l];if(p.isRetain()){if(a+p.chars>t.length)throw new Error("Operation can't retain more characters than are left in the string.");for(o[s++]=t.slice(a,a+p.chars),r=0;r<p.chars;r++){var d=e[a+r]||{},u={};for(i in d)u[i]=d[i],y.assert(!1!==u[i]);for(i in p.attributes)!1===p.attributes[i]?delete u[i]:u[i]=p.attributes[i],y.assert(!1!==u[i]);n.push(u)}a+=p.chars}else if(p.isInsert())for(o[s++]=p.text,r=0;r<p.text.length;r++){var f={};for(i in p.attributes)f[i]=p.attributes[i],y.assert(!1!==f[i]);n.push(f)}else a+=p.chars}if(a!==t.length)throw new Error("The operation didn't operate on the whole string.");var g=o.join("");return y.assert(g.length===n.length),g},d.prototype.invert=function(t){for(var e=0,n=new d,r=this.ops,i=0,o=r.length;i<o;i++){var s=r[i];s.isRetain()?(n.retain(s.chars),e+=s.chars):s.isInsert()?n.delete(s.text.length):(n.insert(t.slice(e,e+s.chars)),e+=s.chars)}return n},d.prototype.compose=function(t){if(this.targetLength!==t.baseLength)throw new Error("The base length of the second operation has to be the target length of the first operation");function e(t,e,n){var r,i={};for(r in t)i[r]=t[r];for(r in e)n&&!1===e[r]?delete i[r]:i[r]=e[r];return i}for(var n,r=new d,i=this.clone().ops,o=t.clone().ops,s=0,a=0,c=i[s++],l=o[a++];void 0!==c||void 0!==l;)if(c&&c.isDelete())r.delete(c.chars),c=i[s++];else if(l&&l.isInsert())r.insert(l.text,l.attributes),l=o[a++];else{if(void 0===c)throw new Error("Cannot compose operations: first operation is too short.");if(void 0===l)throw new Error("Cannot compose operations: first operation is too long.");if(c.isRetain()&&l.isRetain())n=e(c.attributes,l.attributes),c.chars>l.chars?(r.retain(l.chars,n),c.chars-=l.chars,l=o[a++]):c.chars===l.chars?(r.retain(c.chars,n),c=i[s++],l=o[a++]):(r.retain(c.chars,n),l.chars-=c.chars,c=i[s++]);else if(c.isInsert()&&l.isDelete())c.text.length>l.chars?(c.text=c.text.slice(l.chars),l=o[a++]):c.text.length===l.chars?(c=i[s++],l=o[a++]):(l.chars-=c.text.length,c=i[s++]);else if(c.isInsert()&&l.isRetain())n=e(c.attributes,l.attributes,!0),c.text.length>l.chars?(r.insert(c.text.slice(0,l.chars),n),c.text=c.text.slice(l.chars),l=o[a++]):c.text.length===l.chars?(r.insert(c.text,n),c=i[s++],l=o[a++]):(r.insert(c.text,n),l.chars-=c.text.length,c=i[s++]);else{if(!c.isRetain()||!l.isDelete())throw new Error("This shouldn't happen: op1: "+JSON.stringify(c)+", op2: "+JSON.stringify(l));c.chars>l.chars?(r.delete(l.chars),c.chars-=l.chars,l=o[a++]):c.chars===l.chars?(r.delete(l.chars),c=i[s++],l=o[a++]):(r.delete(c.chars),l.chars-=c.chars,c=i[s++])}}return r},d.prototype.shouldBeComposedWith=function(t){var e,n,r;return!(!this.isNoop()&&!t.isNoop())||(e=s(this),n=s(t),r=o(this),t=o(t),!(!r||!t)&&(r.isInsert()&&t.isInsert()?e+r.text.length===n:!(!r.isDelete()||!t.isDelete())&&(n+t.chars===e||e===n)))},d.prototype.shouldBeComposedWithInverted=function(t){var e,n,r;return!(!this.isNoop()&&!t.isNoop())||(e=s(this),n=s(t),r=o(this),t=o(t),!(!r||!t)&&(r.isInsert()&&t.isInsert()?e+r.text.length===n||e===n:!(!r.isDelete()||!t.isDelete())&&n+t.chars===e))},d.transformAttributes=function(t,e){var n,r={},i={},o={};for(n in t)o[n]=!0;for(n in e)o[n]=!0;for(n in o){var s=t[n],a=e[n];y.assert(null!=s||null!=a),null==s?i[n]=a:null!=a&&s===a||(r[n]=s)}return[r,i]},d.transform=function(t,e){if(t.baseLength!==e.baseLength)throw new Error("Both operations have to have the same base length");for(var n,r=new d,i=new d,o=t.clone().ops,s=e.clone().ops,a=0,c=0,l=o[a++],h=s[c++];void 0!==l||void 0!==h;)if(l&&l.isInsert())r.insert(l.text,l.attributes),i.retain(l.text.length),l=o[a++];else if(h&&h.isInsert())r.retain(h.text.length),i.insert(h.text,h.attributes),h=s[c++];else{if(void 0===l)throw new Error("Cannot transform operations: first operation is too short.");if(void 0===h)throw new Error("Cannot transform operations: first operation is too long.");if(l.isRetain()&&h.isRetain()){var p=d.transformAttributes(l.attributes,h.attributes);l.chars>h.chars?(n=h.chars,l.chars-=h.chars,h=s[c++]):l.chars===h.chars?(n=h.chars,l=o[a++],h=s[c++]):(n=l.chars,h.chars-=l.chars,l=o[a++]),r.retain(n,p[0]),i.retain(n,p[1])}else if(l.isDelete()&&h.isDelete())l.chars>h.chars?(l.chars-=h.chars,h=s[c++]):l.chars===h.chars?(l=o[a++],h=s[c++]):(h.chars-=l.chars,l=o[a++]);else if(l.isDelete()&&h.isRetain())l.chars>h.chars?(n=h.chars,l.chars-=h.chars,h=s[c++]):l.chars===h.chars?(n=h.chars,l=o[a++],h=s[c++]):(n=l.chars,h.chars-=l.chars,l=o[a++]),r.delete(n);else{if(!l.isRetain()||!h.isDelete())throw new Error("The two operations aren't compatible");l.chars>h.chars?(n=h.chars,l.chars-=h.chars,h=s[c++]):l.chars===h.chars?(n=l.chars,l=o[a++],h=s[c++]):(n=l.chars,h.chars-=l.chars,l=o[a++]),i.delete(n)}}return[r,i]},d.prototype.transform=function(t){return d.transform(this,t)},d}(),(P=P||{}).AnnotationList=(w=P.Span,p.prototype.getAttachedObject=function(){return this.attachedObject_},V.prototype.attachObject=function(t){this.node_.attachedObject=t},N={equals:function(){return!1}},n.prototype.insertAnnotatedSpan=function(i,o){this.wrapOperation_(new w(i.pos,0),function(t,e){l(!e||null===e.next);var n,r=new d(i.length,o);return e?(l(i.pos>t&&i.pos<t+e.length),(n=new d(0,N)).next=new d(i.pos-t,e.annotation),(n.next.next=r).next=new d(t+e.length-i.pos,e.annotation),n.next):r})},n.prototype.removeSpan=function(o){0!==o.length&&this.wrapOperation_(o,function(t,e){l(null!==e);var n=new d(0,N),r=n;for(o.pos>t&&(r.next=new d(o.pos-t,e.annotation),r=r.next);o.end()>t+e.length;)t+=e.length,e=e.next;var i=t+e.length-o.end();return 0<i&&(r.next=new d(i,e.annotation)),n.next})},n.prototype.updateSpan=function(a,c){0!==a.length&&this.wrapOperation_(a,function(t,e){l(null!==e);var n=new d(0,N),r=n,i=t,o=a.pos-i;for(l(o<e.length),0<o&&(r.next=new d(o,e.annotation),i+=(r=r.next).length);null!==e&&a.end()>=t+e.length;){var s=t+e.length-i;r.next=new d(s,c(e.annotation,s)),r=r.next,t+=e.length,e=e.next,i=t}o=a.end()-i;return 0<o&&(l(o<e.length),r.next=new d(o,c(e.annotation,o)),i+=(r=r.next).length,r.next=new d(t+e.length-i,e.annotation)),n.next})},n.prototype.wrapOperation_=function(t,e){if(t.pos<0)throw new Error("Span start cannot be negative.");var n,r,i=[],o=[],t=this.getAffectedNodes_(t),s=(null!==t.start?(n=t.end.next,t.end.next=null):n=t.succ,e(t.startPos,t.start)),e=!1,a=!1;if(s){for(this.mergeNodesWithSameAnnotations_(s),r=t.pred&&t.pred.annotation.equals(s.annotation)?(e=!0,s.length+=t.pred.length,t.beforePred.next=s,t.predPos):(t.beforeStart.next=s,t.startPos);s.next;)o.push(new V(r,s)),r+=s.length,s=s.next;t.succ&&t.succ.annotation.equals(s.annotation)?(s.length+=t.succ.length,a=!0,s.next=t.succ.next):s.next=n,o.push(new V(r,s))}else t.pred&&t.succ&&t.pred.annotation.equals(t.succ.annotation)?(a=e=!0,s=new d(t.pred.length+t.succ.length,t.pred.annotation),(t.beforePred.next=s).next=t.succ.next,o.push(new V(t.startPos-t.pred.length,s))):t.beforeStart.next=n;e&&i.push(new p(t.predPos,t.pred));for(var c=t.startPos,l=t.start;null!==l;)i.push(new p(c,l)),c+=l.length,l=l.next;a&&i.push(new p(c,t.succ)),this.changeHandler_(i,o)},n.prototype.getAffectedNodes_=function(t){for(var e={},n=null,r=this.head_,i=r.next,o=0;null!==i&&t.pos>=o+i.length;)o+=i.length,n=r,i=(r=i).next;if(null===i&&(0!==t.length||t.pos!==o))throw new Error("Span start exceeds the bounds of the AnnotationList.");for(e.startPos=o,0===t.length&&t.pos===o?e.start=null:e.start=i,e.beforeStart=r,o===t.pos&&0<o?(e.pred=r,e.predPos=o-r.length,e.beforePred=n):e.pred=null;null!==i&&t.end()>o;)o+=i.length,i=(r=i).next;if(t.end()>o)throw new Error("Span end exceeds the bounds of the AnnotationList.");return 0===t.length&&t.end()===o?e.end=null:e.end=r,e.succ=o===t.end()?i:null,e},n.prototype.mergeNodesWithSameAnnotations_=function(t){if(t)for(var e=null,n=t;n;)e&&e.annotation.equals(n.annotation)?(e.length+=n.length,e.next=n.next):e=n,n=n.next},n.prototype.forEach=function(t){for(var e=this.head_.next;null!==e;)t(e.length,e.annotation,e.attachedObject),e=e.next},n.prototype.getAnnotatedSpansForPos=function(t){for(var e=0,n=this.head_.next,r=null;null!==n&&e+n.length<=t;)e+=n.length,n=(r=n).next;if(null===n&&e!==t)throw new Error("pos exceeds the bounds of the AnnotationList");var i=[];return e===t&&r&&i.push(new p(e-r.length,r)),n&&i.push(new p(e,n)),i},n.prototype.getAnnotatedSpansForSpan=function(t){if(0===t.length)return[];for(var e=[],n=this.getAffectedNodes_(t),r=n.startPos,i=n.start;null!==i&&r<t.end();){var o=Math.max(r,t.pos),s=Math.min(r+i.length,t.end()),s=new w(o,s-o);s.annotation=i.annotation,e.push(s),r+=i.length,i=i.next}return e},n.prototype.getAllAnnotations=function(){for(var t=[],e=this.head_.next;null!==e;)t.push(e.annotation),e=e.next;return t},n.prototype.count=function(){for(var t=0,e=this.head_.next,n=null;null!==e;)n&&l(!n.annotation.equals(e.annotation)),e=(n=e).next,t++;return t},d.prototype.clone=function(){var t=new d(this.spanLength,this.annotation);return t.next=this.next,t},n),(P=P||{}).Cursor=function(){"use strict";function n(t,e){this.position=t,this.selectionEnd=e}return n.fromJSON=function(t){return new n(t.position,t.selectionEnd)},n.prototype.equals=function(t){return this.position===t.position&&this.selectionEnd===t.selectionEnd},n.prototype.compose=function(t){return t},n.prototype.transform=function(o){function t(t){for(var e=t,n=o.ops,r=0,i=o.ops.length;r<i&&(n[r].isRetain()?t-=n[r].chars:n[r].isInsert()?e+=n[r].text.length:(e-=Math.min(t,n[r].chars),t-=n[r].chars),!(t<0));r++);return e}var e=t(this.position);return this.position===this.selectionEnd?new n(e,e):new n(e,t(this.selectionEnd))},n}(),(P=P||{}).FirebaseAdapter=("undefined"==typeof firebase&&"function"==typeof require&&"function"!=typeof Firebase&&(firebase=require("firebase")),I=P.TextOperation,(H=P.utils).makeEventEmitter(o,["ready","cursor","operation","ack","retry"]),o.prototype.dispose=function(){var t=this;this.ready_?(this.removeFirebaseCallbacks_(),this.userRef_&&(this.userRef_.child("id").remove(),this.userRef_.child("cursor").remove(),this.userRef_.child("color").remove(),this.userRef_.child("name").remove()),this.ref_=null,this.document_=null,this.zombie_=!0):this.on("ready",function(){t.dispose()})},o.prototype.setUserId=function(t){this.userRef_&&(this.userRef_.child("id").remove(),this.userRef_.child("id").onDisconnect().cancel(),this.userRef_.child("cursor").remove(),this.userRef_.child("cursor").onDisconnect().cancel(),this.userRef_.child("color").remove(),this.userRef_.child("color").onDisconnect().cancel(),this.userRef_.child("name").remove(),this.userRef_.child("name").onDisconnect().cancel()),this.userId_=t,this.userRef_=this.ref_.child("users").child(this.deviceId_),this.initializeUserData_()},o.prototype.onUsersChange=function(t){this.onUsersChangeCallback=t},o.prototype.isHistoryEmpty=function(){return J(this.ready_,"Not ready yet."),0===this.revision_},o.prototype.sendOperation=function(t,s){var e,a=this;this.ready_?(J(this.document_.targetLength===t.baseLength,"sendOperation() called with invalid operation."),e=u(this.revision_),this.sent_={id:e,op:t},function r(i,o){a.ref_.child("history").child(i).transaction(function(t){if(null===t)return o},function(t,e,n){if(t){if("disconnect"!==t.message)throw H.log("Transaction failure!",t),t;a.sent_&&a.sent_.id===i?setTimeout(function(){r(i,o)},0):s&&s(t,!1)}else s&&s(null,e)},!1)}(e,{a:a.userId_,o:t.toJSON(),t:firebase.database.ServerValue.TIMESTAMP})):this.on("ready",function(){a.trigger("retry")})},o.prototype.setId=function(t){this.userRef_.child("id").set(t),this.userId_=t},o.prototype.sendCursor=function(t){this.userRef_.child("cursor").set(t),this.cursor_=t},o.prototype.setColor=function(t){this.userRef_.child("color").set(t),this.color_=t},o.prototype.setName=function(t){this.userRef_.child("name").set(t),this.name_=t},o.prototype.getDocument=function(){return this.document_},o.prototype.registerCallbacks=function(t){for(var e in t)this.on(e,t[e])},o.prototype.getLastRevision=function(){return u(this.revision_-1)},o.prototype.getRevisionsFromRevision=function(t,e){var n=this,r=[];t=t||"A0",n.ref_.child("history").startAt(null,t).once("value",function(t){n.zombie_||(t.forEach(function(t){var e=t.val();r.push({id:t.key,author:e.a,timestamp:parseInt(e.t,10)})}),e(r))})},o.prototype.getDocumentAtRevision=function(r,i){var s=this,a=new I,c=[],l=0;function o(t,e,o){s.ref_.child("history").startAt(null,t).endAt(null,e).once("value",function(t){if(!s.zombie_){t.forEach(function(t){c[t.key]=t.val()});for(var e=l,n=u(e);null!=c[n];){var r=c[n],i=null;try{i=I.fromJSON(r.o)}catch(t){return console.log(t),o(null)}i&&(a=a.compose(i)),delete c[n],n=u(++e)}o(a)}})}r=r||u(0),s.ref_.child("checkpoint").once("value",function(t){var e,n;if(!s.zombie_)return e=t.child("id").val(),n=t.child("o").val(),t=t.child("a").val(),null!=n&&null!=e&&null!==t&&e<r?(c[e]={o:n,a:t},o(u((l=K(e))+1),r,i)):o(u(0),r,i)})},o.prototype.saveOmittedScene=function(t,e){this.ref_.child("omittedScenes").child(t).set(e)},o.prototype.getOmittedScene=function(t,e){this.ref_.child("omittedScenes").child(t).once("value",function(t){e(t.val())},function(t){e(null)})},o.prototype.deleteOmittedScene=function(t){this.ref_.child("omittedScenes").child(t).remove()},o.prototype.initializeUserData_=function(){this.userRef_.child("id").onDisconnect().remove(),this.userRef_.child("cursor").onDisconnect().remove(),this.userRef_.child("color").onDisconnect().remove(),this.userRef_.child("name").onDisconnect().remove(),this.userRef_.set({id:this.userId_||null,cursor:this.cursor_||null,color:this.color_||null,name:this.name_||null})},o.prototype.monitorCursors_=function(){var t=this.ref_.child("users"),o=this;function n(){o.onUsersChangeCallback&&t.once("value").then(function(t){var e,n,r=t.val(),i={};for(e in r)r.hasOwnProperty(e)&&"backend"!==e&&(n=r[e].id)&&!i[n]&&(i[n]={name:r[e].name,color:r[e].color});o.users=i,o.onUsersChangeCallback(i)})}this.firebaseOn_(t,"child_added",function(t){var e=t.key,t=t.val();o.trigger("cursor",e,t.id,t.cursor,t.color,t.name),n()}),this.firebaseOn_(t,"child_changed",function(t){var e=t.key,t=t.val();o.trigger("cursor",e,t.id,t.cursor,t.color,t.name),!t.id||o.users&&o.users[t.id]&&o.users[t.id].name===t.name&&o.users[t.id].color===t.color||n()}),this.firebaseOn_(t,"child_removed",function(t){t=t.key;o.trigger("cursor",t),n()})},o.prototype.monitorHistory_=function(){var r=this;this.ref_.child("checkpoint").once("value",function(t){var e,n;r.zombie_||(e=t.child("id").val(),n=t.child("o").val(),t=t.child("a").val(),null!=n&&null!=e&&null!==t?(r.pendingReceivedRevisions_[e]={o:n,a:t},r.checkpointRevision_=K(e),r.monitorHistoryStartingAt_(r.checkpointRevision_+1)):(r.checkpointRevision_=0,r.monitorHistoryStartingAt_(r.checkpointRevision_)))})},o.prototype.monitorHistoryStartingAt_=function(t){var e=this.ref_.child("history").startAt(null,u(t)),n=this;setTimeout(function(){n.firebaseOn_(e,"child_added",function(t){var e=t.key;n.pendingReceivedRevisions_[e]=t.val(),n.ready_&&n.handlePendingReceivedRevisions_()}),e.once("value",function(){n.handleInitialRevisions_()})},0)},o.prototype.handleInitialRevisions_=function(){J(!this.ready_,"Should not be called multiple times."),this.revision_=this.checkpointRevision_;for(var t=u(this.revision_),e=this.pendingReceivedRevisions_;null!=e[t];){var n=this.parseRevision_(e[t]);n?this.document_=this.document_.compose(n.operation):H.log("Invalid operation.",this.ref_.toString(),t,e[t]),delete e[t],this.revision_++,t=u(this.revision_)}this.trigger("operation",this.document_),this.ready_=!0;var r=this;setTimeout(function(){r.trigger("ready")},0)},o.prototype.handlePendingReceivedRevisions_=function(){for(var t=this.pendingReceivedRevisions_,e=u(this.revision_),n=!1;null!=t[e];){this.revision_++;var r=this.parseRevision_(t[e]);r?(this.document_=this.document_.compose(r.operation),this.sent_&&e===this.sent_.id?this.sent_.op.equals(r.operation)&&r.author===this.userId_?(this.revision_%100==0&&this.saveCheckpoint_(),this.sent_=null,this.trigger("ack")):(n=!0,this.trigger("operation",r.operation)):this.trigger("operation",r.operation)):H.log("Invalid operation.",this.ref_.toString(),e,t[e]),delete t[e],e=u(this.revision_)}n&&(this.sent_=null,this.trigger("retry"))},o.prototype.parseRevision_=function(t){if("object"!=typeof t)return null;if("string"!=typeof t.a||"object"!=typeof t.o)return null;var e=null;try{e=I.fromJSON(t.o)}catch(t){return null}return e.baseLength!==this.document_.targetLength?null:{author:t.a,operation:e}},o.prototype.saveCheckpoint_=function(){this.ref_.child("checkpoint").set({a:this.userId_,o:this.document_.toJSON(),id:u(this.revision_-1)})},o.prototype.firebaseOn_=function(t,e,n,r){return this.firebaseCallbacks_.push({ref:t,eventType:e,callback:n,context:r}),t.on(e,n,r),n},o.prototype.firebaseOff_=function(t,e,n,r){t.off(e,n,r);for(var i=0;i<this.firebaseCallbacks_.length;i++){var o=this.firebaseCallbacks_[i];if(o.ref===t&&o.eventType===e&&o.callback===n&&o.context===r){this.firebaseCallbacks_.splice(i,1);break}}},o.prototype.removeFirebaseCallbacks_=function(){for(var t=0;t<this.firebaseCallbacks_.length;t++){var e=this.firebaseCallbacks_[t];e.ref.off(e.eventType,e.callback,e.context)}this.firebaseCallbacks_=[]},r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",o),(P=P||{}).RichTextToolbar=((h=P.utils).makeEventEmitter(s,["bold","italic","underline","strike","font","font-size","color","left","center","right","unordered-list","ordered-list","todo-list","indent-increase","indent-decrease","undo","redo","insert-image"]),s.prototype.element=function(){return this.element_},s.prototype.makeButton_=function(t,e){var n=this,e=h.elt("a",[h.elt("span","",{class:"firepad-tb-"+(e=e||t)})],{class:"firepad-btn"});return h.on(e,"click",h.stopEventAnd(function(){n.trigger(t)})),e},s.prototype.makeElement_=function(){var t=this,e=this.makeFontDropdown_(),n=this.makeFontSizeDropdown_(),r=this.makeColorDropdown_(),e=[h.elt("div",[e],{class:"firepad-btn-group"}),h.elt("div",[n],{class:"firepad-btn-group"}),h.elt("div",[r],{class:"firepad-btn-group"}),h.elt("div",[t.makeButton_("bold"),t.makeButton_("italic"),t.makeButton_("underline"),t.makeButton_("strike","strikethrough")],{class:"firepad-btn-group"}),h.elt("div",[t.makeButton_("unordered-list","list-2"),t.makeButton_("ordered-list","numbered-list"),t.makeButton_("todo-list","list")],{class:"firepad-btn-group"}),h.elt("div",[t.makeButton_("indent-decrease"),t.makeButton_("indent-increase")],{class:"firepad-btn-group"}),h.elt("div",[t.makeButton_("left","paragraph-left"),t.makeButton_("center","paragraph-center"),t.makeButton_("right","paragraph-right")],{class:"firepad-btn-group"}),h.elt("div",[t.makeButton_("undo"),t.makeButton_("redo")],{class:"firepad-btn-group"})],n=(t.imageInsertionUI&&e.push(h.elt("div",[t.makeButton_("insert-image")],{class:"firepad-btn-group"})),h.elt("div",e,{class:"firepad-toolbar-wrapper"})),r=h.elt("div",null,{class:"firepad-toolbar"});return r.appendChild(n),r},s.prototype.makeFontDropdown_=function(){for(var t=["Arial","Comic Sans MS","Courier New","Impact","Times New Roman","Verdana"],e=[],n=0;n<t.length;n++){var r=h.elt("span",t[n]);r.setAttribute("style","font-family:"+t[n]),e.push({content:r,value:t[n]})}return this.makeDropdown_("Font","font",e)},s.prototype.makeFontSizeDropdown_=function(){for(var t=[9,10,12,14,18,24,32,42],e=[],n=0;n<t.length;n++){var r=h.elt("span",t[n].toString());r.setAttribute("style","font-size:"+t[n]+"px; line-height:"+(t[n]-6)+"px;"),e.push({content:r,value:t[n]})}return this.makeDropdown_("Size","font-size",e,"px")},s.prototype.makeColorDropdown_=function(){for(var t=["black","red","green","blue","yellow","cyan","magenta","grey"],e=[],n=0;n<t.length;n++){var r=h.elt("div");r.className="firepad-color-dropdown-item",r.setAttribute("style","background-color:"+t[n]),e.push({content:r,value:t[n]})}return this.makeDropdown_("Color","color",e)},s.prototype.makeDropdown_=function(t,n,e,r){r=r||"";var i=this,t=h.elt("a",t+" ▾",{class:"firepad-btn firepad-dropdown"}),o=h.elt("ul",[],{class:"firepad-dropdown-menu"}),s=(t.appendChild(o),!1);var a=!1;function c(){s&&(o.style.display="",h.off(document,"click",c,!0),s=!1),a=!0,setTimeout(function(){a=!1},0)}for(var l=0;l<e.length;l++)!function(t,e){"object"!=typeof t&&(t=document.createTextNode(String(t))),t=h.elt("a",[t]),h.on(t,"click",h.stopEventAnd(function(){c(),i.trigger(n,e+r)})),o.appendChild(t)}(e[l].content,e[l].value);return h.on(t,"click",h.stopEventAnd(function(){a||s||(o.style.display="block",h.on(document,"click",c,!0),s=!0)})),t},s),(P=P||{}).ScreenplayToolbar=((i=P.utils).makeEventEmitter($,["screenplay-scene","screenplay-action","screenplay-character","screenplay-dialogue","screenplay-parenthetical","screenplay-transition","screenplay-act-start","screenplay-act-end","screenplay-auto-format","screenplay-centered"]),$.prototype.element=function(){return this.element_},$.prototype.makeButton_=function(t,e){var n=this,e=i.elt("a",[i.elt("span","",{class:"firepad-tb-"+(e=e||t)})],{class:"firepad-btn"});return i.on(e,"click",i.stopEventAnd(function(){n.trigger(t)})),e},$.prototype.makeElement_=function(){var t=this,t=[i.elt("div",[t.makeButton_("screenplay-scene","pc-scene"),t.makeButton_("screenplay-action","pc-action"),t.makeButton_("screenplay-character","pc-character"),t.makeButton_("screenplay-dialogue","pc-dialogue"),t.makeButton_("screenplay-parenthetical","pc-parenthetical"),t.makeButton_("screenplay-transition","pc-transition"),t.makeButton_("screenplay-act-start","pc-act-start"),t.makeButton_("screenplay-act-end","pc-act-end")],{class:"firepad-btn-group"}),i.elt("div",[t.makeButton_("screenplay-centered","pc-centered")],{class:"firepad-btn-group"}),i.elt("div",[t.makeButton_("screenplay-auto-format","pc-auto-format")],{class:"firepad-btn-group"})],t=i.elt("div",t,{class:"firepad-toolbar-wrapper"}),e=i.elt("div",null,{class:"firepad-toolbar"});return e.appendChild(t),e},$),(P=P||{}).WrappedOperation=function(){"use strict";function r(t,e){this.wrapped=t,this.meta=e}function n(t,e){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}function i(t,e){return t&&"object"==typeof t&&"function"==typeof t.transform?t.transform(e):t}return r.prototype.apply=function(){return this.wrapped.apply.apply(this.wrapped,arguments)},r.prototype.invert=function(){var t=this.meta;return new r(this.wrapped.invert.apply(this.wrapped,arguments),t&&"object"==typeof t&&"function"==typeof t.invert?t.invert.apply(t,arguments):t)},r.prototype.compose=function(t){return new r(this.wrapped.compose(t.wrapped),(e=this.meta,t=t.meta,e&&"object"==typeof e?"function"==typeof e.compose?e.compose(t):(n(e,e={}),n(t,e),e):t));var e},r.transform=function(t,e){var n=t.wrapped.transform(e.wrapped);return[new r(n[0],i(t.meta,e.wrapped)),new r(n[1],i(e.meta,t.wrapped))]},r.prototype.transform=function(t){return r.transform(this,t)},r}(),(P=P||{}).UndoManager=function(){"use strict";var e="normal",r="undoing",i="redoing";function t(t){this.maxItems=t||50,this.state=e,this.dontCompose=!1,this.undoStack=[],this.redoStack=[]}function n(t,e){for(var n=[],r=e.constructor,i=t.length-1;0<=i;i--){var o=r.transform(t[i],e);"function"==typeof o[0].isNoop&&o[0].isNoop()||n.push(o[0]),e=o[1]}return n.reverse()}return t.prototype.add=function(t,e){var n;this.state===r?(this.redoStack.push(t),this.dontCompose=!0):this.state===i?(this.undoStack.push(t),this.dontCompose=!0):(n=this.undoStack,!this.dontCompose&&e&&0<n.length?n.push(t.compose(n.pop())):(n.push(t),n.length>this.maxItems&&n.shift()),this.dontCompose=!1,this.redoStack=[])},t.prototype.transform=function(t){this.undoStack=n(this.undoStack,t),this.redoStack=n(this.redoStack,t)},t.prototype.performUndo=function(t){if(this.state=r,0===this.undoStack.length)throw new Error("undo not possible");t(this.undoStack.pop()),this.state=e},t.prototype.performRedo=function(t){if(this.state=i,0===this.redoStack.length)throw new Error("redo not possible");t(this.redoStack.pop()),this.state=e},t.prototype.canUndo=function(){return 0!==this.undoStack.length},t.prototype.canRedo=function(){return 0!==this.redoStack.length},t.prototype.isUndoing=function(){return this.state===r},t.prototype.isRedoing=function(){return this.state===i},t}(),(P=P||{}).Client=function(){"use strict";function t(){this.state=n}function e(){}t.prototype.setState=function(t){this.state=t},t.prototype.applyClient=function(t){this.setState(this.state.applyClient(this,t))},t.prototype.applyServer=function(t){this.setState(this.state.applyServer(this,t))},t.prototype.serverAck=function(){this.setState(this.state.serverAck(this))},t.prototype.serverRetry=function(){this.setState(this.state.serverRetry(this))},t.prototype.sendOperation=function(t){throw new Error("sendOperation must be defined in child class")},t.prototype.applyOperation=function(t){throw new Error("applyOperation must be defined in child class")},(t.Synchronized=e).prototype.applyClient=function(t,e){return t.sendOperation(e),new r(e)},e.prototype.applyServer=function(t,e){return t.applyOperation(e),this},e.prototype.serverAck=function(t){throw new Error("There is no pending operation.")},e.prototype.serverRetry=function(t){throw new Error("There is no pending operation.")};var n=new e;function r(t){this.outstanding=t}function i(t,e){this.outstanding=t,this.buffer=e}return(t.AwaitingConfirm=r).prototype.applyClient=function(t,e){return new i(this.outstanding,e)},r.prototype.applyServer=function(t,e){e=this.outstanding.transform(e);return t.applyOperation(e[1]),new r(e[0])},r.prototype.serverAck=function(t){return n},r.prototype.serverRetry=function(t){return t.sendOperation(this.outstanding),this},(t.AwaitingWithBuffer=i).prototype.applyClient=function(t,e){e=this.buffer.compose(e);return new i(this.outstanding,e)},i.prototype.applyServer=function(t,e){var e=this.outstanding.transform(e),n=this.buffer.transform(e[1]);return t.applyOperation(n[1]),new i(e[0],n[0])},i.prototype.serverRetry=function(t){var e=this.outstanding.compose(this.buffer);return t.sendOperation(e),new r(e)},i.prototype.serverAck=function(t){return t.sendOperation(this.buffer),new r(this.buffer)},t}(),(P=P||{}).EditorClient=function(){"use strict";var t,s=P.Client,a=P.Cursor,n=P.UndoManager,i=P.WrappedOperation;function o(t,e){this.cursorBefore=t,this.cursorAfter=e}function r(t,e){this.id=t,this.editorAdapter=e}function e(t,e){s.call(this),this.serverAdapter=t,this.editorAdapter=e,this.undoManager=new n,this.clients={};var o=this;this.editorAdapter.registerCallbacks({change:function(t,e){o.onChange(t,e)},cursorActivity:function(){o.onCursorActivity()},blur:function(){o.onBlur()},focus:function(){o.onFocus()}}),this.editorAdapter.registerUndo(function(){o.undo()}),this.editorAdapter.registerRedo(function(){o.redo()}),this.serverAdapter.registerCallbacks({ack:function(){o.serverAck(),o.focused&&o.state instanceof s.Synchronized&&(o.updateCursor(),o.sendCursor(o.cursor)),o.emitStatus()},retry:function(){o.serverRetry()},operation:function(t){o.applyServer(t)},cursor:function(t,e,n,r,i){o.serverAdapter.deviceId_!==t&&o.state instanceof s.Synchronized&&(t=o.getClientObject(t),e&&t.setUserId(e),r&&t.setColor(r),i&&t.setName(i),n?t.updateCursor(a.fromJSON(n)):t.removeCursor())}})}function c(){}return o.prototype.invert=function(){return new o(this.cursorAfter,this.cursorBefore)},o.prototype.compose=function(t){return new o(this.cursorBefore,t.cursorAfter)},o.prototype.transform=function(t){return new o(this.cursorBefore?this.cursorBefore.transform(t):null,this.cursorAfter?this.cursorAfter.transform(t):null)},r.prototype.setUserId=function(t){this.userId=t},r.prototype.setColor=function(t){this.color=t},r.prototype.setName=function(t){this.name=t},r.prototype.updateCursor=function(t){this.removeCursor(),this.cursor=t,this.marks=this.editorAdapter.setOtherCursor(this.id,this.cursor,this.color,this.userId,this.name)},r.prototype.removeCursor=function(){if(this.marks)for(var t=0;t<this.marks.length;t++)this.marks[t].clear()},t=e,c.prototype=s.prototype,t.prototype=new c,t.prototype.constructor=t,e.prototype.getClientObject=function(t){var e=this.clients[t];return e||(this.clients[t]=new r(t,this.editorAdapter))},e.prototype.applyUnredo=function(t){this.undoManager.add(this.editorAdapter.invertOperation(t)),this.editorAdapter.applyOperation(t.wrapped),this.cursor=t.meta.cursorAfter,this.cursor&&this.editorAdapter.setCursor(this.cursor),this.applyClient(t.wrapped)},e.prototype.undo=function(){var e=this;this.undoManager.canUndo()&&this.undoManager.performUndo(function(t){e.applyUnredo(t)})},e.prototype.redo=function(){var e=this;this.undoManager.canRedo()&&this.undoManager.performRedo(function(t){e.applyUnredo(t)})},e.prototype.onChange=function(t,e){var n=this.cursor,r=(this.updateCursor(),0<this.undoManager.undoStack.length&&e.shouldBeComposedWithInverted((r=this.undoManager.undoStack)[r.length-1].wrapped)),n=new o(this.cursor,n);this.undoManager.add(new i(e,n),r),this.applyClient(t)},e.prototype.updateCursor=function(){this.cursor=this.editorAdapter.getCursor()},e.prototype.onCursorActivity=function(){var t=this.cursor;this.updateCursor(),!this.focused||t&&this.cursor.equals(t)||this.sendCursor(this.cursor)},e.prototype.onBlur=function(){this.cursor=null,this.sendCursor(null),this.focused=!1},e.prototype.onFocus=function(){this.focused=!0,this.onCursorActivity()},e.prototype.sendCursor=function(t){this.state instanceof s.AwaitingWithBuffer||this.serverAdapter.sendCursor(t)},e.prototype.sendOperation=function(t){this.serverAdapter.sendOperation(t),this.emitStatus()},e.prototype.applyOperation=function(t){this.editorAdapter.applyOperation(t),this.updateCursor(),this.undoManager.transform(new i(t,null))},e.prototype.emitStatus=function(){var t=this;setTimeout(function(){t.trigger("synced",t.state instanceof s.Synchronized)},0)},e}(),P.utils.makeEventEmitter(P.EditorClient,["synced"]),(P=P||{}).AttributeConstants={BOLD:"b",ITALIC:"i",UNDERLINE:"u",STRIKE:"s",FONT:"f",FONT_SIZE:"fs",COLOR:"c",BACKGROUND_COLOR:"bc",ENTITY_SENTINEL:"ent",ELEMENT:"e",ELEMENT_COLOR:"ec",THREAD:"t",DIFF:"d",LINE_SENTINEL:"l",LINE_INDENT:"li",LINE_ALIGN:"la",LIST_TYPE:"lt",LINE_CLASS:"lc",LINE_CLASS_TYPE:"lct",SCENE_CODE:"sc",SCENE_ID:"si",SCENE_OMITTED:"so"},P.sentinelConstants={LINE_SENTINEL_CHARACTER:"",ENTITY_SENTINEL_CHARACTER:"",TRIGGER_AUTOFORMAT_SENTINEL_CHARACTER:""},(P=P||{}).EntityManager=(B=P.utils,a.prototype.register=function(t,e){P.utils.assert(e.render,"Entity options should include a 'render' function!"),P.utils.assert(e.fromElement,"Entity options should include a 'fromElement' function!"),this.entities_[t]=e},a.prototype.renderToElement=function(t,e){return this.tryRenderToElement_(t,"render",e)},a.prototype.exportToElement=function(t){var e=this.tryRenderToElement_(t,"export")||this.tryRenderToElement_(t,"getHtml")||this.tryRenderToElement_(t,"render");return e.setAttribute("data-firepad-entity",t.type),e},a.prototype.updateElement=function(t,e){var n=t.type,t=t.info;this.entities_[n]&&void 0!==this.entities_[n].update&&this.entities_[n].update(t,e)},a.prototype.fromElement=function(t){var e=t.getAttribute("data-firepad-entity");if((e=e||t.nodeName.toLowerCase())&&this.entities_[e])return t=this.entities_[e].fromElement(t),new P.Entity(e,t)},a.prototype.tryRenderToElement_=function(t,e,n){var r=t.type,t=t.info;if(this.entities_[r]&&this.entities_[r][e]){var i=P.document||window&&window.document,e=this.entities_[r][e](t,n,i);if(e)return"string"==typeof e?((t=(P.document||document).createElement("div")).innerHTML=e,t.childNodes[0]):"object"==typeof e?(P.utils.assert(void 0!==e.nodeType,"Error rendering "+r+" entity.  render() function must return an html string or a DOM element."),e):void 0}},a.prototype.entitySupportsUpdate=function(t){return this.entities_[t]&&this.entities_[t].update},a),(P=P||{}).Entity=(U=P.AttributeConstants.ENTITY_SENTINEL,W=U+"_",G.prototype.toAttributes=function(){var t,e={};for(t in e[U]=this.type,this.info)e[W+t]=this.info[t];return e},G.fromAttributes=function(t){var e,n=t[U],r={};for(e in t)0===e.indexOf(W)&&(r[e.substr(W.length)]=t[e]);return new G(n,r)},G);var Z,b,c,O,F,f,X,g,Q,tt,y,m,et,nt,rt,it,R,D,ot,v,st,_,at,E,ct,lt,ht,pt,dt,C,P=P||{};if("undefined"==typeof CodeMirror&&"function"==typeof require)try{CodeMirror=require("codemirror")}catch(t){console.log("CodeMirror not found")}function L(t,e,n,r){this.ready_=!1,this.codeMirror=t,this.options_=r||{},this.entityManager_=e,this.firebaseAdapter_=n,this.currentAttributes_=null,this.styleElements=[],this.shootingEvent=this.options_.shootingEvent||null,this.scenesFilterElements=[],this.showComments=this.options_.showComments||!1,this.showDiffAdditions=this.options_.showDiffAdditions||!1,this.setupDynamicStyles(),this.setupAnnotations(),_t(this,"onCodeMirrorBeforeChange_"),_t(this,"onCodeMirrorChange_"),_t(this,"onCursorActivity_"),_t(this,"onCopyOrCut_"),_t(this,"onPaste_"),_t(this,"onScroll_"),4<=parseInt(CodeMirror.version)?this.codeMirror.on("changes",this.onCodeMirrorChange_):this.codeMirror.on("change",this.onCodeMirrorChange_),this.codeMirror.on("beforeChange",this.onCodeMirrorBeforeChange_),this.codeMirror.on("cursorActivity",this.onCursorActivity_),this.codeMirror.on("copy",this.onCopyOrCut_),this.codeMirror.on("cut",this.onCopyOrCut_),this.codeMirror.on("paste",this.onPaste_),this.codeMirror.on("scroll",this.onScroll_),this.changeId_=0,this.outstandingChanges_={},this.dirtyLines_=[];var i=this;setTimeout(function(){i.reportScenesStatus()},1e3)}function ut(t){this.attributes=t||{}}function ft(t){var e=parseInt(t);if(isNaN(e)){for(var n="",r=!1,i=0;i<t.length-1&&!r;){var o=t.substring(i,i+1);"Z"!==o?(n+=String.fromCharCode(1+o.charCodeAt(0)),r=!0):n+="A",i++}return r||(n+="A"),n+=t.substring(i)}return(e+1).toString()}function z(t){return t.replace(new RegExp("["+g+Q+"]","g"),"")}function gt(t,e){return t.line-e.line||t.ch-e.ch}function yt(t,e){return gt(t,e)<=0}function mt(t){if(0===t.length)return 0;for(var e=0,n=0;n<t.length;n++)e+=t[n].length;return e+t.length-1}function _t(t,e){var n=t[e];t[e]=function(){n.apply(t,arguments)}}function x(t){if(!(this instanceof x))return new x(t);this.attributes=t||{}}function T(t){if(!(this instanceof T))return new T(t);this.attributes=t||{},this.attributes[m.LINE_SENTINEL]=!0}function S(t,e,n){this.listType=t||nt.UNORDERED,this.lineFormatting=e||P.LineFormatting(),this.textFormatting=n||P.Formatting()}function bt(){this.lines=[],this.currentLine=[],this.currentLineListItemType=null}function vt(t,e,n){if(t.nodeType===rt.ELEMENT_NODE){var r=et.fromElement(t);if(r)return void n.currentLine.push(new P.Text(P.sentinelConstants.ENTITY_SENTINEL_CHARACTER,new P.Formatting(r.toAttributes())))}switch(t.nodeType){case rt.TEXT_NODE:var i=t.nodeValue.replace(/[ \n\t]+/g," ");n.currentLine.push(P.Text(i,e.textFormatting));break;case rt.ELEMENT_NODE:e=function(t,e){for(var n=t.textFormatting,r=t.lineFormatting,i=e.split(";"),o=0;o<i.length;o++){var s=i[o].split(":");if(2===s.length){var a=P.utils.trim(s[0]).toLowerCase(),c=P.utils.trim(s[1]).toLowerCase();switch(a){case"text-decoration":var l=0<=c.indexOf("underline"),h=0<=c.indexOf("line-through");n=n.underline(l).strike(h);break;case"font-weight":l="bold"===c||600<=parseInt(c);n=n.bold(l);break;case"font-style":h="italic"===c||"oblique"===c;n=n.italic(h);break;case"color":n=n.color(c);break;case"background-color":n=n.backgroundColor(c);break;case"text-align":r=r.align(c);break;case"font-size":var p=null;P.utils.stringEndsWith(c,["px","pt","%","em","xx-small","x-small","small","medium","large","x-large","xx-large","smaller","larger"])?p=c:parseInt(c)&&(p=parseInt(c)+"px"),p&&(n=n.fontSize(p));break;case"font-family":p=P.utils.trim(c.split(",")[0]);p=(p=p.replace(/['"]/g,"")).replace(/\w\S*/g,function(t){return t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()}),n=n.font(p)}}}return t.withLineFormatting(r).withTextFormatting(n)}(e,t.getAttribute("style")||"");i=t.getAttribute("class")||"",i=(i&&e.lineFormatting.setClass(i),t.getAttribute("class-type")||"");switch(i&&e.lineFormatting.setClassType(i),t.nodeName.toLowerCase()){case"div":case"h1":case"h2":case"h3":case"p":n.newlineIfNonEmpty(e),A(t,e,n),n.newlineIfNonEmpty(e);break;case"center":e=e.withAlign("center"),n.newlineIfNonEmpty(e),A(t,e.withAlign("center"),n),n.newlineIfNonEmpty(e);break;case"b":case"strong":A(t,e.withTextFormatting(e.textFormatting.bold(!0)),n);break;case"u":A(t,e.withTextFormatting(e.textFormatting.underline(!0)),n);break;case"i":case"em":A(t,e.withTextFormatting(e.textFormatting.italic(!0)),n);break;case"s":A(t,e.withTextFormatting(e.textFormatting.strike(!0)),n);break;case"font":var o=t.getAttribute("face"),s=t.getAttribute("color"),a=parseInt(t.getAttribute("size"));o&&(e=e.withTextFormatting(e.textFormatting.font(o))),s&&(e=e.withTextFormatting(e.textFormatting.color(s))),A(t,e=a?e.withTextFormatting(e.textFormatting.fontSize(a)):e,n);break;case"br":n.newline(e);break;case"ul":n.newlineIfNonEmptyOrListItem(e);o="firepad-todo"===t.getAttribute("class")?nt.TODO:nt.UNORDERED;A(t,e.withListType(o).withIncreasedIndent(),n),n.newlineIfNonEmpty(e);break;case"ol":n.newlineIfNonEmptyOrListItem(e),A(t,e.withListType(nt.ORDERED).withIncreasedIndent(),n),n.newlineIfNonEmpty(e);break;case"li":s=t,a=e,(o=n).newlineIfNonEmptyOrListItem(a),c="firepad-checked"===s.getAttribute("class")?nt.TODOCHECKED:a.listType,o.makeListItem(c),c=o.currentLine,A(s,a,o),(c===o.currentLine||0<o.currentLine.length)&&o.newline(a);break;case"style":break;default:A(t,e,n)}}var c}function A(t,e,n){if(t.hasChildNodes())for(var r=0;r<t.childNodes.length;r++)vt(t.childNodes[r],e,n)}function Et(t){return t===D.ORDERED?"</ol>":"</ul>"}function M(t){if(!(this instanceof M))return new M(t);var e="string"==typeof t?(e=void 0===global.firebase&&"object"!=typeof e?(console.log("REQUIRING"),require("firebase")):global.firebase).database().refFromURL(t):t,n=(this.deviceId_="backend",this.ready_=!1,this.zombie_=!1,this.entityManager_=new ht,this.firebaseAdapter_=new lt(e,this.deviceId_),this);n.firebaseAdapter_.on("ready",function(){n.ready_=!0})}"undefined"!=typeof CodeMirror&&(CodeMirror.TextMarker.prototype.getClassName=function(){return this.className||""}),P.RichTextCodeMirror=(Z=P.AnnotationList,b=P.Span,c=P.utils,O=P.AttributeConstants,F="cmrt-",f={},X={},g=P.sentinelConstants.LINE_SENTINEL_CHARACTER,Q=P.sentinelConstants.ENTITY_SENTINEL_CHARACTER,tt=P.sentinelConstants.TRIGGER_AUTOFORMAT_SENTINEL_CHARACTER,c.makeEventEmitter(L,["change","attributesChange","newLine"]),L.prototype.setReady=function(){var t=this,e=t.codeMirror,n=e.getLine(0);n&&0<n.length&&n[0]===tt&&(e.replaceRange("",{line:0,ch:0},{line:0,ch:1},"+input"),setTimeout(function(){t.screenplayAutoFormat(!0)},100)),t.ready_=!0,setTimeout(function(){t.reportVisibleThreads()},0)},L.prototype.detach=function(){this.onScenesChangeCallback&&(this.onScenesChangeCallback=null),this.codeMirror.off("beforeChange",this.onCodeMirrorBeforeChange_),this.codeMirror.off("change",this.onCodeMirrorChange_),this.codeMirror.off("changes",this.onCodeMirrorChange_),this.codeMirror.off("cursorActivity",this.onCursorActivity_),this.codeMirror.off("copy",this.onCopyOrCut_),this.codeMirror.off("cut",this.onCopyOrCut_),this.codeMirror.off("paste",this.onPaste_),this.codeMirror.off("scroll",this.onScroll_),this.clearAnnotations(),this.clearDynamicStyles(),this.clearScenesFilterElements()},L.prototype.clearAnnotations=function(){this.annotationList_.updateSpan(new b(0,this.end()),function(t,e){return new ut({})})},L.prototype.setupAnnotations=function(){var n=this;this.annotationList_=new Z(function(t,e){n.onAnnotationsChanged_(t,e)}),this.initAnnotationList_()},L.prototype.clearDynamicStyles=function(){for(var t=0;t<this.styleElements.length;t++){var e=this.styleElements[t];e.parentNode.removeChild(e)}this.styleElements=[],f={},X={}},L.prototype.setupDynamicStyles=function(){f[O.COLOR]="color",f[O.BACKGROUND_COLOR]="background-color",f[O.FONT_SIZE]="font-size",f[O.LINE_INDENT]=function(t){return"padding-left: "+40*t+"px"},f[O.SCENE_CODE]=function(t){return'margin-left: 0; position: absolute; left: -60px; content: "'+t+'";'};var e=this.shootingEvent,n={};if(e){try{for(var t=0;t<e.scenes.length;t++)n[e.scenes[t].sceneId]=e.scenes[t].sceneType}catch(t){console.log("Firepad: invalid scenes array for the given shooting event")}var r=O.ELEMENT_COLOR+"-"+this.shootingEvent.id;f[r]=function(t){return"color: "+t+"; text-decoration: underline; font-weight: bold;"},this.showDiffAdditions&&(f[O.DIFF]=function(t){if("added"===t)return"background-color: #CAFA94;"})}else this.showComments&&(f[O.THREAD]=function(){return"background-color: #e3e3e3; position: relative;"});f[O.SCENE_ID]=function(t){return e?n[t]&&"PRIMARY"===n[t]?"font-family: 'firepad'; speak: none; font-style: normal; font-weight: normal; font-variant: normal; text-transform: none; line-height: 1; -webkit-font-smoothing: antialiased; content: \"\\e00c\"; margin-left: 0; position: absolute; right: -20px;":"font-family: 'verdana'; speak: none; font-style: normal; font-weight: normal; font-variant: normal; text-transform: none; line-height: 1; -webkit-font-smoothing: antialiased; content: \"||\"; margin-left: 0; position: absolute; right: -20px;":"font-family: 'firepad'; speak: none; font-style: normal; font-weight: normal; font-variant: normal; text-transform: none; line-height: 1; -webkit-font-smoothing: antialiased; content: \"\\e98f\"; margin-left: 0; position: absolute; right: -20px;"}},L.prototype.setShootingEvent=function(t){this.shootingEvent=t,this.options_.shootingEvent=t,this.clearDynamicStyles(),this.setupDynamicStyles(),this.clearScenesFilterElements(),this.filterScenes();for(var e=this.getAttributeSpans(0,this.end()),n=0;n<e.length;n++){var r=e[n].attributes;this.getClassNameForAttributes_(r)}},L.prototype.toggleAttribute=function(t,e){var n,e=e||!0;this.emptySelection_()?((n=this.getCurrentAttributes_())[t]===e?delete n[t]:n[t]=e,this.currentAttributes_=n):(n=this.getCurrentAttributes_()[t]!==e&&e,this.setAttribute(t,n))},L.prototype.setAttribute=function(e,n){var t,r=this.codeMirror;this.emptySelection_()?(t=this.getCurrentAttributes_(),!1===n?delete t[e]:t[e]=n,this.currentAttributes_=t):(this.updateTextAttributes(r.indexFromPos(r.getCursor("start")),r.indexFromPos(r.getCursor("end")),function(t){!1===n?delete t[e]:t[e]=n}),this.updateCurrentAttributes_())},L.prototype.updateTextAttributes=function(t,e,s,a,c){var l=[],h=t,p=this;this.annotationList_.updateSpan(new b(t,e-t),function(t,e){var n,r={};for(n in t.attributes)r[n]=t.attributes[n];r[O.LINE_SENTINEL]&&!c||s(r);var i={},o={};return p.computeChangedAttributes_(t.attributes,r,i,o),function(t){for(var e in t)return;return 1}(i)||l.push({start:h,end:h+e,attributes:i,attributesInverse:o,origin:a}),h+=e,new ut(r)}),0<l.length&&this.trigger("attributesChange",this,l)},L.prototype.computeChangedAttributes_=function(t,e,n,r){var i,o={};for(i in t)o[i]=!0;for(i in e)o[i]=!0;for(i in o)i in e?i in t?t[i]!==e[i]&&(n[i]=e[i],r[i]=t[i]):(n[i]=e[i],r[i]=!1):(n[i]=!1,r[i]=t[i])},L.prototype.scrollToLine=function(e,t){var n=this;n.codeMirror.setCursor({line:e+(t?1:0),ch:1}),setTimeout(function(){var t=n.codeMirror.charCoords({line:e,ch:0},"local").top;n.codeMirror.scrollTo(null,t)},100)},L.prototype.scrollToScene=function(e){var t=this.getScenes().find(function(t){return t.sceneCode===e});t&&(this.codeMirror.focus(),this.scrollToLine(t.lineNum,!0))},L.prototype.screenplayAutoFormat=function(S,A,M,w){var N=this,I=N.codeMirror.getCursor("head").line;setTimeout(function(){var t=[],e=[],n=N.codeMirror.firstLine(),r=N.codeMirror.lastLine(),i=I-1;if(!S){var o=!1,s=!1,a=!1,c=n,l=r;for("number"==typeof M?c=M:n<i&&(c=i-1),"number"==typeof w?l=w:i<r&&(l=1+i);!o;)s||(n<c&&(d=N.getLineAttributes_(c))[O.LINE_CLASS]&&"pc-action"!==d[O.LINE_CLASS]?c--:s=!0),a||(l<r&&(d=N.getLineAttributes_(l))[O.LINE_CLASS]&&"pc-action"!==d[O.LINE_CLASS]?l++:a=!0),o=s&&a;n=c,r=l}for(var h=n;h<=r;h++){var p,d,u,f,g,y,m,_,b=N.codeMirror.getLine(h);b&&(p=b=z(b).trim(),d=N.getLineAttributes_(h),u=p.match(k.scene_heading),f=p.match(k.character),g=p.match(k.parenthetical),_=m=!1,h<r&&(m=(y=z(N.codeMirror.getLine(h+1))).match(k.character),_=y.match(k.parenthetical)),(u||!f&&!g&&!_||f&&m)&&(p+="\n"),t.push({line:h,text:p}),d[O.SCENE_ID]||""===b||d[O.LINE_CLASS]&&"auto"!==d[O.LINE_CLASS_TYPE]||e.push(h))}for(var v=j.parse(t,{tokens:!0}),h=0;h<e.length;h++){var E,C,L,x=e[h],T=v.tokens[x];T&&(L=null,E="auto","scene_heading"===T.type&&(L="pc-scene"),"transition"===T.type&&(L="pc-transition"),"parenthetical"===T.type&&(L="pc-parenthetical"),"dialogue"===T.type&&(L="pc-dialogue"),"action"===T.type&&(L="pc-action"),"character"===T.type&&(L="pc-character",E="user"),"centered"===T.type&&(L="pc-centered",T.text&&(C=N.codeMirror.getLine(x),N.codeMirror.replaceRange(T.text.trim(),{line:x,ch:0},{line:x,ch:C.length},F),E="user")),L&&N.updateLineAttributes(x,x,function(t){t[O.LINE_CLASS]=L,t[O.LINE_CLASS_TYPE]=E,delete t[O.SCENE_CODE]}))}S||"newline"!==A||((i=N.getLineAttributes_(i))[O.LINE_CLASS]&&("pc-character"===i[O.LINE_CLASS]?N.updateLineAttributes(I,I,function(t){t[O.LINE_CLASS]="pc-dialogue",t[O.LINE_CLASS_TYPE]="auto"}):"pc-parenthetical"===i[O.LINE_CLASS]?N.updateLineAttributes(I,I,function(t){t[O.LINE_CLASS]="pc-dialogue",t[O.LINE_CLASS_TYPE]="user"}):"pc-dialogue"===i[O.LINE_CLASS]?N.updateLineAttributes(I,I,function(t){t[O.LINE_CLASS]="pc-character",t[O.LINE_CLASS_TYPE]="user"}):N.updateLineAttributes(I,I,function(t){t[O.LINE_CLASS]="pc-action",t[O.LINE_CLASS_TYPE]="auto"})),N.onCursorActivity_())},0)},L.prototype.lockScene=function(t,e){if(e&&"function"==typeof t)for(var n=this,r=n.codeMirror.firstLine(),i=n.codeMirror.lastLine(),o=r;o<=i;o++){var s,a=n.getLineAttributes_(o);if("pc-scene"===a[O.LINE_CLASS]&&a[O.SCENE_CODE]===e&&!a[O.SCENE_ID])return""===z(n.codeMirror.getLine(o)).trim()?"Invalid scene title":(s=t(),n.updateLineAttributes(o,o,function(t){t[O.SCENE_ID]=s}),null)}},L.prototype.lockScenes=function(t,e){if("function"==typeof t){var n=this,r=n.codeMirror.firstLine(),i=n.codeMirror.lastLine(),o=[];n.recodeScenes();for(var s=r;s<=i;s++){var a,c,l=n.getLineAttributes_(s);"pc-scene"!==l[O.LINE_CLASS]||!(a=l[O.SCENE_CODE])||l[O.SCENE_ID]||e&&e.length&&!e.includes(a)||(""!==z(n.codeMirror.getLine(s)).trim()?(c=t(),n.updateLineAttributes(s,s,function(t){t[O.SCENE_ID]=c})):o.push({sceneCode:a,error:"Invalid scene title"}))}return o}},L.prototype.deleteScene=function(t){for(var e=this,n=e.codeMirror.firstLine(),r=e.codeMirror.lastLine(),i=!1,o=!1,s=null,a=null,c={title:"",attributes:{},content:[]},l=n;l<=r;l++){var h,p,d=e.getLineAttributes_(l),u=e.codeMirror.getLine(l);if("pc-scene"===d[O.LINE_CLASS]&&d[O.SCENE_CODE]){if(i)break;d[O.SCENE_CODE]!==t||d[O.SCENE_OMITTED]||(i=!0,c.title=u,(c.attributes=d)[O.SCENE_ID]?(o=!0,e.updateLineAttributes(l,l,function(t){t[O.SCENE_OMITTED]=!0}),p=u.length,u[h=0]===g&&h++,e.codeMirror.replaceRange("OMIT",{line:l,ch:h},{line:l,ch:p},F)):a=s=l)}else i&&(c.content.push({text:u,attributes:d}),null===s&&(s=l),a=l)}i&&(o&&e.firebaseAdapter_.saveOmittedScene(t,c),e.codeMirror.replaceRange("",{line:s,ch:0},{line:a+1,ch:0},F))},L.prototype.restoreScene=function(a){for(var c=this,t=c.codeMirror.firstLine(),e=c.codeMirror.lastLine(),l=t;l<=e;l++){var n=c.getLineAttributes_(l),h=c.codeMirror.getLine(l);if("pc-scene"===n[O.LINE_CLASS]&&n[O.SCENE_CODE]===a&&n[O.SCENE_OMITTED])return void c.firebaseAdapter_.getOmittedScene(a,function(n){if(n){for(var t=h.length,e=(c.codeMirror.replaceRange(n.title,{line:l,ch:0},{line:l,ch:t},F),c.updateLineAttributes(l,l,function(t){for(var e in n.attributes)n.attributes.hasOwnProperty(e)&&(t[e]=n.attributes[e]);delete t[O.SCENE_OMITTED]}),!0),r=0;r<n.content.length;r++){var i,o=l+r+1,s=null;e&&(0!==(i=c.codeMirror.getLine(o)).length&&!c.areLineSentinelCharacters_(i)||(s={line:o+1,ch:0}),e=!1),c.codeMirror.replaceRange(n.content[r].text+"\n",{line:o,ch:0},s,F),c.updateLineAttributes(o,o,function(t){for(var e in n.content[r].attributes)n.content[r].attributes.hasOwnProperty(e)&&(t[e]=n.content[r].attributes[e])})}c.firebaseAdapter_.deleteOmittedScene(a)}else console.log("Firepad: could not get omitted scene from firebase")})}},L.prototype.recodeScenes=function(){for(var t=this,e=t.codeMirror.firstLine(),n=t.codeMirror.lastLine(),r=[],i=!1,o=e;o<=n;o++){var s,a,c,l=t.getLineAttributes_(o);"pc-scene"===l[O.LINE_CLASS]&&(s=l[O.SCENE_ID],a="",c=z(c=t.codeMirror.getLine(o)).trim(),s&&(i=!0,a=l[O.SCENE_CODE]),(s||c)&&r.push({lineNum:o,sceneId:s,sceneCode:a,sceneTitle:c}))}for(var h="0",o=0;o<r.length;o++){if(""===r[o].sceneCode){var p="";if(i)for(var d=ft(h),u=!1;!u;){for(var f=!1,g=0;!f&&g<r.length;)r[g].sceneCode===d?f=!0:g++;f?g<=o?d=ft(d):h=d=function(t){var e=parseInt(t);if(isNaN(e)){for(var n="",r=0;r<t.length-1;)n+="A",r++;return n+="A"+t.substring(r)}return"A"+t}(h):(p=d,u=!0)}else p=(o+1).toString();r[o].sceneCode=p,t.updateLineAttributes(r[o].lineNum,r[o].lineNum,function(t){t[O.SCENE_CODE]=p})}h=r[o].sceneCode}},L.prototype.anchorThread=function(t){if(this.emptySelection_())return"threads must be anchored to a text selection";if(this.getCurrentAttributes_()[O.THREAD])return"the selected text is already attached to another thread";for(var e=this.annotationList_.getAllAnnotations(),n=0;n<e.length;n++)if(e[n].attributes[O.THREAD]===t)return"thread already anchored to the sceenplay";this.setAttribute(O.THREAD,t),this.onCursorActivity_();var r=this;setTimeout(function(){r.reportVisibleThreads()},0)},L.prototype.deleteThread=function(c){var l=this;setTimeout(function(){for(var t=l.codeMirror.firstLine(),e=l.codeMirror.lastLine(),n=[],r=t;r<=e;r++)for(var i=l.codeMirror.getLine(r),o=0;o<i.length;o++){var s=l.codeMirror.indexFromPos({line:r,ch:o}),a=l.annotationList_.getAnnotatedSpansForSpan(new b(s,1));0<a.length&&a[0].annotation.attributes[O.THREAD]===c&&n.push(s)}for(r=0;r<n.length;r++)l.updateTextAttributes(n[r],n[r]+1,function(t){delete t[O.THREAD]});l.reportVisibleThreads()},0)},L.prototype.scrollToThread=function(s){var a=this;setTimeout(function(){for(var t=a.codeMirror.firstLine(),e=a.codeMirror.lastLine(),n=t;n<=e;n++)for(var r=a.codeMirror.getLine(n),i=0;i<r.length;i++){var o=a.codeMirror.indexFromPos({line:n,ch:i}),o=a.annotationList_.getAnnotatedSpansForSpan(new b(o,1));if(0<o.length&&o[0].annotation.attributes[O.THREAD]===s)return a.codeMirror.focus(),void a.scrollToLine(n,!0)}},0)},L.prototype.setSelectedThread=function(l){this.clearSelectedThread();var h=this;setTimeout(function(){for(var t=h.codeMirror.firstLine(),e=h.codeMirror.lastLine(),n=t,r=!1,i={},o=!1;!r&&n<=e;){for(var s=h.codeMirror.getLine(n),a=0;!r&&a<s.length;){var c=h.codeMirror.indexFromPos({line:n,ch:a}),c=h.annotationList_.getAnnotatedSpansForSpan(new b(c,1));0<c.length&&c[0].annotation.attributes[O.THREAD]===l?o||(i.from={line:n,ch:a},o=!0):o&&(i.to={line:n,ch:a},r=!0),a++}n++}h.codeMirror.markText(i.from,i.to,{className:"firepad-thread-selected"})},0)},L.prototype.clearSelectedThread=function(){var t=this;setTimeout(function(){t.codeMirror.getAllMarks().forEach(function(t){"firepad-thread-selected"===t.className&&t.clear()})},0)},L.prototype.getAddedDiffScenes=function(p){var d=this;setTimeout(function(){for(var t={},e=d.codeMirror.firstLine(),n=d.codeMirror.lastLine(),r=null,i=e;i<=n;i++){var o=d.getLineAttributes_(i);if((r="pc-scene"===o[O.LINE_CLASS]?o[O.SCENE_ID]:r)&&!t[r])for(var s=d.codeMirror.getLine(i),a=0;a<s.length;a++){var c=d.codeMirror.indexFromPos({line:i,ch:a}),c=d.annotationList_.getAnnotatedSpansForSpan(new b(c,1));if(0<c.length&&c[0].annotation.attributes[O.DIFF]){t[r]=!0;break}}}var l,h=[];for(l in t)t.hasOwnProperty(l)&&h.push(l);p(h)},0)},L.prototype.getAddedDiffLines=function(p){var d=this;if(!d.shootingEvent)return p([]);setTimeout(function(){for(var t=[],e=d.shootingEvent.scenes||[],n=d.codeMirror.firstLine(),r=d.codeMirror.lastLine(),i=!1,o=n;o<=r;o++){var s=d.getLineAttributes_(o);if("pc-scene"===s[O.LINE_CLASS])for(var a=s[O.SCENE_ID],c=0,i=!1;c<e.length&&!i;)e[c].sceneId===a&&(i=!0),c++;if(i)for(var l=d.codeMirror.getLine(o),c=0;c<l.length;c++){var h=d.codeMirror.indexFromPos({line:o,ch:c}),h=d.annotationList_.getAnnotatedSpansForSpan(new b(h,1));if(0<h.length&&h[0].annotation.attributes[O.DIFF]){t.push(o);break}}}p(t)},0)},L.prototype.deleteAddedDiffs=function(d){var u=this;if(!u.shootingEvent)return d();setTimeout(function(){for(var t=[],e=u.shootingEvent.scenes||[],n=u.codeMirror.firstLine(),r=u.codeMirror.lastLine(),i=!1,o=n;o<=r;o++){var s=u.getLineAttributes_(o);if("pc-scene"===s[O.LINE_CLASS])for(var a=s[O.SCENE_ID],c=0,i=!1;c<e.length&&!i;)e[c].sceneId===a&&(i=!0),c++;if(i)for(var l=u.codeMirror.getLine(o),c=0;c<l.length;c++){var h=u.codeMirror.indexFromPos({line:o,ch:c}),p=u.annotationList_.getAnnotatedSpansForSpan(new b(h,1));0<p.length&&p[0].annotation.attributes[O.DIFF]&&t.push(h)}}for(o=0;o<t.length;o++)u.updateTextAttributes(t[o],t[o]+1,function(t){delete t[O.DIFF]});d()},0)},L.prototype.toggleElement=function(t,e){if(this.shootingEvent&&""===this.shootingEvent.id)console.log("no shootingEvent option found");else{for(var n,r,i,o,s=this.codeMirror.getCursor("head").line,a=this.codeMirror.firstLine(),c=null;a<=s&&!c;){var l=this.getLineAttributes_(s);"pc-scene"===l[O.LINE_CLASS]&&(c=l[O.SCENE_ID]),s--}if(c)return n=this.getCurrentAttributes_(),r=O.ELEMENT+"-"+this.shootingEvent.id,i=O.ELEMENT_COLOR+"-"+this.shootingEvent.id,o=!0,n[r]===t?(this.emptySelection_()&&this.selectElement(t),this.setAttribute(r,!1),this.setAttribute(i,!1),o=!1):(this.emptySelection_()&&this.selectWord(),this.setAttribute(r,t),this.setAttribute(i,e)),this.onCursorActivity_(),{sceneId:c,elementAdded:o};console.log("Firepad: cursor not inside a scene")}return null},L.prototype.deleteElements=function(c){var l,h,p=this;this.shootingEvent&&""===this.shootingEvent.id?console.log("no shootingEvent option found"):(l=O.ELEMENT+"-"+this.shootingEvent.id,h=O.ELEMENT_COLOR+"-"+this.shootingEvent.id,setTimeout(function(){for(var t=p.codeMirror.firstLine(),e=p.codeMirror.lastLine(),n=[],r=t;r<=e;r++)for(var i=p.codeMirror.getLine(r),o=0;o<i.length;o++){var s=p.codeMirror.indexFromPos({line:r,ch:o}),a=p.annotationList_.getAnnotatedSpansForSpan(new b(s,1));0<a.length&&(!c&&a[0].annotation.attributes[l]||a[0].annotation.attributes[l]===c)&&n.push(s)}for(r=0;r<n.length;r++)p.updateTextAttributes(n[r],n[r]+1,function(t){delete t[l],delete t[h]})},0))},L.prototype.getElements=function(){var t={};if(this.shootingEvent&&""===this.shootingEvent.id)console.log("no shootingEvent option found");else for(var e=O.ELEMENT+"-"+this.shootingEvent.id,n=this.annotationList_.getAllAnnotations(),r=0;r<n.length;r++){var i=n[r].attributes[e];i&&(t[i]=!0)}return t},L.prototype.toggleLineAttribute=function(t,e){var n=this.getCurrentLineAttributes_(),n=!(t in n&&n[t]===e)&&e;this.setLineAttribute(t,n)},L.prototype.setLineAttribute=function(e,n){this.updateLineAttributesForSelection(function(t){!1===n?delete t[e]:t[e]=n})},L.prototype.updateLineAttributesForSelection=function(t){var e=this.codeMirror,n=e.getCursor("start"),r=e.getCursor("end"),n=n.line,i=r.line,e=e.getLine(i),e=this.areLineSentinelCharacters_(e.substr(0,r.ch));n<i&&e&&i--,this.updateLineAttributes(n,i,t)},L.prototype.updateLineAttributes=function(t,e,n){for(var r=t;r<=e;r++){var i=this.codeMirror.getLine(r),o=this.codeMirror.indexFromPos({line:r,ch:0});i[0]!==g?((i={})[O.LINE_SENTINEL]=!0,n(i),this.insertText(o,g,i)):this.updateTextAttributes(o,o+1,n,null,!0)}},L.prototype.replaceText=function(t,e,n,r,i){this.changeId_++;var o=F+this.changeId_,i=(this.outstandingChanges_[o]={origOrigin:i,attributes:r},this.codeMirror),r=i.posFromIndex(t),t="number"==typeof e?i.posFromIndex(e):null;i.replaceRange(n,r,t,o)},L.prototype.insertText=function(t,e,n,r){var i=this.codeMirror,o=i.getCursor(),s="RTCMADAPTER"==r&&!i.somethingSelected()&&t==i.indexFromPos(o);this.replaceText(t,null,e,n,r),s&&i.setCursor(o)},L.prototype.removeText=function(t,e,n){var r=this.codeMirror;r.replaceRange("",r.posFromIndex(t),r.posFromIndex(e),n)},L.prototype.insertEntityAtCursor=function(t,e,n){var r=this.codeMirror,r=r.indexFromPos(r.getCursor("head"));this.insertEntityAt(r,t,e,n)},L.prototype.insertEntityAt=function(t,e,n,r){this.codeMirror;this.insertEntity_(t,new P.Entity(e,n),r)},L.prototype.insertEntity_=function(t,e,n){this.replaceText(t,null,Q,e.toAttributes(),n)},L.prototype.getAttributeSpans=function(t,e){for(var n=[],r=this.annotationList_.getAnnotatedSpansForSpan(new b(t,e-t)),i=0;i<r.length;i++)n.push({length:r[i].length,attributes:r[i].annotation.attributes});return n},L.prototype.end=function(){var t=this.codeMirror.lineCount()-1;return this.codeMirror.indexFromPos({line:t,ch:this.codeMirror.getLine(t).length})},L.prototype.getRange=function(t,e){t=this.codeMirror.posFromIndex(t),e=this.codeMirror.posFromIndex(e);return this.codeMirror.getRange(t,e)},L.prototype.initAnnotationList_=function(){var t=this.end();0!==t&&this.annotationList_.insertAnnotatedSpan(new b(0,t),new ut)},L.prototype.onAnnotationsChanged_=function(t,e){var n={};this.tryToUpdateEntitiesInPlace(t,e);for(var r,i=0;i<t.length;i++){var o=t[i].annotation.attributes;O.LINE_SENTINEL in o&&(n[this.codeMirror.posFromIndex(t[i].pos).line]=!0),(s=t[i].getAttachedObject())&&s.clear()}for(i=0;i<e.length;i++){var s,o=e[i].annotation.attributes,a=O.LINE_SENTINEL in o,c=O.ENTITY_SENTINEL in o,l=this.codeMirror.posFromIndex(e[i].pos);a?n[l.line]=!0:c?this.markEntity_(e[i]):""!==(a=this.getClassNameForAttributes_(o))&&(c=this.codeMirror.posFromIndex(e[i].pos+e[i].length),s=this.codeMirror.markText(l,c,{className:a}),e[i].attachObject(s))}for(r in n)this.dirtyLines_.push(this.codeMirror.getLineHandle(Number(r))),this.queueLineMarking_()},L.prototype.tryToUpdateEntitiesInPlace=function(t,e){for(var n=t.length;n--;)for(var r=t[n],i=e.length;i--;){var o,s=e[i];r.pos==s.pos&&r.length==s.length&&r.annotation.attributes.ent&&r.annotation.attributes.ent==s.annotation.attributes.ent&&(o=s.annotation.attributes.ent,this.entityManager_.entitySupportsUpdate(o)&&(t.splice(n,1),e.splice(i,1),(o=r.getAttachedObject()).update(s.annotation.attributes),s.attachObject(o)))}},L.prototype.queueLineMarking_=function(){var o;null==this.lineMarkTimeout_&&((o=this).lineMarkTimeout_=setTimeout(function(){o.lineMarkTimeout_=null;for(var t=[],e=0;e<o.dirtyLines_.length;e++){var n=o.codeMirror.getLineNumber(o.dirtyLines_[e]);t.push(Number(n))}o.dirtyLines_=[],t.sort(function(t,e){return t-e});for(var r=-1,e=0;e<t.length;e++){var i=t[e];r<i&&(r=o.markLineSentinelCharactersForChangedLines_(i,i))}},0))},L.prototype.addStyleWithCSS_=function(t){var e=document.getElementsByTagName("head")[0],n=document.createElement("style");n.type="text/css",n.styleSheet?n.styleSheet.cssText=t:n.appendChild(document.createTextNode(t)),e.appendChild(n),this.styleElements.push(n)},L.prototype.getClassNameForAttributes_=function(t){var e,n="";for(e in t){var r,i,o,s=t[e];e===O.LINE_SENTINEL?P.utils.assert(!0===s,"LINE_SENTINEL attribute should be true if it exists."):(r=(this.options_.cssPrefix||"cmrt-")+e,!0!==s&&(e===O.FONT_SIZE&&"string"!=typeof s&&(s+="px"),r+="-"+(i=s.toString().replace(/[^A-Za-z0-9-_]/g,"-")),f[e]&&(X[e]||(X[e]={}),X[e][i]||(o="function"==typeof(o=f[e])?o(s):o+": "+s,s="",e==O.LINE_INDENT?s="pre."+r:e==O.SCENE_CODE?t[O.SCENE_ID]&&(s="."+r+"::before"):s=e==O.SCENE_ID?"."+r+"::after":"."+r,s&&(this.addStyleWithCSS_(s+" { "+o+" }"),X[e][i]=!0)))),n=n+" "+r)}return n},L.prototype.markEntity_=function(t){for(var e=t.annotation.attributes,n=P.Entity.fromAttributes(e),r=this.codeMirror,i=this,o=[],s=0;s<t.length;s++){var a=r.posFromIndex(t.pos+s),c=r.posFromIndex(t.pos+s+1),l={collapsed:!0,atomic:!0,inclusiveLeft:!1,inclusiveRight:!1},h=this.createEntityHandle_(n,t.pos),p=this.entityManager_.renderToElement(n,h),p=(p&&(l.replacedWith=p),r.markText(a,c,l));o.push(p),h.setMarker(p)}t.attachObject({clear:function(){for(var t=0;t<o.length;t++)o[t].clear()},update:function(t){for(var e=P.Entity.fromAttributes(t),n=0;n<o.length;n++)i.entityManager_.updateElement(e,o[n].replacedWith)}}),this.queueRefresh_()},L.prototype.queueRefresh_=function(){var t=this;this.refreshTimer_||(this.refreshTimer_=setTimeout(function(){t.codeMirror.refresh(),t.refreshTimer_=null},0))},L.prototype.createEntityHandle_=function(s,e){var n=null,a=this;function c(){var t;return n?(t=n.find())?a.codeMirror.indexFromPos(t.from):null:e}return{find:c,remove:function(){var t=c();null!=t&&(a.codeMirror.focus(),a.removeText(t,t+1))},replace:function(r){var i=P.AttributeConstants.ENTITY_SENTINEL,o=i+"_",t=c();a.updateTextAttributes(t,t+1,function(t){for(var e in t)delete t[e];for(var n in t[i]=s.type,r)t[o+n]=r[n]})},setMarker:function(t){n=t}}},L.prototype.lineClassRemover_=function(t){var e=this.codeMirror,n=e.getLineHandle(t);return{clear:function(){e.removeLineClass(n,"text",".*")}}},L.prototype.emptySelection_=function(){var t=this.codeMirror.getCursor("start"),e=this.codeMirror.getCursor("end");return t.line===e.line&&t.ch===e.ch},L.prototype.onLockedScenesDeleteIntent=function(t){this.onLockedScenesDeleteIntentCallback=t},L.prototype.onLockedSceneTitleEdited=function(t){this.onLockedSceneTitleEditedCallback=t},L.prototype.onCodeMirrorBeforeChange_=function(t,e){if(this.ready_&&e.origin&&0!==e.origin.indexOf(F)&&"RTCMADAPTER"!==e.origin){for(var n,r,i,o,s,a,c=this,l=c.getScenes(e.from.line,e.to.line,!0),h=0;h<l.length;h++)if(l[h].sceneOmitted)return void e.cancel();1===l.length?(n=l[0],i=e.from.line<n.lineNum||e.from.line===n.lineNum&&e.from.ch<=0,o=e.to.line>n.lineNum||e.to.line===n.lineNum&&1<=e.to.ch,s="+delete"===e.origin&&e.from.line===n.lineNum&&e.to.line===n.lineNum&&1===e.from.ch&&1===e.to.ch,a=e.from.line===n.lineNum&&1===e.from.ch&&e.to.line>n.lineNum,(r="edit")===(r=i&&o||s||a?"delete":r)?(c.onLockedSceneTitleEditedCallback&&setTimeout(function(){c.onLockedSceneTitleEditedCallback(n)},0),e.update(e.from,e.to,e.text)):"delete"===r&&(c.onLockedScenesDeleteIntentCallback&&setTimeout(function(){c.onLockedScenesDeleteIntentCallback(l)},0),e.cancel())):1<l.length&&("+delete"===e.origin||"cut"===e.origin?c.onLockedScenesDeleteIntentCallback&&setTimeout(function(){c.onLockedScenesDeleteIntentCallback(l)},0):console.log("Firepad: Intent of deleting a locked scene blocked"),e.cancel())}},L.prototype.onCodeMirrorChange_=function(t,e){if("object"==typeof e.from){for(var n=[];e;)n.push(e),e=e.next;e=n}for(var r=this.convertCoordinateSystemForChanges_(e),i=[],o=0;o<r.length;o++){var s,a,c,l,h=r[o],p=h.start,d=(h.end,h.text),u=h.removed,f=h.origin;if(0<u.length){for(var g=this.annotationList_.getAnnotatedSpansForSpan(new b(p,u.length)),y=0,m=0;m<g.length;m++){var _=g[m];i.push({start:p,end:p+_.length,removedAttributes:_.annotation.attributes,removed:u.substr(y,_.length),attributes:{},text:"",origin:h.origin}),y+=_.length}this.annotationList_.removeSpan(new b(p,u.length))}0<d.length&&("+input"===h.origin||"paste"===h.origin?((l=this.currentAttributes_||{})[O.DIFF]="added","paste"===h.origin&&(s=this,a=t.posFromIndex(p),c=t.posFromIndex(p+d.length),setTimeout(function(){s.screenplayAutoFormat(!1,"paste",a.line,c.line)},100))):f in this.outstandingChanges_?(l=this.outstandingChanges_[f].attributes,f=this.outstandingChanges_[f].origOrigin,delete this.outstandingChanges_[f]):l={},this.annotationList_.insertAnnotatedSpan(new b(p,d.length),new ut(l)),i.push({start:p,end:p,removedAttributes:{},removed:"",text:d,attributes:l,origin:f}))}this.markLineSentinelCharactersForChanges_(e),0<i.length&&this.trigger("change",this,i)},L.prototype.onCopyOrCut_=function(t,e){if("tag"===this.options_.screenplayMode&&"cut"===e.type)e.preventDefault();else if(e.clipboardData&&e.clipboardData.clearData&&e.clipboardData.setData){var n=z(t.getSelection("\n"));if(n){for(var r=t.getCursor("start"),i=t.getCursor("end"),o=[],s=r.line;s<=i.line;s++){var a=t.getLine(s),c=this.getLineAttributes_(s),l={};l[O.LINE_SENTINEL]=!0,c[O.LINE_CLASS]&&(l[O.LINE_CLASS]=c[O.LINE_CLASS]),c[O.LINE_CLASS_TYPE]&&(l[O.LINE_CLASS_TYPE]=c[O.LINE_CLASS_TYPE]),s===r.line&&1<r.ch&&(a=t.getRange(r,{line:s,ch:a.length}),l=null),s===i.line&&i.ch<a.length&&(a=t.getRange({line:s,ch:0},i)),o.push({text:z(a),attrs:l})}var h=JSON.stringify(o);"cut"===e.type&&t.replaceSelection("",null,"cut"),e.clipboardData.clearData(),e.clipboardData.setData("text",n),e.clipboardData.setData("procliq",h),e.preventDefault()}}},L.prototype.onPaste_=function(t,e){if("tag"===this.options_.screenplayMode)e.preventDefault();else if(e.clipboardData&&e.clipboardData.getData){var n=e.clipboardData.getData("procliq");if(""!==n)try{var r=JSON.parse(n);if(1<r.length){e.preventDefault();var i,o=t.getCursor("start"),s=t.getCursor("end"),a=o.line,c=t.getLine(s.line);s.ch<c.length&&(i=c.substring(s.ch),r[r.length-1].text+=i,t.extendSelection(o,{line:s.line,ch:c.length})),t.replaceSelection("",null,"cut");for(var l=0;l<r.length;l++){var h=r[l].text,p=r[l].attrs,d=1,u=(a===o.line&&1<o.ch&&(p=null,d=o.ch),l<r.length-1&&(h+="\n"),p&&(u=t.indexFromPos({line:a,ch:0}),this.insertText(u,g,p)),t.indexFromPos({line:a,ch:d}));this.insertText(u,h,{}),a++}}}catch(t){console.log(t)}}},L.prototype.onScroll_=function(t){var e;"edit"===this.options_.screenplayMode&&(e=this,setTimeout(function(){e.reportVisibleThreads()},0))},L.prototype.reportVisibleThreads=function(){if(this.onVisibleThreadsChangeCallback){var t=this.codeMirror,e=t.getWrapperElement().getBoundingClientRect(),n=t.lineAtHeight(e.top,"window"),t=t.lineAtHeight(e.bottom,"window");if(n!==this.visibleThreadsFrom||t!==this.visibleThreadsTo){this.visibleThreadsFrom=n,this.visibleThreadsTo=t;for(var r={},i="",o=this.visibleThreadsFrom;o<=this.visibleThreadsTo;o++){var s=this.codeMirror.getLine(o);if(s)for(var a=0;a<s.length;a++){var c={line:o,ch:a},l=this.codeMirror.indexFromPos(c),l=this.annotationList_.getAnnotatedSpansForSpan(new b(l,1));0<l.length&&l[0].annotation.attributes[O.THREAD]&&(r[l=l[0].annotation.attributes[O.THREAD]]||(r[l]=c,i=(i+=l+"|")+o+"|"+a+"|"))}}i!==this.serializedThreads&&(this.serializedThreads=i,this.onVisibleThreadsChangeCallback(r))}}},L.prototype.convertCoordinateSystemForChanges_=function(t){var e=this,n=function(t){return e.codeMirror.indexFromPos(t)};function r(n,r){return function(t){var e;return yt(t,r.from)?n(t):yt(r.to,t)?n({line:t.line+r.text.length-1-(r.to.line-r.from.line),ch:r.to.line<t.line?t.ch:r.text.length<=1?t.ch-(r.to.ch-r.from.ch)+mt(r.text):t.ch-r.to.ch+(e=r.text)[e.length-1].length})+mt(r.removed)-mt(r.text):r.from.line===t.line?n(r.from)+t.ch-r.from.ch:n(r.from)+mt(r.removed.slice(0,t.line-r.from.line))+1+t.ch}}for(var i=[],o=t.length-1;0<=o;o--){var s=t[o],a=(n=r(n,s))(s.from),c=s.removed.join("\n"),l=s.text.join("\n");i.unshift({start:a,end:a+c.length,removed:c,text:l,origin:s.origin})}return i},L.prototype.markLineSentinelCharactersForChanges_=function(t){for(var e=Number.MAX_VALUE,n=-1,r=0;r<t.length;r++){var i=t[r],o=i.from.line;i.from.ch;(1<i.removed.length||0<=i.removed[0].indexOf(g))&&(e=Math.min(e,o),n=Math.max(n,o)),1<i.text.length?(e=Math.min(e,o),n=Math.max(n,o+i.text.length-1)):0<=i.text[0].indexOf(g)&&(e=Math.min(e,o),n=Math.max(n,o))}n=Math.min(n,this.codeMirror.lineCount()-1),this.markLineSentinelCharactersForChangedLines_(e,n)},L.prototype.markLineSentinelCharactersForChangedLines_=function(t,e){if(t<Number.MAX_VALUE)for(;0<t&&this.lineIsListItemOrIndented_(t-1);)t--;if(-1<e)for(var n=this.codeMirror.lineCount();e+1<n&&this.lineIsListItemOrIndented_(e+1);)e++;for(var r=[],i=this.codeMirror,o=t;o<=e;o++){var s=i.getLine(o),a=i.getLineHandle(o);if(i.removeLineClass(a,"text",".*"),0<s.length)for(var c=s.indexOf(g);0<=c;){for(var l=c;c<s.length&&s[c]===g;){for(var h=i.findMarksAt({line:o,ch:c}),p=0;p<h.length;p++)h[p].isForLineSentinel&&h[p].clear();c++}this.markLineSentinelCharacters_(o,l,c,r),c=s.indexOf(g,c)}else r=[]}return e},L.prototype.markLineSentinelCharacters_=function(t,e,n,r){function i(){var t=a.find();return t?t.from.line:null}var o=this.codeMirror,s=null,a=null;if(0===e){var c=this.getLineAttributes_(t),l=c[O.LIST_TYPE],h=c[O.LINE_INDENT]||0;for(l&&0===h&&(h=1);h>=r.length;)r.push(1);"o"===l?(s=this.makeOrderedListElement_(r[h]),r[h]++):"u"===l?(s=this.makeUnorderedListElement_(),r[h]=1):"t"===l?(s=this.makeTodoListElement_(!1,i),r[h]=1):"tc"===l&&(s=this.makeTodoListElement_(!0,i),r[h]=1);l=this.getClassNameForAttributes_(c);""!==l&&this.codeMirror.addLineClass(t,"text",l),r=r.slice(0,h+1)}c={inclusiveLeft:!0,collapsed:!0};s&&(c.replacedWith=s),(a=o.markText({line:t,ch:e},{line:t,ch:n},c)).isForLineSentinel=!0},L.prototype.makeOrderedListElement_=function(t){return c.elt("div",t+".",{class:"firepad-list-left"})},L.prototype.makeUnorderedListElement_=function(){return c.elt("div","•",{class:"firepad-list-left"})},L.prototype.toggleTodo=function(t){var e,n=O.LIST_TYPE,r=this.getCurrentLineAttributes_();n in r&&("t"===r[n]||"tc"===r[n])?"t"===r[n]?e="tc":"tc"===r[n]&&(e=!!t&&"t"):e="t",this.setLineAttribute(n,e)},L.prototype.makeTodoListElement_=function(t,e){var n={type:"checkbox",class:"firepad-todo-left"},t=(t&&(n.checked=!0),c.elt("input",!1,n)),r=this;return c.on(t,"click",c.stopEventAnd(function(t){r.codeMirror.setCursor({line:e(),ch:1}),r.toggleTodo(!0)})),t},L.prototype.lineIsListItemOrIndented_=function(t){t=this.getLineAttributes_(t);return!1!==(t[O.LIST_TYPE]||!1)||0!==(t[O.LINE_INDENT]||0)},L.prototype.onCursorChange=function(t){this.onCursorChangeCallback=t},L.prototype.filterScenes=function(){if(this.shootingEvent){for(var t=this.shootingEvent.scenes||[],e=[],n=0,r=!1,i=!1,o=!0,s=this.codeMirror.firstLine(),a=this.codeMirror.lastLine(),c=s;c<=a;c++){var l,h=this.getLineAttributes_(c);if("pc-scene"===h[O.LINE_CLASS]){for(var p=h[O.SCENE_ID],d=!1,u=!1,f=0;f<t.length&&!d;)t[f].sceneId===p&&(d=!0,"PRIMARY"!==t[f].sceneType&&(u=!0)),f++;d&&(c===s&&(r=!0),o?o=!1:((h=document.createElement("div")).className=i?"firepad-scene-end-secondary":"firepad-scene-end",y=this.codeMirror.addLineWidget(c,h,{above:!0}),this.scenesFilterElements.push({type:"widget",widget:y}))),d&&!r?(e.push({startLine:n,endLine:c}),r=!0):!d&&r&&(n=c,r=!1),d&&u&&!i?i=!0:d&&!u&&i&&(i=!1)}r&&i&&(l=this.codeMirror.addLineClass(c,"wrap",h="firepad-secondary-scene"),this.scenesFilterElements.push({type:"lineClass",handle:l,where:"wrap",class:h}))}var g=document.createElement("div"),y=(g.className=i?"firepad-scene-end-secondary":"firepad-scene-end",this.codeMirror.addLineWidget(a,g,{}));this.scenesFilterElements.push({type:"widget",widget:y}),r||e.push({startLine:n,endLine:a+1});for(c=0;c<e.length;c++){var m=e[c].startLine,_=e[c].endLine,b=(_>e[c].startLine&&_--,this.codeMirror.getLine(_).length),m=this.codeMirror.markText({line:m,ch:0},{line:_,ch:b},{inclusiveLeft:!0,inclusiveRight:!0,collapsed:!0});this.scenesFilterElements.push({type:"mark",mark:m})}}},L.prototype.clearScenesFilterElements=function(){for(var t=0;t<this.scenesFilterElements.length;t++)"lineClass"===this.scenesFilterElements[t].type?this.codeMirror.removeLineClass(this.scenesFilterElements[t].handle,this.scenesFilterElements[t].where,this.scenesFilterElements[t].class):"widget"===this.scenesFilterElements[t].type?this.scenesFilterElements[t].widget.clear():"mark"===this.scenesFilterElements[t].type&&this.scenesFilterElements[t].mark.clear();this.scenesFilterElements=[]},L.prototype.getCurrentScene=function(){var t=this.codeMirror,e=t.getCursor("head");if(e)for(var n=t.firstLine(),r=e.line;n<=r;r--){var i=this.getLineAttributes_(r);if("pc-scene"===i[O.LINE_CLASS]){var o=i[O.SCENE_ID],s=i[O.SCENE_CODE],i=i[O.SCENE_OMITTED];if(s)return{lineNum:r,sceneId:o,sceneCode:s,sceneTitle:z(this.codeMirror.getLine(r)).trim(),sceneOmitted:!!i,sceneLocked:!!o}}}return null},L.prototype.getNextScene=function(){var e=this.codeMirror.getCursor("head"),t=this.getScenes();return e?t.find(function(t){return t.lineNum>e.line}):t[t.length-1]},L.prototype.prepareForNewScene=function(){var t=this.getNextScene(),e=t?t.lineNum:this.codeMirror.lastLine();t&&(t=this.codeMirror.indexFromPos({line:e,ch:0}),this.insertText(t,"\n",{}),this.insertText(t,"\n",{})),this.scrollToLine(e),this.setLineAttribute(O.LINE_CLASS,"pc-scene"),this.codeMirror.focus()},L.prototype.getScenes=function(t,e,n){for(var t="number"==typeof t?t:this.codeMirror.firstLine(),e="number"==typeof e?e:this.codeMirror.lastLine(),r=[],i=t;i<=e;i++){var o,s,a,c=this.getLineAttributes_(i);"pc-scene"===c[O.LINE_CLASS]&&(o=c[O.SCENE_ID],s=c[O.SCENE_CODE],c=c[O.SCENE_OMITTED],!s||n&&!o||(a=z(a=this.codeMirror.getLine(i)).trim(),r.push({lineNum:i,sceneId:o,sceneCode:s,sceneTitle:a,sceneOmitted:!!c,sceneLocked:!!o})))}return r},L.prototype.onScenesChange=function(t){this.onScenesChangeCallback=t},L.prototype.reportScenesStatus=function(){var t=this;if(t.ready_&&(t.recodeScenes(),t.onScenesChangeCallback&&"function"==typeof t.onScenesChangeCallback)){for(var e=t.getScenes(),n="",r=0;r<e.length;r++)n=(n=(n=(n=(n+=e[r].sceneId+"|")+e[r].sceneCode+"|")+e[r].sceneTitle+"|")+e[r].sceneOmitted+"|")+e[r].sceneLocked+"|";n!==t.serializedScenes&&(t.serializedScenes=n,t.onScenesChangeCallback(e))}setTimeout(function(){t.reportScenesStatus()},5e3)},L.prototype.onVisibleThreadsChange=function(t){this.onVisibleThreadsChangeCallback=t},L.prototype.onCursorActivity_=function(){var i=this;setTimeout(function(){var t,e,n,r;i.updateCurrentAttributes_(),i.updateToolbar(),i.onCursorChangeCallback&&(t=i.getCurrentLineAttributes_()[O.LINE_CLASS]||null,r=i.getCurrentAttributes_(),e=n=null,i.shootingEvent&&""!==i.shootingEvent.id?n=r[O.ELEMENT+"-"+i.shootingEvent.id]||null:e=r[O.THREAD]||null,r={elementId:n,threadId:e,lineClass:t,currentScene:i.getCurrentScene()},i.onCursorChangeCallback(r))},1)},L.prototype.elementMarkerPos=function(t){if(this.shootingEvent)for(var e=this.codeMirror.getCursor("head"),n=this.codeMirror.findMarksAt(e),r=this.options_.cssPrefix+O.ELEMENT+"-"+this.shootingEvent.id+"-"+t,i=0;i<n.length;i++)if(0<=n[i].getClassName().indexOf(r))return n[i].find();return null},L.prototype.selectElement=function(t){t=this.elementMarkerPos(t);t&&this.codeMirror.setSelection(t.from,t.to)},L.prototype.selectWord=function(){var t=this.codeMirror.findWordAt(this.codeMirror.getCursor());t&&this.codeMirror.setSelection(t.anchor,t.head)},L.prototype.updateToolbar=function(){if("screenplay"===this.options_.mode&&this.options_.toolbar){var t=this.getCurrentLineAttributes_();if((n=document.getElementsByClassName("firepad-btn"))&&0<n.length){for(var e,n,r=0;r<n.length;r++)n[r].classList.remove("firepad-btn-selected"),n[r].classList.remove("firepad-btn-selected-auto");t&&t[O.LINE_CLASS]&&(n=document.getElementsByClassName("firepad-tb-"+t[O.LINE_CLASS]))&&0<n.length&&(e="firepad-btn-selected",t[O.LINE_CLASS_TYPE]&&"auto"===t[O.LINE_CLASS_TYPE]&&(e="firepad-btn-selected-auto"),n[0].parentElement.classList.add(e))}}},L.prototype.getCurrentAttributes_=function(){return this.currentAttributes_||this.updateCurrentAttributes_(),this.currentAttributes_},L.prototype.updateCurrentAttributes_=function(){var t=this.codeMirror,e=t.indexFromPos(t.getCursor("anchor")),t=t.indexFromPos(t.getCursor("head")),n=t;if(t<e){for(;n<this.end();){var r=this.getRange(n,n+1);if("\n"!==r&&r!==g)break;n++}n<this.end()&&n++}else for(;0<n&&("\n"===(r=this.getRange(n-1,n))||r===g);)n--;var i,t=this.annotationList_.getAnnotatedSpansForPos(n),o=(this.currentAttributes_={},{});for(i in 0<t.length&&!(O.LINE_SENTINEL in t[0].annotation.attributes)?o=t[0].annotation.attributes:1<t.length&&(P.utils.assert(!(O.LINE_SENTINEL in t[1].annotation.attributes),"Cursor can't be between two line sentinel characters."),o=t[1].annotation.attributes),o)"l"!==i&&"lt"!==i&&"li"!==i&&0!==i.indexOf(O.ENTITY_SENTINEL)&&(this.currentAttributes_[i]=o[i])},L.prototype.getCurrentLineAttributes_=function(){var t=this.codeMirror,e=t.getCursor("anchor"),t=t.getCursor("head"),n=t.line;return 0===t.ch&&e.line<t.line&&n--,this.getLineAttributes_(n)},L.prototype.getLineAttributes_=function(t){var e={},n=this.codeMirror.getLine(t);if(0<n.length&&n[0]===g){var r,n=this.codeMirror.indexFromPos({line:t,ch:0}),i=this.annotationList_.getAnnotatedSpansForSpan(new b(n,1));for(r in P.utils.assert(1===i.length),i[0].annotation.attributes)e[r]=i[0].annotation.attributes[r]}return e},L.prototype.newline=function(){var n,t,r,i,e=this.codeMirror,o=this;this.emptySelection_()?(t=e.getCursor("head"),n=t.line,t=t.ch,r=this.getLineAttributes_(n),(i=r[O.LIST_TYPE])&&1===e.getLine(n).length?this.updateLineAttributes(n,n,function(t){delete t[O.LIST_TYPE],delete t[O.LINE_INDENT]}):t<=1?e.replaceRange("\n",{line:n,ch:0},{line:n,ch:0},"+input"):(e.replaceSelection("\n","end","+input"),this.updateLineAttributes(n+1,n+1,function(t){for(var e in r)e!==O.LINE_CLASS&&e!==O.LINE_CLASS_TYPE&&e!==O.SCENE_CODE&&e!==O.SCENE_ID&&(t[e]=r[e]);"tc"===i&&(t[O.LIST_TYPE]="t"),o.trigger("newLine",{line:n+1,attr:t})}))):e.replaceSelection("\n","end","+input"),setTimeout(function(){o.updateCurrentAttributes_(),o.updateToolbar()},100)},L.prototype.deleteLeft=function(){var t=this.codeMirror,e=t.getCursor("head"),n=this.getLineAttributes_(e.line),r=n[O.LIST_TYPE],n=n[O.LINE_INDENT],i=this.emptySelection_()&&1===e.ch,o=e.line>t.firstLine()?t.getLine(e.line-1):"",o=e.line>t.firstLine()&&this.areLineSentinelCharacters_(o);i&&r?this.updateLineAttributes(e.line,e.line,function(t){delete t[O.LIST_TYPE],delete t[O.LINE_INDENT]}):i&&n&&0<n?this.unindent():o?t.replaceRange("",{line:e.line-1,ch:0},{line:e.line,ch:0},"+input"):t.deleteH(-1,"char")},L.prototype.deleteRight=function(){var t=this.codeMirror,e=t.getCursor("head"),n=t.getLine(e.line),n=this.areLineSentinelCharacters_(n),r=e.line+1<t.lineCount()?t.getLine(e.line+1):"";this.emptySelection_()&&n&&r[0]===g?(t.replaceRange("",{line:e.line,ch:0},{line:e.line+1,ch:0},"+input"),t.setCursor({line:e.line,ch:0})):t.deleteH(1,"char")},L.prototype.indent=function(){this.updateLineAttributesForSelection(function(t){var e=t[O.LINE_INDENT],n=t[O.LIST_TYPE];e?t[O.LINE_INDENT]++:t[O.LINE_INDENT]=n?2:1})},L.prototype.unindent=function(){this.updateLineAttributesForSelection(function(t){var e=t[O.LINE_INDENT];e&&1<e?t[O.LINE_INDENT]=e-1:(delete t[O.LIST_TYPE],delete t[O.LINE_INDENT])})},L.prototype.getText=function(){return this.codeMirror.getValue().replace(new RegExp(g,"g"),"")},L.prototype.areLineSentinelCharacters_=function(t){for(var e=0;e<t.length;e++)if(t[e]!==g)return!1;return!0},ut.prototype.equals=function(t){if(!(t instanceof ut))return!1;for(var e in this.attributes)if(t.attributes[e]!==this.attributes[e])return!1;for(e in t.attributes)if(t.attributes[e]!==this.attributes[e])return!1;return!0},L),(P=P||{}).RichTextCodeMirrorAdapter=function(){"use strict";var f=P.TextOperation,g=P.WrappedOperation,i=P.Cursor;function n(t){this.rtcm=t,this.cm=t.codeMirror,e(this,"onChange"),e(this,"onAttributesChange"),e(this,"onCursorActivity"),e(this,"onFocus"),e(this,"onBlur"),this.rtcm.on("change",this.onChange),this.rtcm.on("attributesChange",this.onAttributesChange),this.cm.on("cursorActivity",this.onCursorActivity),this.cm.on("focus",this.onFocus),this.cm.on("blur",this.onBlur)}function o(t,e){return t.line<e.line?-1:t.line>e.line?1:t.ch<e.ch?-1:t.ch>e.ch?1:0}function l(t){var e=t.lineCount()-1;return t.indexFromPos({line:e,ch:t.getLine(e).length})}function e(t,e){var n=t[e];t[e]=function(){n.apply(t,arguments)}}function y(t){for(var e in t)return;return 1}function m(t,e){if("string"!=typeof t)throw new TypeError("Expected a string");3===(t=t.replace(/^#/,"")).length&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]);var t=parseInt(t,16),t=[t>>16,t>>8&255,255&t],n="rgb";return null!=e&&(n="rgba",t.push(e)),n+"("+t.join(",")+")"}return n.prototype.detach=function(){this.rtcm.off("change",this.onChange),this.rtcm.off("attributesChange",this.onAttributesChange),this.cm.off("cursorActivity",this.onCursorActivity),this.cm.off("focus",this.onFocus),this.cm.off("blur",this.onBlur)},n.operationFromCodeMirrorChanges=function(t,e){for(var n=l(e),r=(new f).retain(n),i=(new f).retain(n),o=t.length-1;0<=o;o--){var s=t[o],a=s.start,c=n-a-s.text.length,r=(new f).retain(a).delete(s.removed.length).insert(s.text,s.attributes).retain(c).compose(r),i=i.compose((new f).retain(a).delete(s.text.length).insert(s.removed,s.removedAttributes).retain(c));n+=s.removed.length-s.text.length}return[r,i]},n.operationFromAttributesChanges=function(t,e){for(var e=l(e),n=new f,r=new f,i=0,o=0;o<t.length;o++){var s=t[o],a=s.start-i,c=c=void 0;if(!(0<=a))throw new Error(c||"assertion error");n.retain(a),r.retain(a);c=s.end-s.start;n.retain(c,s.attributes),r.retain(c,s.attributesInverse),i=s.start+c}return n.retain(e-i),r.retain(e-i),[n,r]},n.prototype.registerCallbacks=function(t){this.callbacks=t},n.prototype.onChange=function(t,e){"RTCMADAPTER"!==e[0].origin&&(e=n.operationFromCodeMirrorChanges(e,this.cm),this.trigger("change",e[0],e[1]))},n.prototype.onAttributesChange=function(t,e){"RTCMADAPTER"!==e[0].origin&&(e=n.operationFromAttributesChanges(e,this.cm),this.trigger("change",e[0],e[1]))},n.prototype.onCursorActivity=function(){var t=this;setTimeout(function(){t.trigger("cursorActivity")},1)},n.prototype.onFocus=function(){this.trigger("focus")},n.prototype.onBlur=function(){this.cm.somethingSelected()||this.trigger("blur")},n.prototype.getValue=function(){return this.cm.getValue()},n.prototype.getCursor=function(){var t,e=this.cm,n=e.getCursor(),r=e.indexFromPos(n);return t=e.somethingSelected()?(t=e.getCursor(!0),n=0===o(n,t)?e.getCursor(!1):t,e.indexFromPos(n)):r,new i(r,t)},n.prototype.setCursor=function(t){this.cm.setSelection(this.cm.posFromIndex(t.position),this.cm.posFromIndex(t.selectionEnd))},n.prototype.addStyleRule=function(t){var e;if("undefined"!=typeof document&&null!==document&&(this.addedStyleRules||(this.addedStyleRules={},e=document.createElement("style"),document.documentElement.getElementsByTagName("head")[0].appendChild(e),this.addedStyleSheet=e.sheet),!this.addedStyleRules[t]))return this.addedStyleRules[t]=!0,this.addedStyleSheet.insertRule(t,0)},n.prototype.setOtherCursor=function(t,e,n,r,i){var o,s,a,c,l,h,p,d=this.cm.posFromIndex(e.position),u=this.rtcm.end();if("string"==typeof n&&n.match(/^#[a-fA-F0-9]{3,6}$/)&&("object"==typeof e&&"number"==typeof e.position&&"number"==typeof e.selectionEnd&&!(e.position<0||e.position>u||e.selectionEnd<0||e.selectionEnd>u)))return u=[],e.position!==e.selectionEnd&&(a="."+(o="selection-"+n.replace("#",""))+" { background: "+m(n)+";\n background: "+m(n,.4)+";}",this.addStyleRule(a),a=e.selectionEnd>e.position?(s=d,this.cm.posFromIndex(e.selectionEnd)):(s=this.cm.posFromIndex(e.selectionEnd),d),u.push(this.cm.markText(s,a,{className:o}))),(c=document.createElement("div")).style.color="white",c.style.display="block",c.innerHTML='<span style="position: absolute; background-color: '+n+'; top: -18px; left: -2px; padding: 0 4px; font-size: .9rem; white-space: nowrap;">'+i+"</span>",(l=document.createElement("span")).className="other-client",l.style.width="2px",l.style.backgroundColor=n,l.style.marginLeft=l.style.marginRight="-1px",l.style.height="20px",l.setAttribute("data-clientid",r),l.style.zIndex=0,l.style.position="absolute",l.innerHTML='<div style="position: absolute; height: 20px; top: -4px; margin-left: -2px;"><div style="width: 6px; height: 6px; background:'+n+' "></div></div>',l.appendChild(c),h=!1,p=function(){setTimeout(function(){h||(c.style.display="none")},2e3)},l.addEventListener("mouseover",function(){l.parentNode&&(h=!0,c.style.display="block")}),l.addEventListener("mouseout",function(){h=!1,p()}),u.push(this.cm.setBookmark(d,{widget:l,insertLeft:!0})),p(),u},n.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),t=this.callbacks&&this.callbacks[t];t&&t.apply(this,e)},n.prototype.applyOperation=function(t){10<t.ops.length&&this.rtcm.codeMirror.getWrapperElement().setAttribute("style","display: none");for(var e=t.ops,n=0,r=0,i=e.length;r<i;r++){var o=e[r];o.isRetain()?(y(o.attributes)||this.rtcm.updateTextAttributes(n,n+o.chars,function(t){for(var e in o.attributes)!1===o.attributes[e]?delete t[e]:t[e]=o.attributes[e]},"RTCMADAPTER",!0),n+=o.chars):o.isInsert()?(this.rtcm.insertText(n,o.text,o.attributes,"RTCMADAPTER"),n+=o.text.length):o.isDelete()&&this.rtcm.removeText(n,n+o.chars,"RTCMADAPTER")}10<t.ops.length&&(this.rtcm.codeMirror.getWrapperElement().setAttribute("style",""),this.rtcm.codeMirror.refresh())},n.prototype.registerUndo=function(t){this.cm.undo=t},n.prototype.registerRedo=function(t){this.cm.redo=t},n.prototype.invertOperation=function(t){for(var e=0,n=this.rtcm.codeMirror,r=new f,i=0;i<t.wrapped.ops.length;i++){var o=t.wrapped.ops[i];if(o.isRetain())if(y(o.attributes))r.retain(o.chars),e+=o.chars;else for(p=this.rtcm.getAttributeSpans(e,e+o.chars),u=0;u<p.length;u++){var s,a={};for(s in o.attributes){var c=o.attributes[s],l=p[u].attributes[s];!1===c?l&&(a[s]=l):c!==l&&(a[s]=l||!1)}r.retain(p[u].length,a),e+=p[u].length}else if(o.isInsert())r.delete(o.text.length);else if(o.isDelete()){for(var h=n.getRange(n.posFromIndex(e),n.posFromIndex(e+o.chars)),p=this.rtcm.getAttributeSpans(e,e+o.chars),d=0,u=0;u<p.length;u++)r.insert(h.substr(d,p[u].length),p[u].attributes),d+=p[u].length;e+=o.chars}}return new g(r,t.meta.invert())},n}(),(P=P||{}).Formatting=(y=P.AttributeConstants,x.prototype.cloneWithNewAttribute_=function(t,e){var n,r={};for(n in this.attributes)r[n]=this.attributes[n];return!1===e?delete r[t]:r[t]=e,new x(r)},x.prototype.bold=function(t){return this.cloneWithNewAttribute_(y.BOLD,t)},x.prototype.italic=function(t){return this.cloneWithNewAttribute_(y.ITALIC,t)},x.prototype.underline=function(t){return this.cloneWithNewAttribute_(y.UNDERLINE,t)},x.prototype.strike=function(t){return this.cloneWithNewAttribute_(y.STRIKE,t)},x.prototype.font=function(t){return this.cloneWithNewAttribute_(y.FONT,t)},x.prototype.fontSize=function(t){return this.cloneWithNewAttribute_(y.FONT_SIZE,t)},x.prototype.color=function(t){return this.cloneWithNewAttribute_(y.COLOR,t)},x.prototype.backgroundColor=function(t){return this.cloneWithNewAttribute_(y.BACKGROUND_COLOR,t)},x),(P=P||{}).Text=function t(e,n){if(!(this instanceof t))return new t(e,n);this.text=e,this.formatting=n||P.Formatting()},(P=P||{}).LineFormatting=(m=P.AttributeConstants,T.LIST_TYPE={NONE:!1,ORDERED:"o",UNORDERED:"u",TODO:"t",TODOCHECKED:"tc"},T.prototype.cloneWithNewAttribute_=function(t,e){var n,r={};for(n in this.attributes)r[n]=this.attributes[n];return!1===e?delete r[t]:r[t]=e,new T(r)},T.prototype.indent=function(t){return this.cloneWithNewAttribute_(m.LINE_INDENT,t)},T.prototype.align=function(t){return this.cloneWithNewAttribute_(m.LINE_ALIGN,t)},T.prototype.setClass=function(t){return this.cloneWithNewAttribute_(m.LINE_CLASS,t)},T.prototype.setClassType=function(t){return this.cloneWithNewAttribute_(m.LINE_CLASS_TYPE,t)},T.prototype.listItem=function(t){return P.utils.assert(!1===t||"u"===t||"o"===t||"t"===t||"tc"===t),this.cloneWithNewAttribute_(m.LIST_TYPE,t)},T.prototype.getIndent=function(){return this.attributes[m.LINE_INDENT]||0},T.prototype.getAlign=function(){return this.attributes[m.LINE_ALIGN]||0},T.prototype.getClass=function(){return this.attributes[m.LINE_CLASS]||""},T.prototype.getClassType=function(){return this.attributes[m.LINE_CLASS_TYPE]||""},T.prototype.getListItem=function(){return this.attributes[m.LIST_TYPE]||!1},T),(P=P||{}).Line=function t(e,n){if(!(this instanceof t))return new t(e,n);"[object Array]"!==Object.prototype.toString.call(e)&&(e=void 0===e?[]:[e]),this.textPieces=e,this.formatting=n||P.LineFormatting()},(P=P||{}).ParseHtml=(nt=P.LineFormatting.LIST_TYPE,S.prototype.withTextFormatting=function(t){return new S(this.listType,this.lineFormatting,t)},S.prototype.withLineFormatting=function(t){return new S(this.listType,t,this.textFormatting)},S.prototype.withListType=function(t){return new S(t,this.lineFormatting,this.textFormatting)},S.prototype.withIncreasedIndent=function(){var t=this.lineFormatting.indent(this.lineFormatting.getIndent()+1);return new S(this.listType,t,this.textFormatting)},S.prototype.withAlign=function(t){t=this.lineFormatting.align(t);return new S(this.listType,t,this.textFormatting)},bt.prototype.newlineIfNonEmpty=function(t){this.cleanLine_(),0<this.currentLine.length&&this.newline(t)},bt.prototype.newlineIfNonEmptyOrListItem=function(t){this.cleanLine_(),(0<this.currentLine.length||null!==this.currentLineListItemType)&&this.newline(t)},bt.prototype.newline=function(t){this.cleanLine_();t=t.lineFormatting;null!==this.currentLineListItemType&&(t=t.listItem(this.currentLineListItemType),this.currentLineListItemType=null),this.lines.push(P.Line(this.currentLine,t)),this.currentLine=[]},bt.prototype.makeListItem=function(t){this.currentLineListItemType=t},bt.prototype.cleanLine_=function(){if(0<this.currentLine.length){var t=this.currentLine.length-1;this.currentLine[0].text=this.currentLine[0].text.replace(/^ +/,""),this.currentLine[t].text=this.currentLine[t].text.replace(/ +$/g,"");for(var e=0;e<this.currentLine.length;e++)this.currentLine[e].text=this.currentLine[e].text.replace(/\u00a0/g," ")}1===this.currentLine.length&&""===this.currentLine[0].text&&(this.currentLine=[])},rt=rt||{ELEMENT_NODE:1,TEXT_NODE:3},function(t,e){var n=(P.document||document).createElement("div"),t=(n.innerHTML=t,et=e,new bt);return vt(n,new S,t),t.lines}),(P=P||{}).SerializeHtml=(it=P.utils,R=P.AttributeConstants,D=P.LineFormatting.LIST_TYPE,function(t,e){for(var n,r,i,o="",s=!0,a=[],c=!1,l=!0,h=!0,p=0,d=t.ops[p],u=0,f=!1;d;){it.assert(d.isInsert());var g=d.attributes;if(s){var s=!1,y=0,m=null,_="left",b="",v="",E="",C="";R.LINE_SENTINEL in g&&(y=g[R.LINE_INDENT]||0,m=g[R.LIST_TYPE]||null,_=g[R.LINE_ALIGN]||"left",b=g[R.LINE_CLASS]||"",v=g[R.LINE_CLASS_TYPE]||"",E=g[R.SCENE_CODE]||"",C=g[R.SCENE_ID]||""),c?(o+="</li>",c=!1):l||(h&&(o+="<br/>"),o+="</div>"),l=!1,it.assert(0<=(y=m?y||1:y),"Indent must not be negative.");for(;a.length>y||y===a.length&&null!==m&&(r=m,i=a[a.length-1],!(r===i||r===D.TODO&&i===D.TODOCHECKED||r===D.TODOCHECKED&&i===D.TODO));)o+=Et(a.pop());for(;a.length<y;){var L=m||D.UNORDERED,f=m==D.TODO||m==D.TODOCHECKED||f;o+=(n=L)===D.ORDERED?"<ol>":n===D.UNORDERED?"<ul>":'<ul class="firepad-todo">',a.push(L)}var _="left"!==_?' style="text-align:'+_+'"':"",x="";if(m){switch(m){case D.TODOCHECKED:x=' class="firepad-checked"';break;case D.TODO:x=' class="firepad-unchecked"'}o+="<li"+x+_+">",c=!0}else o+="<div"+(x=b?' class="'+b+'"':"")+(v?' class-type="'+v+'"':"")+(C?' scene-id="'+C+'"':"")+_+">"+(E?"<span class='scene-code-print' >"+E+"</span>":"");h=!0}if(R.LINE_SENTINEL in g)d=t.ops[++p];else if(R.ENTITY_SENTINEL in g){for(var T=0;T<d.text.length;T++){var S=P.Entity.fromAttributes(g);o+=e.exportToElement(S).outerHTML}d=t.ops[++p]}else{var A,M="",w="";for(A in g){var N,I,k=g[A];A===R.BOLD||A===R.ITALIC||A===R.UNDERLINE||A===R.STRIKE?(it.assert(!0===k),N=I=A):A===R.FONT_SIZE?(N='span style="font-size: '+k,N+="string"!=typeof k||-1===k.indexOf("px",k.length-2)?'px"':'"',I="span"):A===R.FONT?(N='span style="font-family: '+k+'"',I="span"):A===R.COLOR?(N='span style="color: '+k+'"',I="span"):A===R.BACKGROUND_COLOR&&(N='span style="background-color: '+k+'"',I="span"),N&&(M+="<"+N+">"),I&&(w="</"+I+">"+w)}b=d.text,v=b.indexOf("\n"),C=(0<=v?(s=!0,d=v<b.length-1?new P.TextOp("insert",b.substr(v+1),g):t.ops[++p],b=b.substr(0,v)):d=t.ops[++p],0<(b=b.replace(/  +/g,function(t){return new Array(t.length+1).join(" ")}).replace(/^ /," ").replace(/ $/," ")).length&&(h=!1),""),_=!g[R.LINE_CLASS]||"pc-action"===g[R.LINE_CLASS];u<50?80<=b.length?u+=parseInt(b.length/80)+1+(_?1:0):u+=1+(_?1:0):(C="<span style='display:block; page-break-after:always;'></span>",u=0),o+=M+b.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\u00a0/g,"&nbsp;")+C+w}}for(c?o+="</li>":l||(h&&(o+="&nbsp;"),o+="</div>");0<a.length;)o+=Et(a.pop());return'<style> @page { size: A4; margin-top: 1in; margin-right: 1in; margin-bottom: 1in; margin-left: 1.5in; } @media print { * { font-size: 12pt !important; } .CodeMirror { width: 8.3in; } } .CodeMirror:after { font-family: monospace; } .b { font-weight: bold; } .i { font-style: italic; } .u { text-decoration: underline; } .s { text-decoration: line-through; } .u.s { text-decoration: underline line-through; } .f-arial { font-family: Arial, Helvetica, sans-serif; } .left { text-align: left; } .center { text-align: center; } .right { text-align: right; }  .pc-scene { text-align: left; text-transform: uppercase; font-weight: bold; } .pc-action { text-align: left; padding: 12pt 0 !important; } .pc-character { padding-left: 2.5in !important; padding-right: 0 !important; text-transform: uppercase; } .pc-dialogue { margin-left: 1.5in !important; width: 3.5in !important; } .pc-parenthetical { padding-left: 2in !important; padding-right: 1.5in !important; } .pc-transition { text-align: right; text-transform: uppercase; } .-pc-act-start { text-align: center; text-transform: uppercase; text-decoration: underline; } .-pc-act-end { text-align: center; text-transform: uppercase; text-decoration: underline; } .-pc-centered { text-align: center; } pre.o, pre.u, pre.t, pre.tc { padding-left: 40px; } .list-left { display: inline-block; margin-left: -40px; width: 40px; padding-right: 5px; text-align: right; } .todo-left { display: inline-block; margin-left: -20px; width: 20px; } .btn-group { margin: 5px 7px 0 0; display: inline-block; } a.btn, a.btn:visited, a.btn:active { font-family: "Arial" sans-serif; cursor: pointer; text-decoration: none; padding: 6px 6px 4px 6px; text-align: center; vertical-align: middle; font-size: 14px; background-color: #fcfcfc; border: 1px solid #c9c9c9; color: grey; } a.btn:hover, a.btn-selected { color: #fff; background-color: dimgrey; text-decoration: none; } a.btn-selected-auto { color: #fff; background-color: dimgrey; text-decoration: none; opacity: 0.5; } a.btn:active { -webkit-box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.05); -moz-box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.05); box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.05); } .btn-group > .btn { -webkit-border-radius: 0; -moz-border-radius: 0; border-radius: 0; margin-left: -1px; } .btn-group > .btn:first-child { border-bottom-left-radius: 6px; border-top-left-radius: 6px; -webkit-border-bottom-left-radius: 6px; -webkit-border-top-left-radius: 6px; -moz-border-radius-bottomleft: 6px; -moz-border-radius-topleft: 6px; margin-left: 0px; } .btn-group > .btn:last-child { border-bottom-right-radius: 6px; border-top-right-radius: 6px; -webkit-border-bottom-right-radius: 6px; -webkit-border-top-right-radius: 6px; -moz-border-radius-bottomright: 6px; -moz-border-radius-topright: 6px; } .dropdown { position: relative; } .dropdown-menu { position: absolute; top: 100%; left: 0; z-index: 1000; display: none; float: left; padding: 4px 0; margin: 4px 0 0; list-style: none; background-color: #ffffff; border: 1px solid #ccc; border: 1px solid rgba(0, 0, 0, 0.2); *border-right-width: 2px; *border-bottom-width: 2px; -webkit-border-radius: 5px; -moz-border-radius: 5px; border-radius: 5px; -webkit-box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2); -moz-box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2); box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2); -webkit-background-clip: padding-box; -moz-background-clip: padding; background-clip: padding-box; } .dropdown-menu a { text-align: left; display: block; padding: 3px 15px; clear: both; font-weight: normal; line-height: 18px; color: #333333; white-space: nowrap; } .dropdown-menu a:hover { color: #fff; text-decoration: none; background-color: #ffbf86; } .color-dropdown-item { height: 25px; width: 25px; } .dialog { position: absolute; left: 0px; top: 0px; width: 100%; height: 100%; z-index: 1000; } .dialog-div { position: relative; width: 400px; height: 100px; margin: 100px auto; background-color: #fff; border: 1px solid #000; padding: 15px; } .dialog-input { width: 80%; display: block; padding: 5px 5px; margin: 10px 10px 10px 5px; clear: both; font-weight: normal; line-height: 25px; color: #333333; white-space: nowrap; } @font-face { font-family: "firepad"; src: url("firepad.woff"); } .bold, .italic, .underline, .strikethrough, .list, .list-2, .numbered-list, .paragraph-left, .paragraph-center, .paragraph-right, .paragraph-justify, .menu, .link, .undo, .redo, .box-add, .box-remove, .print, .indent-decrease, .indent-increase, .insert-image, .bubble { font-family: "firepad"; speak: none; font-style: normal; font-weight: normal; font-variant: normal; text-transform: none; line-height: 1; -webkit-font-smoothing: antialiased; } .bold:before { content: "e000"; } .italic:before { content: "e001"; } .underline:before { content: "e002"; } .strikethrough:before { content: "e003"; } .list:before { content: "e004"; } .list-2:before { content: "e005"; } .numbered-list:before { content: "e006"; } .paragraph-left:before { content: "e007"; } .paragraph-center:before { content: "e008"; } .paragraph-right:before { content: "e009"; } .paragraph-justify:before { content: "e00a"; } .menu:before { content: "e00b"; } .link:before { content: "e00c"; } .undo:before { content: "e00d"; } .redo:before { content: "e00e"; } .box-add:before { content: "e010"; } .box-remove:before { content: "e011"; } .print:before { content: "e012"; } .indent-decrease:before { content: "e013"; } .indent-increase:before { content: "e014"; } .insert-image:before { content: "e015"; } .bubble:before { content: "e00f"; } .scene, .action, .character, .dialogue, .parenthetical, .transition, .act-start, .act-end, .centered, .auto-format { font-family: "firepad"; speak: none; font-style: normal; font-weight: normal; font-variant: normal; text-transform: none; line-height: 1; -webkit-font-smoothing: antialiased; } .scene:before { content: "Scene"; font-family: monospace; } .action:before { content: "Action"; font-family: monospace; } .character:before { content: "Character"; font-family: monospace; } .dialogue:before { content: "Dialogue"; font-family: monospace; } .parenthetical:before { content: "Parenthetical"; font-family: monospace; } .transition:before { content: "Transition"; font-family: monospace; } .act-start:before { content: "Act Start"; font-family: monospace; } .act-end:before { content: "Act End"; font-family: monospace; } .centered:before { content: "e008"; } .pc-auto-format:before { content: "Auto Format"; font-family: monospace; } .scene-start { height: 25px; border-top: 1px solid lightgrey; } .scene-end { height: 15px; } .scene-end-with-border { height: 15px; border-bottom: 1px solid lightgrey; } .secondary-scene { background-color: #f3f3f3; color: #4c4c4c; } </style>\n<div class=\'CodeMirror\'>'+(o=f?'<style>ul.firepad-todo { list-style: none; margin-left: 0; padding-left: 0; } ul.firepad-todo > li { padding-left: 1em; text-indent: -1em; } ul.firepad-todo > li:before { content: "\\2610"; padding-right: 5px; } ul.firepad-todo > li.firepad-checked:before { content: "\\2611"; padding-right: 5px; }</style>\n'+o:o)+"</div>"}),(P=P||{}).SerializeJson=(ot=P.utils,v=P.AttributeConstants,function(t,e){var n=!0,r=!0,i=0,o=t.ops[i],s={size:0,lines:[]},a="",c="",l="",h=0,p=[];function d(t,e,n,r,i){t={format:t.replace("pc-",""),content:r};e&&(t.scene_code=e),n&&(t.scene_id=n),s.size+=i,s.lines.push(t)}for(;o;){ot.assert(o.isInsert());var u=o.attributes;if(n&&(n=!1,r||(d(a,c,l,p,h),l=c=a="",h=0,p=[]),r=!1,v.LINE_SENTINEL in u&&(a=u[v.LINE_CLASS]||"",c=u[v.SCENE_CODE]||"",l=u[v.SCENE_ID]||"")),v.LINE_SENTINEL in u||v.ENTITY_SENTINEL in u)o=t.ops[++i];else{var f,g=o.text,y=g.indexOf("\n"),m=(0<=y?(n=!0,o=y<g.length-1?new P.TextOp("insert",g.substr(y+1),u):t.ops[++i],g=g.substr(0,y)):o=t.ops[++i],{});for(f in u){var _=u[f];e?f===v.ELEMENT+"-"+e&&(m.element_id=_):f===v.THREAD&&(m.thread_id=_)}h+=g.length,e?0<p.length&&p[p.length-1].attrs.element_id===m.element_id?p[p.length-1].text+=g:p.push({text:g,attrs:m}):0<p.length&&p[p.length-1].attrs.thread_id===m.thread_id?p[p.length-1].text+=g:p.push({text:g,attrs:m})}}return r||d(a,c,l,p,h),s}),(P=P||{}).SerializePdfMake=(st=P.utils,_=P.AttributeConstants,function(t,e){var n=!0,r=!0,i=0,o=t.ops[i],s={fontSize:11},a=(e&&(s.font=e),{size:0,content:[],pageSize:"LETTER",pageOrientation:"portrait",pageMargins:[108,92,72,72],defaultStyle:s,styles:{scene:{margin:[0,24,0,0],bold:!0},action:{margin:[0,12,0,0]},character:{margin:[144,12,18,0]},dialogue:{margin:[72,0,108,0]},parenthetical:{margin:[108,0,144,0]},transition:{margin:[0,12,0,0],alignment:"right"},centered:{margin:[0,12,0,0],alignment:"center"}},header:function(t,e,n){return{text:t.toString()+".",alignment:"right",margin:[0,72,72,0]}}}),c="",l="",h="",p="",d=0;function u(t,e,n,r,i){t=t.replace("pc-",""),"scene"===t||"character"===t||"transition"===t?r=r.toUpperCase():"act-start"===t||"act-end"===t?t="centered":""===t&&(t="action"),r={text:r,style:t};e&&(r.text=e+"  "+r.text,r.sceneCode=e),n&&(r.sceneId=n),a.content.push(r),a.size+=i}for(;o;){st.assert(o.isInsert());var f,g,y=o.attributes;n&&(n=!1,r||(u(c,l,h,p,d),p=h=l=c="",d=0),r=!1,_.LINE_SENTINEL in y&&(c=y[_.LINE_CLASS]||"",l=y[_.SCENE_CODE]||"",h=y[_.SCENE_ID]||"")),_.LINE_SENTINEL in y||_.ENTITY_SENTINEL in y?o=t.ops[++i]:(0<=(g=(f=o.text).indexOf("\n"))?(n=!0,o=g<f.length-1?new P.TextOp("insert",f.substr(g+1),y):t.ops[++i],f=f.substr(0,g)):o=t.ops[++i],p+=f,d+=f.length)}return r||u(c,l,h,p,d),a}),(P=P||{}).SerializeText=(at=P.utils,E=P.AttributeConstants,function(t){var e=!0,n=!0,r=0,i=t.ops[r],o="",s="",a="";function c(t,e){t=t.replace("pc-","");o+='{line format="'+t+'"}'+e+"\n"}for(;i;){at.assert(i.isInsert());var l=i.attributes;if(e&&(e=!1,n||(c(s,a),a=s=""),n=!1,E.LINE_SENTINEL in l&&(s=l[E.LINE_CLASS]||"")),E.LINE_SENTINEL in l||E.ENTITY_SENTINEL in l)i=t.ops[++r];else{var h,p=i.text,d=p.indexOf("\n"),u=(0<=d?(e=!0,i=d<p.length-1?new P.TextOp("insert",p.substr(d+1),l):t.ops[++r],p=p.substr(0,d)):i=t.ops[++r],!1),f={};for(h in l){var g=l[h],y=E.ELEMENT+"-",m=E.ELEMENT_COLOR+"-";0===h.indexOf(y)&&(f[_=h.replace(y,"")]||(f[_]={}),f[_].id=g,u=!0),0===h.indexOf(m)&&(f[_=h.replace(m,"")]||(f[_]={}),f[_].color=g)}d="";if(u){var _,b="";for(_ in f)f.hasOwnProperty(_)&&(""!==b&&(b+="|"),b+=_+","+(f[_].id||"")+","+(f[_].color||""));d='{elem attrs="'+b+'"}'+p+"{/elem}"}else d=p;a+=d}}return n||c(s,a),o}),(P=P||{}).textPiecesToInserts=function(n,t){var r=[];function e(t,e){t instanceof P.Text&&(e=t.formatting.attributes,t=t.text),r.push({string:t,attributes:e}),n="\n"===t[t.length-1]}for(var i=0;i<t.length;i++)if(t[i]instanceof P.Line){a=s=o=void 0;var o=t[i],s=i<t.length-1;n&&e(P.sentinelConstants.LINE_SENTINEL_CHARACTER,o.formatting.attributes);for(var a=0;a<o.textPieces.length;a++)e(o.textPieces[a]);s&&e("\n")}else e(t[i]);return r},(P=P||{}).Headless=(ct=P.TextOperation,lt=P.FirebaseAdapter,ht=P.EntityManager,pt=P.ParseHtml,dt=P.sentinelConstants.TRIGGER_AUTOFORMAT_SENTINEL_CHARACTER,C=P.AttributeConstants,M.prototype.getDocument=function(t){if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");if(this.ready_)return t(this.firebaseAdapter_.getDocument());var e=this;setTimeout(function(){e.getDocument(t)},100)},M.prototype.getDocumentAtRevision=function(t,e){if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");if(this.ready_)return this.firebaseAdapter_.getDocumentAtRevision(t,e);var n=this;setTimeout(function(){n.getDocumentAtRevision(t,e)},100)},M.prototype.getLastRevision=function(t){if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");if(this.ready_)return t(this.firebaseAdapter_.getLastRevision());var e=this;setTimeout(function(){e.getLastRevision(t)},100)},M.prototype.copyDocument=function(t,o){if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");var e=this,s=new lt(t,this.deviceId_);s.on("ready",function(){e.getDocument(function(t){if(0===t.ops.length)return o(null);for(var e=0;e<t.ops.length;e++){var n,r=t.ops[e].attributes,i={};for(n in r)n!==C.SCENE_CODE&&n!==C.SCENE_ID&&n!==C.SCENE_OMITTED&&n!==C.THREAD&&n!==C.DIFF&&0!==n.indexOf(C.ELEMENT+"-")&&0!==n.indexOf(C.ELEMENT_COLOR+"-")&&(i[n]=r[n]);t.ops[e].attributes=i}s.sendOperation(t,function(t){o(t)})})})},M.prototype.getText=function(n){if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");this.getDocument(function(t){var e=t.apply("");for(key in P.sentinelConstants)e=e.replace(new RegExp(P.sentinelConstants[key],"g"),"");n(e)})},M.prototype.setText=function(t,e){if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");t=dt+t;t=ct().insert(t);this.sendOperationWithRetry(t,e)},M.prototype.initializeFakeDom=function(n){"object"==typeof document||"object"==typeof P.document?n():require("jsdom/lib/old-api.js").env("<head></head><body></body>",function(t,e){if(P.document)return e.close(),n();P.document=e.document,n()})},M.prototype.getJson=function(t,e,n){if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");t?this.getDocumentAtRevision(t,function(t){n(P.SerializeJson(t,e))}):this.getDocument(function(t){n(P.SerializeJson(t,e))})},M.prototype.getJsonForPdfMake=function(t,e,n){if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");t?this.getDocumentAtRevision(t,function(t){n(P.SerializePdfMake(t,e))}):this.getDocument(function(t){n(P.SerializePdfMake(t,e))})},M.prototype.getHtml=function(e){var n=this;if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");n.initializeFakeDom(function(){n.getDocument(function(t){e(P.SerializeHtml(t,n.entityManager_))})})},M.prototype.setHtml=function(i,o){var s=this;if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");s.initializeFakeDom(function(){for(var t=pt(i,s.entityManager_),e=P.textPiecesToInserts(!0,t),n=new ct,r=0;r<e.length;r++)n.insert(e[r].string,e[r].attributes);s.sendOperationWithRetry(n,o)})},M.prototype.sendOperationWithRetry=function(n,r){var i=this;i.getDocument(function(t){t=n.clone().delete(t.targetLength);i.firebaseAdapter_.sendOperation(t,function(t,e){e?void 0!==r&&r(null,e):i.sendOperationWithRetry(n,r)})})},M.prototype.dispose=function(){this.zombie_=!0,this.firebaseAdapter_.dispose()},M);P=P||{};if("undefined"==typeof CodeMirror&&"function"==typeof require)try{CodeMirror=require("codemirror")}catch(t){console.log("CodeMirror not found")}return P.Firepad=function(){var i,o,t,e,s,a,c,l,h;if(P.RichTextCodeMirrorAdapter)return i=P.RichTextCodeMirrorAdapter,o=P.RichTextCodeMirror,t=P.RichTextToolbar,e=P.ScreenplayToolbar,s=P.FirebaseAdapter,a=P.EditorClient,c=P.EntityManager,l=P.AttributeConstants,(h=P.utils).makeEventEmitter(p),(p.fromCodeMirror=p).prototype.dispose=function(){this.zombie_=!0;var t=this.codeMirror_.getWrapperElement();this.firepadWrapper_.removeChild(t),this.firepadWrapper_.parentNode.replaceChild(t,this.firepadWrapper_),this.editor_.firepad=null,!this.codeMirror_||"richtext"!==this.codeMirror_.getOption("keyMap")&&"screenplay"!==this.codeMirror_.getOption("keyMap")||this.codeMirror_.setOption("keyMap","default"),this.firebaseAdapter_.dispose(),this.editorAdapter_.detach(),this.richTextCodeMirror_&&this.richTextCodeMirror_.detach()},p.prototype.setUserId=function(t){this.userId=t,this.firebaseAdapter_.setUserId(t)},p.prototype.setUserColor=function(t){this.userColor=t,this.firebaseAdapter_.setColor(t)},p.prototype.setShootingEvent=function(t){var e;"screenplay"===this.editorMode&&"tag"===this.screenplayMode?(this.shootingEvent=t,this.options_.shootingEvent=this.shootingEvent,e=this,setTimeout(function(){e.richTextCodeMirror_.setShootingEvent(e.shootingEvent),e.trigger("ready")},0)):console.log("Firepad: 'setShootingEvent' is only available for the screenplay tag mode")},p.prototype.onUsersChange=function(t){this.firebaseAdapter_.onUsersChange(t)},p.prototype.scrollToLine=function(t){this.richTextCodeMirror_.scrollToLine(t)},p.prototype.scrollToScene=function(t){this.richTextCodeMirror_.scrollToScene(t)},p.prototype.prepareForNewScene=function(){this.readOnly?console.log("Firepad: read only mode"):this.richTextCodeMirror_.prepareForNewScene()},p.prototype.onCursorChange=function(t){this.richTextCodeMirror_.onCursorChange(t)},p.prototype.onScenesChange=function(t){this.richTextCodeMirror_.onScenesChange(t)},p.prototype.onLockedScenesDeleteIntent=function(t){this.richTextCodeMirror_.onLockedScenesDeleteIntent(t)},p.prototype.onLockedSceneTitleEdited=function(t){this.richTextCodeMirror_.onLockedSceneTitleEdited(t)},p.prototype.onVisibleThreadsChange=function(t){this.richTextCodeMirror_.onVisibleThreadsChange(t)},p.prototype.getRevisionsFromRevision=function(t,e){this.firebaseAdapter_.getRevisionsFromRevision(t,e)},p.prototype.getDocumentAtRevisionForDiff=function(t,n){if(!t)return n("");var r=this;r.firebaseAdapter_.getDocumentAtRevision(t,function(t){if(null===t)return n(null);var e=null,e="screenplay"===r.editorMode?P.SerializeText(t):P.SerializeHtml(t,r.entityManager_);n(e)})},p.prototype.getText=function(){return this.assertReady_("getText"),this.richTextCodeMirror_.getText()},p.prototype.setText=function(t){this.assertReady_("setText"),this.readOnly?console.log("Firepad: read only mode"):(this.codeMirror_.getWrapperElement().setAttribute("style","display: none"),this.codeMirror_.setValue(""),this.insertText(0,t),this.codeMirror_.getWrapperElement().setAttribute("style",""),this.codeMirror_.refresh(),this.editorAdapter_.setCursor({position:0,selectionEnd:0}))},p.prototype.insertTextAtCursor=function(t){this.readOnly?console.log("Firepad: read only mode"):this.insertText(this.codeMirror_.indexFromPos(this.codeMirror_.getCursor()),t)},p.prototype.insertText=function(o,s){var a;this.assertReady_("insertText"),this.readOnly?console.log("Firepad: read only mode"):("[object Array]"!==Object.prototype.toString.call(s)&&(s=[s]),(a=this).codeMirror_.operation(function(){for(var t=0===o,e=P.textPiecesToInserts(t,s),n=0;n<e.length;n++){var r=e[n].string,i=e[n].attributes;a.richTextCodeMirror_.insertText(o,r,i),o+=r.length}}))},p.prototype.getOperationForSpan=function(t,e){for(var n=this.richTextCodeMirror_.getRange(t,e),r=this.richTextCodeMirror_.getAttributeSpans(t,e),i=0,o=new P.TextOperation,s=0;s<r.length;s++)o.insert(n.substr(i,r[s].length),r[s].attributes),i+=r[s].length;return o},p.prototype.getJson=function(t){var e;return"screenplay"===this.editorMode?(e=this.getOperationForSpan(0,this.codeMirror_.getValue().length),P.SerializeJson(e,t)):(console.log("Firepad: json serialization is only implemented for the screenplay format"),null)},p.prototype.getJsonForPdfMake=function(t){var e;return"screenplay"===this.editorMode?(e=this.getOperationForSpan(0,this.codeMirror_.getValue().length),P.SerializePdfMake(e,t)):(console.log("Firepad: json for pdfmake serialization is only implemented for the screenplay format"),null)},p.prototype.getTextFromSelection=function(){return this.richTextCodeMirror_.emptySelection_()&&this.richTextCodeMirror_.selectWord(),this.codeMirror_.getSelection()},p.prototype.getHtml=function(){return this.getHtmlFromRange(null,null)},p.prototype.getHtmlFromSelection=function(){var t=this.codeMirror_.getCursor("start"),e=this.codeMirror_.getCursor("end"),t=this.codeMirror_.indexFromPos(t),e=this.codeMirror_.indexFromPos(e);return this.getHtmlFromRange(t,e)},p.prototype.getHtmlFromRange=function(t,e){this.assertReady_("getHtmlFromRange");t=null!=t&&null!=e?this.getOperationForSpan(t,e):this.getOperationForSpan(0,this.codeMirror_.getValue().length);return P.SerializeHtml(t,this.entityManager_)},p.prototype.insertHtml=function(t,e){this.readOnly?console.log("Firepad: read only mode"):(e=P.ParseHtml(e,this.entityManager_),this.insertText(t,e))},p.prototype.insertHtmlAtCursor=function(t){this.readOnly?console.log("Firepad: read only mode"):this.insertHtml(this.codeMirror_.indexFromPos(this.codeMirror_.getCursor()),t)},p.prototype.setHtml=function(t){this.readOnly?console.log("Firepad: read only mode"):(t=P.ParseHtml(t,this.entityManager_),this.setText(t))},p.prototype.isHistoryEmpty=function(){return this.assertReady_("isHistoryEmpty"),this.firebaseAdapter_.isHistoryEmpty()},p.prototype.bold=function(){this.readOnly?console.log("Firepad: read only mode"):(this.richTextCodeMirror_.toggleAttribute(l.BOLD),this.codeMirror_.focus())},p.prototype.italic=function(){this.readOnly?console.log("Firepad: read only mode"):(this.richTextCodeMirror_.toggleAttribute(l.ITALIC),this.codeMirror_.focus())},p.prototype.underline=function(){this.readOnly?console.log("Firepad: read only mode"):(this.richTextCodeMirror_.toggleAttribute(l.UNDERLINE),this.codeMirror_.focus())},p.prototype.strike=function(){this.readOnly?console.log("Firepad: read only mode"):(this.richTextCodeMirror_.toggleAttribute(l.STRIKE),this.codeMirror_.focus())},p.prototype.fontSize=function(t){this.readOnly?console.log("Firepad: read only mode"):(this.richTextCodeMirror_.setAttribute(l.FONT_SIZE,t),this.codeMirror_.focus())},p.prototype.font=function(t){this.readOnly?console.log("Firepad: read only mode"):(this.richTextCodeMirror_.setAttribute(l.FONT,t),this.codeMirror_.focus())},p.prototype.color=function(t){this.readOnly?console.log("Firepad: read only mode"):(this.richTextCodeMirror_.setAttribute(l.COLOR,t),this.codeMirror_.focus())},p.prototype.highlight=function(){this.readOnly?console.log("Firepad: read only mode"):(this.richTextCodeMirror_.toggleAttribute(l.BACKGROUND_COLOR,"rgba(255,255,0,.65)"),this.codeMirror_.focus())},p.prototype.anchorThread=function(t){var e;if(!this.readOnly)return e=null,"screenplay"===this.editorMode&&"edit"===this.screenplayMode?(e=this.richTextCodeMirror_.anchorThread(t),this.codeMirror_.focus()):console.log("Firepad: 'anchorThread' is only available for the screenplay edit mode"),e;console.log("Firepad: read only mode")},p.prototype.setSelectedThread=function(t){var e;if(!this.readOnly)return e=null,"screenplay"===this.editorMode&&"edit"===this.screenplayMode?(e=this.richTextCodeMirror_.setSelectedThread(t),this.codeMirror_.focus()):console.log("Firepad: 'setSelectedThread' is only available for the screenplay edit mode"),e;console.log("Firepad: read only mode")},p.prototype.clearSelectedThread=function(t){var e;if(!this.readOnly)return e=null,"screenplay"===this.editorMode&&"edit"===this.screenplayMode?(e=this.richTextCodeMirror_.clearSelectedThread(t),this.codeMirror_.focus()):console.log("Firepad: 'clearSelectedThread' is only available for the screenplay edit mode"),e;console.log("Firepad: read only mode")},p.prototype.deleteThread=function(t){this.readOnly?console.log("Firepad: read only mode"):"screenplay"===this.editorMode&&"edit"===this.screenplayMode?(this.richTextCodeMirror_.deleteThread(t),this.codeMirror_.focus()):console.log("Firepad: 'deleteThread' is only available for the screenplay edit mode")},p.prototype.scrollToThread=function(t){"screenplay"===this.editorMode&&"edit"===this.screenplayMode?this.richTextCodeMirror_.scrollToThread(t):console.log("Firepad: 'scrollToThread' is only available for the screenplay edit mode")},p.prototype.getAddedDiffScenes=function(t){this.richTextCodeMirror_.getAddedDiffScenes(t)},p.prototype.getAddedDiffLines=function(t){"screenplay"===this.editorMode&&"tag"===this.screenplayMode?this.richTextCodeMirror_.getAddedDiffLines(t):console.log("Firepad: 'getDiffLines' is only available for the screenplay tag mode")},p.prototype.deleteAddedDiffs=function(t){this.readOnly?console.log("Firepad: read only mode"):"screenplay"===this.editorMode&&"tag"===this.screenplayMode?this.richTextCodeMirror_.deleteAddedDiffs(t):console.log("Firepad: 'deleteDiffs' is only available for the screenplay tag mode")},p.prototype.toggleElement=function(t,e){var n;if(!this.readOnly)return n=null,"screenplay"===this.editorMode&&"tag"===this.screenplayMode?(n=this.richTextCodeMirror_.toggleElement(t,e),this.codeMirror_.focus()):console.log("Firepad: 'toggleElement' is only available for the screenplay tag mode"),n;console.log("Firepad: read only mode")},p.prototype.deleteElement=function(t){this.readOnly?console.log("Firepad: read only mode"):"screenplay"===this.editorMode&&"tag"===this.screenplayMode?(this.richTextCodeMirror_.deleteElements(t),this.codeMirror_.focus()):console.log("Firepad: 'deleteElement' is only available for the screenplay tag mode")},p.prototype.deleteAllElements=function(){this.readOnly?console.log("Firepad: read only mode"):"screenplay"===this.editorMode&&"tag"===this.screenplayMode?(this.richTextCodeMirror_.deleteElements(),this.codeMirror_.focus()):console.log("Firepad: 'deleteAllElements' is only available for the screenplay tag mode")},p.prototype.getElements=function(){if("screenplay"===this.editorMode&&"tag"===this.screenplayMode)return this.richTextCodeMirror_.getElements();console.log("Firepad: 'getElements' is only available for the screenplay tag mode")},p.prototype.align=function(t){if(this.readOnly)console.log("Firepad: read only mode");else{if("left"!==t&&"center"!==t&&"right"!==t)throw new Error('align() must be passed "left", "center", or "right".');this.richTextCodeMirror_.setLineAttribute(l.LINE_ALIGN,t),this.codeMirror_.focus()}},p.prototype.setLineClass=function(t){var e,n,r;function i(){e.richTextCodeMirror_.setLineAttribute(l.LINE_CLASS,!1),e.richTextCodeMirror_.setLineAttribute(l.LINE_CLASS_TYPE,!1),e.richTextCodeMirror_.setLineAttribute(l.SCENE_CODE,!1),"pc-scene"===r&&setTimeout(function(){e.richTextCodeMirror_.recodeScenes()},0)}function o(){e.richTextCodeMirror_.setLineAttribute(l.LINE_CLASS,t),e.richTextCodeMirror_.setLineAttribute(l.LINE_CLASS_TYPE,"user"),"pc-scene"===t&&setTimeout(function(){e.richTextCodeMirror_.recodeScenes()},0)}this.readOnly?console.log("Firepad: read only mode"):"screenplay"===this.editorMode&&"edit"===this.screenplayMode?(n=(e=this).richTextCodeMirror_.getCurrentLineAttributes_(),r=n[l.LINE_CLASS],n[l.SCENE_ID]?console.log("Scene is locked"):((!t||r&&t&&r===t?i:("pc-scene"===r&&i(),o))(),setTimeout(function(){e.richTextCodeMirror_.updateToolbar()},100),e.codeMirror_.focus())):console.log("Firepad: 'setLineClass' is only available for the screenplay edit mode")},p.prototype.deleteScene=function(t,e){var n;this.readOnly?console.log("Firepad: read only mode"):"screenplay"===this.editorMode&&"edit"===this.screenplayMode?(n=this,setTimeout(function(){n.richTextCodeMirror_.deleteScene(t),e&&e()},0)):console.log("Firepad: 'deleteScene' is only available for the screenplay edit mode")},p.prototype.restoreScene=function(t,e){var n;this.readOnly?console.log("Firepad: read only mode"):"screenplay"===this.editorMode&&"edit"===this.screenplayMode?(n=this,setTimeout(function(){n.richTextCodeMirror_.restoreScene(t),e&&e()},0)):console.log("Firepad: 'restoreScene' is only available for the screenplay edit mode")},p.prototype.lockScene=function(n,r,i){var o;this.readOnly?console.log("Firepad: read only mode"):"screenplay"===this.editorMode&&"edit"===this.screenplayMode?(o=this,setTimeout(function(){var t,e=o.richTextCodeMirror_.lockScene(n,r);i&&(t=o.richTextCodeMirror_.getScenes(),i(t,e))},0)):console.log("Firepad: 'lockScene' is only available for the screenplay edit mode")},p.prototype.lockScenes=function(n,r,i){var o;this.readOnly?console.log("Firepad: read only mode"):"screenplay"===this.editorMode&&"edit"===this.screenplayMode?(o=this,2===arguments.length&&"function"==typeof r&&(i=r,r=[]),setTimeout(function(){var t,e=o.richTextCodeMirror_.lockScenes(n,r);i&&(t=o.richTextCodeMirror_.getScenes(),i(t,e))},0)):console.log("Firepad: 'lockScenes' is only available for the screenplay edit mode")},p.prototype.screenplayAutoFormat=function(){this.readOnly?console.log("Firepad: read only mode"):"screenplay"===this.editorMode&&"edit"===this.screenplayMode?this.richTextCodeMirror_.screenplayAutoFormat(!0):console.log("Firepad: 'screenplayAutoFormat' is only available for the screenplay edit mode")},p.prototype.orderedList=function(){this.readOnly?console.log("Firepad: read only mode"):(this.richTextCodeMirror_.toggleLineAttribute(l.LIST_TYPE,"o"),this.codeMirror_.focus())},p.prototype.unorderedList=function(){this.readOnly?console.log("Firepad: read only mode"):(this.richTextCodeMirror_.toggleLineAttribute(l.LIST_TYPE,"u"),this.codeMirror_.focus())},p.prototype.todo=function(){this.readOnly?console.log("Firepad: read only mode"):(this.richTextCodeMirror_.toggleTodo(),this.codeMirror_.focus())},p.prototype.newline=function(){this.readOnly?console.log("Firepad: read only mode"):(this.richTextCodeMirror_.newline(),"screenplay"===this.editorMode&&"edit"===this.screenplayMode&&this.richTextCodeMirror_.screenplayAutoFormat(!1,"newline"))},p.prototype.deleteLeft=function(){this.readOnly?console.log("Firepad: read only mode"):this.richTextCodeMirror_.deleteLeft()},p.prototype.deleteRight=function(){this.readOnly?console.log("Firepad: read only mode"):this.richTextCodeMirror_.deleteRight()},p.prototype.indent=function(){this.readOnly?console.log("Firepad: read only mode"):(this.richTextCodeMirror_.indent(),this.codeMirror_.focus())},p.prototype.unindent=function(){this.readOnly?console.log("Firepad: read only mode"):(this.richTextCodeMirror_.unindent(),this.codeMirror_.focus())},p.prototype.undo=function(){this.readOnly?console.log("Firepad: read only mode"):this.codeMirror_.undo()},p.prototype.redo=function(){this.readOnly?console.log("Firepad: read only mode"):this.codeMirror_.redo()},p.prototype.insertEntity=function(t,e,n){this.readOnly?console.log("Firepad: read only mode"):this.richTextCodeMirror_.insertEntityAtCursor(t,e,n)},p.prototype.insertEntityAt=function(t,e,n,r){this.readOnly?console.log("Firepad: read only mode"):this.richTextCodeMirror_.insertEntityAt(t,e,n,r)},p.prototype.registerEntity=function(t,e){this.readOnly?console.log("Firepad: read only mode"):this.entityManager_.register(t,e)},p.prototype.getOption=function(t,e){return t in this.options_?this.options_[t]:e},p.prototype.assertReady_=function(t){if(!this.ready_)throw new Error('You must wait for the "ready" event before calling '+t+".");if(this.zombie_)throw new Error("You can't use a Firepad after calling dispose()!  [called "+t+"]")},p.prototype.makeImageDialog_=function(){this.makeDialog_("img","Insert image url")},p.prototype.makeDialog_=function(n,t){var r=this,t=h.elt("input",null,{class:"firepad-dialog-input",id:n,type:"text",placeholder:t,autofocus:"autofocus"}),e=h.elt("a","Submit",{class:"firepad-btn",id:"submitbtn"}),i=(h.on(e,"click",h.stopEventAnd(function(){var t=document.getElementById("overlay"),e=(t.style.visibility="hidden",document.getElementById(n).value);null!==e&&r.insertEntity(n,{src:e}),r.firepadWrapper_.removeChild(t)})),h.elt("a","Cancel",{class:"firepad-btn"})),e=(h.on(i,"click",h.stopEventAnd(function(){var t=document.getElementById("overlay");t.style.visibility="hidden",r.firepadWrapper_.removeChild(t)})),h.elt("div",[e,i],{class:"firepad-btn-group"})),i=h.elt("div",[t,e],{class:"firepad-dialog-div"}),t=h.elt("div",[i],{class:"firepad-dialog",id:"overlay"});this.firepadWrapper_.appendChild(t)},p.prototype.addRichtextToolbar_=function(){this.toolbar=new t(this.imageInsertionUI),this.toolbar.on("undo",this.undo,this),this.toolbar.on("redo",this.redo,this),this.toolbar.on("bold",this.bold,this),this.toolbar.on("italic",this.italic,this),this.toolbar.on("underline",this.underline,this),this.toolbar.on("strike",this.strike,this),this.toolbar.on("font-size",this.fontSize,this),this.toolbar.on("font",this.font,this),this.toolbar.on("color",this.color,this),this.toolbar.on("left",function(){this.align("left")},this),this.toolbar.on("center",function(){this.align("center")},this),this.toolbar.on("right",function(){this.align("right")},this),this.toolbar.on("ordered-list",this.orderedList,this),this.toolbar.on("unordered-list",this.unorderedList,this),this.toolbar.on("todo-list",this.todo,this),this.toolbar.on("indent-increase",this.indent,this),this.toolbar.on("indent-decrease",this.unindent,this),this.toolbar.on("insert-image",this.makeImageDialog_,this),this.firepadWrapper_.insertBefore(this.toolbar.element(),this.firepadWrapper_.firstChild)},p.prototype.addScreenplayToolbar_=function(){this.toolbar=new e,this.toolbar.on("screenplay-scene",function(){this.setLineClass("pc-scene")},this),this.toolbar.on("screenplay-action",function(){this.setLineClass("pc-action")},this),this.toolbar.on("screenplay-character",function(){this.setLineClass("pc-character")},this),this.toolbar.on("screenplay-dialogue",function(){this.setLineClass("pc-dialogue")},this),this.toolbar.on("screenplay-parenthetical",function(){this.setLineClass("pc-parenthetical")},this),this.toolbar.on("screenplay-transition",function(){this.setLineClass("pc-transition")},this),this.toolbar.on("screenplay-act-start",function(){this.setLineClass("pc-act-start")},this),this.toolbar.on("screenplay-act-end",function(){this.setLineClass("pc-act-end")},this),this.toolbar.on("screenplay-centered",function(){this.setLineClass("pc-centered")},this),this.toolbar.on("screenplay-auto-format",this.screenplayAutoFormat,this),this.firepadWrapper_.insertBefore(this.toolbar.element(),this.firepadWrapper_.firstChild)},p.prototype.initializeRichtextKeyMap_=function(){function t(e){return function(t){setTimeout(function(){e.call(t.firepad)},0)}}CodeMirror.keyMap.richtext={"Ctrl-B":t(this.bold),"Cmd-B":t(this.bold),"Ctrl-I":t(this.italic),"Cmd-I":t(this.italic),"Ctrl-U":t(this.underline),"Cmd-U":t(this.underline),"Ctrl-H":t(this.highlight),"Cmd-H":t(this.highlight),Enter:t(this.newline),Delete:t(this.deleteRight),Backspace:t(this.deleteLeft),Tab:t(this.indent),"Shift-Tab":t(this.unindent),fallthrough:["default"]}},p.prototype.initializeScreenplayKeyMap_=function(){function t(e){return function(t){setTimeout(function(){e.call(t.firepad)},0)}}CodeMirror.keyMap.screenplay={Enter:t(this.newline),Delete:t(this.deleteRight),Backspace:t(this.deleteLeft),fallthrough:["default"]}},p;throw new Error("Oops! It looks like you're trying to include lib/firepad.js directly.  This is actually one of many source files that make up firepad.  You want dist/firepad.js instead.");function p(t,e,n){if(!(this instanceof p))return new p(t,e,n);if(!CodeMirror)throw new Error("Couldn't find CodeMirror.  Did you forget to include codemirror.js?");if(this.zombie_=!1,CodeMirror&&e instanceof CodeMirror){if(this.codeMirror_=this.editor_=e,""!==this.codeMirror_.getValue())throw new Error("Can't initialize Firepad with a CodeMirror instance that already contains text.")}else this.codeMirror_=this.editor_=new CodeMirror(e);e=this.codeMirror_.getWrapperElement();if(this.firepadWrapper_=h.elt("div",null,{class:"firepad"}),e.parentNode.replaceChild(this.firepadWrapper_,e),this.firepadWrapper_.appendChild(e),h.on(e,"dragstart",h.stopEvent),(this.editor_.firepad=this).options_=n||{},this.editorMode=this.getOption("mode","richtext"),this.toolbarEnabled=this.getOption("toolbar",!1),this.shortcutsEnabled=this.getOption("shortcuts",!1),this.imageInsertionUI=this.getOption("imageInsertionUI",!0),this.defaultText=this.getOption("defaultText",null),this.userId=this.getOption("userId",t.push().key),this.userColor=this.getOption("userColor",function(t){for(var e=1,n=0;n<t.length;n++)e=17*(e+t.charCodeAt(n))%360;return function(t,e,n){if(0===e)return d(n,n,n);function r(t){return t<0&&(t+=1),1<t&&--t,6*t<1?o+6*(i-o)*t:2*t<1?i:3*t<2?o+6*(i-o)*(2/3-t):o}var i=n<.5?n*(1+e):n+e-e*n,o=2*n-i;return d(r(t+1/3),r(t),r(t-1/3))}(e/360,1,.75)}(this.userId)),this.userName=this.getOption("userName",""),this.screenplayMode=this.getOption("screenplayMode","edit"),this.shootingEvent=this.getOption("shootingEvent",null),this.showComments=this.getOption("showComments",!1),this.showDiffAdditions=this.getOption("showDiffAdditions",!1),this.readOnly=this.getOption("readOnly",!1),this.options_.cssPrefix="firepad-",this.options_.screenplayMode=this.screenplayMode,this.options_.shootingEvent=this.shootingEvent,this.options_.showComments=this.showComments,this.options_.showDiffAdditions=this.showDiffAdditions,"richtext"===this.editorMode)this.firepadWrapper_.className+=" firepad-richtext";else{if("screenplay"!==this.editorMode)throw new Error("Invalid editor mode. The allowed values are 'richtext' and 'screenplay'.");if(this.firepadWrapper_.className+=" firepad-screenplay","tag"===this.screenplayMode){if(!this.shootingEvent)throw new Error("A shootingEvent is required for the screenplay tag mode.");this.codeMirror_.setOption("readOnly",!0),this.shortcutsEnabled=!1}}this.readOnly&&this.codeMirror_.setOption("readOnly",!0),this.shortcutsEnabled&&("richtext"===this.editorMode?(CodeMirror.keyMap.richtext||this.initializeRichtextKeyMap_(),this.codeMirror_.setOption("keyMap","richtext")):"screenplay"===this.editorMode&&(CodeMirror.keyMap.screenplay||this.initializeScreenplayKeyMap_(),this.codeMirror_.setOption("keyMap","screenplay"))),this.toolbarEnabled&&(this.firepadWrapper_.className+=" firepad-with-toolbar","richtext"===this.editorMode?this.addRichtextToolbar_():"screenplay"===this.editorMode&&this.addScreenplayToolbar_()),this.codeMirror_&&this.codeMirror_.refresh(),this.entityManager_=new c,this.firebaseAdapter_=new s(t,null,this.userId,this.userColor,this.userName),this.richTextCodeMirror_=new o(this.codeMirror_,this.entityManager_,this.firebaseAdapter_,this.options_),this.editorAdapter_=new i(this.richTextCodeMirror_),this.client_=new a(this.firebaseAdapter_,this.editorAdapter_);var r=this;this.firebaseAdapter_.on("cursor",function(){r.trigger.apply(r,["cursor"].concat([].slice.call(arguments)))}),this.codeMirror_&&this.richTextCodeMirror_.on("newLine",function(){r.trigger.apply(r,["newLine"].concat([].slice.call(arguments)))}),this.firebaseAdapter_.on("ready",function(){r.ready_=!0,r.richTextCodeMirror_.setReady(),r.defaultText&&r.isHistoryEmpty()&&r.setText(r.defaultText),"screenplay"===r.editorMode&&"tag"===r.screenplayMode?setTimeout(function(){r.richTextCodeMirror_.filterScenes(),r.trigger("ready")},0):r.trigger("ready")}),this.client_.on("synced",function(t){r.trigger("synced",t)}),"Microsoft Internet Explorer"==navigator.appName&&navigator.userAgent.match(/MSIE 8\./)&&(window.onload=function(){var t=document.getElementsByTagName("head")[0],e=document.createElement("style");e.type="text/css",e.styleSheet.cssText=":before,:after{content:none !important;}",t.appendChild(e),setTimeout(function(){t.removeChild(e)},0)})}function d(t,e,n){function r(t){t=Math.round(255*t).toString(16);return 1===t.length?"0"+t:t}return"#"+r(t)+r(e)+r(n)}}(),P.Firepad.Formatting=P.Formatting,P.Firepad.Text=P.Text,P.Firepad.Entity=P.Entity,P.Firepad.LineFormatting=P.LineFormatting,P.Firepad.Line=P.Line,P.Firepad.TextOperation=P.TextOperation,P.Firepad.Headless=P.Headless,P.Firepad.RichTextCodeMirrorAdapter=P.RichTextCodeMirrorAdapter,P.Firepad},this);