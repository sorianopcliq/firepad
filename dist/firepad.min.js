/*!
 * Firepad is an open-source, collaborative code and text editor. It was designed
 * to be embedded inside larger applications. Since it uses Firebase as a backend,
 * it requires no server-side code and can be added to any web app simply by
 * including a couple JavaScript files.
 *
 * Firepad 0.0.0
 * http://www.firepad.io/
 * License: MIT
 * Copyright: 2014 Firebase
 * With code from ot.js (Copyright 2012-2013 Tim Baumann)
 */
!function(a,b,c){"undefined"!=typeof module&&module.exports?module.exports=b():"function"==typeof c.define&&c.define.amd?define(b):c[a]=b()}("Firepad",function(){var a={title_page:/^((?:title|credit|author[s]?|source|notes|draft date|date|contact|copyright)\:)/gim,scene_heading:/^((?:\*{0,3}_?)?(?:(?:int|ext|i\/e|est)[. ]).+)|^(?:\.(?!\.+))(.+)/i,scene_number:/( *#(.+)# *)/,transition:/^((?:FADE (?:TO BLACK|OUT)|CUT TO BLACK)\.|.+ TO\:)|^(?:> *)(.+)/,character:/^[A-Z*_][0-9A-Z (._\-',)]*[A-Z*_)]$/,dialogue:/^([A-Z*_][0-9A-Z (._\-',)]*[A-Z*_)])(\^?)?(?:\n(?!\n+))([\s\S]+)/,parenthetical:/^(\(.+\))$/,lyrics:/^~(.+)/g,action:/^(.+)/g,centered:/^(?:> *)(.+)(?: *<)(\n.+)*/g,section:/^(#+)(?: *)(.*)/,synopsis:/^(?:\=(?!\=+) *)(.*)/,note:/^(?:\[{2}(?!\[+))(.+)(?:\]{2}(?!\[+))$/,note_inline:/(?:\[{2}(?!\[+))([\s\S]+?)(?:\]{2}(?!\[+))/g,boneyard:/(^\/\*|^\*\/)$/g,page_break:/^\={3,}$/,line_break:/^ {2}$/,emphasis:/(_|\*{1,3}|_\*{1,3}|\*{1,3}_)(.+)(_|\*{1,3}|_\*{1,3}|\*{1,3}_)/g,bold_italic_underline:/(_{1}\*{3}(?=.+\*{3}_{1})|\*{3}_{1}(?=.+_{1}\*{3}))(.+?)(\*{3}_{1}|_{1}\*{3})/g,bold_underline:/(_{1}\*{2}(?=.+\*{2}_{1})|\*{2}_{1}(?=.+_{1}\*{2}))(.+?)(\*{2}_{1}|_{1}\*{2})/g,italic_underline:/(?:_{1}\*{1}(?=.+\*{1}_{1})|\*{1}_{1}(?=.+_{1}\*{1}))(.+?)(\*{1}_{1}|_{1}\*{1})/g,bold_italic:/(\*{3}(?=.+\*{3}))(.+?)(\*{3})/g,bold:/(\*{2}(?=.+\*{2}))(.+?)(\*{2})/g,italic:/(\*{1}(?=.+\*{1}))(.+?)(\*{1})/g,underline:/(_{1}(?=.+_{1}))(.+?)(_{1})/g,splitter:/\n{2,}/g,cleaner:/^\n+|\n+$/,standardizer:/\r\n|\r/g,whitespacer:/^\t+|^ {3,}/gm},b={clean:function(b){return b.replace(a.boneyard,"\n$1\n").replace(a.standardizer,"\n").replace(a.cleaner,"").replace(a.whitespacer,"")},tokenize:function(c,d){var e,f,g,h,i,j,k,l,m,n,o=c.map(function(a){return a.text}).join("\n"),p=b.clean(o).split(a.splitter),q=0;n=d?{}:[];for(j in p){e=p[j];var r=[],s=!1;if(!s&&a.title_page.test(e)){for(f=e.replace(a.title_page,"\n$1").split(a.splitter),k=0,l=f.length;l>k;k++)g=f[k].replace(a.cleaner,"").split(/\:\n*/),r.push({type:g[0].trim().toLowerCase().replace(" ","_"),text:g[1].trim()});s=!0}if(!s&&(f=e.match(a.scene_heading))&&(h=f[1]||f[2],h.indexOf("  ")!==h.length-2&&((i=h.match(a.scene_number))&&(i=i[2],h=h.replace(a.scene_number,"")),r.push({type:"scene_heading",text:h,scene_number:i||void 0})),s=!0),!s&&(f=e.match(a.centered))&&(r.push({type:"centered",text:f[0].replace(/>|</g,"")}),s=!0),!s&&(f=e.match(a.transition))&&(r.push({type:"transition",text:f[1]||f[2]}),s=!0),!s&&(f=e.match(a.dialogue))&&f[1].indexOf("  ")!==f[1].length-2){var t=f[3]+"\n";for(g=t.split(/(?:^|\n+)(\(.+\))(?:\n+)/),dual_diaglogue=!!f[2],dual_diaglogue&&r.push({type:"dual_dialogue_begin"}),r.push({type:"dialogue_begin",dual:dual_diaglogue?"right":m?"left":void 0}),r.push({type:"character",text:f[1].trim()}),k=0,l=g.length;l>k;k++)if(h=g[k].trim(),h.length>0){var u=a.parenthetical.test(h)?"parenthetical":"dialogue";r.push({type:u,text:h})}r.push({type:"dialogue_end"}),dual_diaglogue&&r.push({type:"dual_dialogue_end"}),s=!0}!s&&(f=e.match(a.section))&&(r.push({type:"section",text:f[2],depth:f[1].length}),s=!0),!s&&(f=e.match(a.synopsis))&&(r.push({type:"synopsis",text:f[1]}),s=!0),!s&&(f=e.match(a.note))&&(r.push({type:"note",text:f[1]}),s=!0),!s&&(f=e.match(a.boneyard))&&(r.push({type:"/"===f[0][0]?"boneyard_begin":"boneyard_end"}),s=!0),!s&&a.page_break.test(e)&&(r.push({type:"page_break"}),s=!0),!s&&a.line_break.test(e)&&(r.push({type:"line_break"}),s=!0),!s&&a.lyrics.test(e)&&(r.push({type:"lyrics",text:e}),s=!0),s||r.push({type:"action",text:e});for(var v=0;v<r.length;v++){var w=r[v];if(w.text)for(var x=w.text.split("\n"),y=0;y<x.length;y++){var z=x[y],A=JSON.parse(JSON.stringify(w)),B=!1,C=null;for(A.text=z;!B&&q<c.length;)c[q].text.indexOf(z)>=0&&(C=c[q].line,B=!0),q++;d?C&&(n[C]=A):n.push(A)}else d||n.push(w)}}return n}},c={parse:function(a,d,e){void 0===e&&"function"==typeof d?(e=d,d={}):void 0===d&&(d={});var f={tokens:d.tokens||!1,html:d.html||!1},g={};if(f.tokens)g.tokens=b.tokenize(a,!0);else if(f.html){var h,i=[],j=[],k=b.tokenize(a,!1);for(var l in k)switch(h=k[l],h.text=c.lexer(h.text),h.type){case"title":i.push("<h1>"+h.text+"</h1>");break;case"credit":i.push('<p class="credit">'+h.text+"</p>");break;case"author":i.push('<p class="authors">'+h.text+"</p>");break;case"authors":i.push('<p class="authors">'+h.text+"</p>");break;case"source":i.push('<p class="source">'+h.text+"</p>");break;case"notes":i.push('<p class="notes">'+h.text+"</p>");break;case"draft_date":i.push('<p class="draft-date">'+h.text+"</p>");break;case"date":i.push('<p class="date">'+h.text+"</p>");break;case"contact":i.push('<p class="contact">'+h.text+"</p>");break;case"copyright":i.push('<p class="copyright">'+h.text+"</p>");break;case"scene_heading":j.push("<h2"+(h.scene_number?' id="'+h.scene_number+'">':">")+h.text+"</h2>");break;case"transition":j.push('<p class="transition">'+h.text+"</p>");break;case"dual_dialogue_begin":j.push('<div class="dual-dialogue">');break;case"dialogue_begin":j.push('<div class="dialogue'+(h.dual?" "+h.dual:"")+'">');break;case"character":j.push("<h4>"+h.text.replace(/^@/,"")+"</h4>");break;case"parenthetical":j.push('<p class="parenthetical">'+h.text+"</p>");break;case"dialogue":j.push("<p>"+h.text+"</p>");break;case"dialogue_end":j.push("</div>");break;case"dual_dialogue_end":j.push("</div>");break;case"section":j.push('<p class="section" data-depth="'+h.depth+'">'+h.text+"</p>");break;case"synopsis":j.push('<p class="synopsis">'+h.text+"</p>");break;case"note":j.push("<!-- "+h.text+" -->");break;case"boneyard_begin":j.push("<!-- ");break;case"boneyard_end":j.push(" -->");break;case"lyrics":j.push('<p class="lyrics">'+h.text+"</p>");break;case"action":j.push("<p>"+h.text+"</p>");break;case"centered":j.push('<p class="centered">'+h.text+"</p>");break;case"page_break":j.push("<hr />");break;case"line_break":j.push("<br />")}g.title_page_html=i.join(""),g.script_html=j.join("")}return"function"==typeof e?e(g):g},lexer:function(b){if(b){var c,d,e={note:"<!-- $1 -->",line_break:"<br />",bold_italic_underline:'<strong><em><span style="text-decoration:underline">$2</span></em></strong>',bold_underline:'<strong><span style="text-decoration:underline">$2</span></strong>',italic_underline:'<em><span style="text-decoration:underline">$1</span></em>',bold_italic:"<strong><em>$2</em></strong>",bold:"<strong>$2</strong>",italic:"<em>$2</em>",underline:'<span style="text-decoration:underline">$2</span>'},f=["bold_italic_underline","bold_underline","italic_underline","bold_italic","bold","italic","underline"];b=b.replace(a.note_inline,e.note).replace(/\\\*/g,"[star]").replace(/\\_/g,"[underline]").replace(/\n/g,e.line_break);for(var g in f)c=f[g],d=a[c],d.test(b)&&(b=b.replace(d,e[c]));return b.replace(/\[star\]/g,"*").replace(/\[underline\]/g,"_").trim()}}},d=d||{};d.utils={},d.utils.makeEventEmitter=function(a,b){a.prototype.allowedEvents_=b,a.prototype.on=function(a,b,c){this.validateEventType_(a),this.eventListeners_=this.eventListeners_||{},this.eventListeners_[a]=this.eventListeners_[a]||[],this.eventListeners_[a].push({callback:b,context:c})},a.prototype.off=function(a,b){this.validateEventType_(a),this.eventListeners_=this.eventListeners_||{};for(var c=this.eventListeners_[a]||[],d=0;d<c.length;d++)if(c[d].callback===b)return void c.splice(d,1)},a.prototype.trigger=function(a){this.eventListeners_=this.eventListeners_||{};for(var b=this.eventListeners_[a]||[],c=0;c<b.length;c++)b[c].callback.apply(b[c].context,Array.prototype.slice.call(arguments,1))},a.prototype.validateEventType_=function(a){if(this.allowedEvents_){for(var b=!1,c=0;c<this.allowedEvents_.length;c++)if(this.allowedEvents_[c]===a){b=!0;break}if(!b)throw new Error('Unknown event "'+a+'"')}}},d.utils.elt=function(a,b,c){var e=document.createElement(a);if("string"==typeof b)d.utils.setTextContent(e,b);else if(b)for(var f=0;f<b.length;++f)e.appendChild(b[f]);for(var g in c||{})e.setAttribute(g,c[g]);return e},d.utils.setTextContent=function(a,b){a.innerHTML="",a.appendChild(document.createTextNode(b))},d.utils.on=function(a,b,c,d){a.addEventListener?a.addEventListener(b,c,d||!1):a.attachEvent&&a.attachEvent("on"+b,c)},d.utils.off=function(a,b,c,d){a.removeEventListener?a.removeEventListener(b,c,d||!1):a.detachEvent&&a.detachEvent("on"+b,c)},d.utils.preventDefault=function(a){a.preventDefault?a.preventDefault():a.returnValue=!1},d.utils.stopPropagation=function(a){a.stopPropagation?a.stopPropagation():a.cancelBubble=!0},d.utils.stopEvent=function(a){d.utils.preventDefault(a),d.utils.stopPropagation(a)},d.utils.stopEventAnd=function(a){return function(b){return a(b),d.utils.stopEvent(b),!1}},d.utils.trim=function(a){return a.replace(/^\s+/g,"").replace(/\s+$/g,"")},d.utils.stringEndsWith=function(a,b){for(var c="string"==typeof b?[b]:b,d=0;d<c.length;d++){var b=c[d];if(-1!==a.indexOf(b,a.length-b.length))return!0}return!1},d.utils.assert=function(a,b){if(!a)throw new Error(b||"assertion error")},d.utils.log=function(){if("undefined"!=typeof console&&"undefined"!=typeof console.log){for(var a=["Firepad:"],b=0;b<arguments.length;b++)a.push(arguments[b]);console.log.apply(console,a)}};var d=d||{};d.Span=function(){function a(a,b){this.pos=a,this.length=b}return a.prototype.end=function(){return this.pos+this.length},a}();var d=d||{};d.TextOp=function(){function a(a){this.type=a,this.chars=null,this.text=null,this.attributes=null,"insert"===a?(this.text=arguments[1],b.assert("string"==typeof this.text),this.attributes=arguments[2]||{},b.assert("object"==typeof this.attributes)):"delete"===a?(this.chars=arguments[1],b.assert("number"==typeof this.chars)):"retain"===a&&(this.chars=arguments[1],b.assert("number"==typeof this.chars),this.attributes=arguments[2]||{},b.assert("object"==typeof this.attributes))}var b=d.utils;return a.prototype.isInsert=function(){return"insert"===this.type},a.prototype.isDelete=function(){return"delete"===this.type},a.prototype.isRetain=function(){return"retain"===this.type},a.prototype.equals=function(a){return this.type===a.type&&this.text===a.text&&this.chars===a.chars&&this.attributesEqual(a.attributes)},a.prototype.attributesEqual=function(a){for(var b in this.attributes)if(this.attributes[b]!==a[b])return!1;for(b in a)if(this.attributes[b]!==a[b])return!1;return!0},a.prototype.hasEmptyAttributes=function(){var a=!0;for(var b in this.attributes){a=!1;break}return a},a}();var d=d||{};d.TextOperation=function(){"use strict";function a(){return this&&this.constructor===a?(this.ops=[],this.baseLength=0,void(this.targetLength=0)):new a}function b(a){var b=a.ops;switch(b.length){case 1:return b[0];case 2:return b[0].isRetain()?b[1]:b[1].isRetain()?b[0]:null;case 3:if(b[0].isRetain()&&b[2].isRetain())return b[1]}return null}function c(a){return a.ops[0].isRetain()?a.ops[0].chars:0}var e=d.TextOp,f=d.utils;return a.prototype.equals=function(a){if(this.baseLength!==a.baseLength)return!1;if(this.targetLength!==a.targetLength)return!1;if(this.ops.length!==a.ops.length)return!1;for(var b=0;b<this.ops.length;b++)if(!this.ops[b].equals(a.ops[b]))return!1;return!0},a.prototype.retain=function(a,b){if("number"!=typeof a||0>a)throw new Error("retain expects a positive integer.");if(0===a)return this;this.baseLength+=a,this.targetLength+=a,b=b||{};var c=this.ops.length>0?this.ops[this.ops.length-1]:null;return c&&c.isRetain()&&c.attributesEqual(b)?c.chars+=a:this.ops.push(new e("retain",a,b)),this},a.prototype.insert=function(a,b){if("string"!=typeof a)throw new Error("insert expects a string");if(""===a)return this;b=b||{},this.targetLength+=a.length;var c=this.ops.length>0?this.ops[this.ops.length-1]:null,d=this.ops.length>1?this.ops[this.ops.length-2]:null;return c&&c.isInsert()&&c.attributesEqual(b)?c.text+=a:c&&c.isDelete()?d&&d.isInsert()&&d.attributesEqual(b)?d.text+=a:(this.ops[this.ops.length-1]=new e("insert",a,b),this.ops.push(c)):this.ops.push(new e("insert",a,b)),this},a.prototype["delete"]=function(a){if("string"==typeof a&&(a=a.length),"number"!=typeof a||0>a)throw new Error("delete expects a positive integer or a string");if(0===a)return this;this.baseLength+=a;var b=this.ops.length>0?this.ops[this.ops.length-1]:null;return b&&b.isDelete()?b.chars+=a:this.ops.push(new e("delete",a)),this},a.prototype.isNoop=function(){return 0===this.ops.length||1===this.ops.length&&this.ops[0].isRetain()&&this.ops[0].hasEmptyAttributes()},a.prototype.clone=function(){for(var b=new a,c=0;c<this.ops.length;c++)this.ops[c].isRetain()?b.retain(this.ops[c].chars,this.ops[c].attributes):this.ops[c].isInsert()?b.insert(this.ops[c].text,this.ops[c].attributes):b["delete"](this.ops[c].chars);return b},a.prototype.toString=function(){var a=Array.prototype.map||function(a){for(var b=this,c=[],d=0,e=b.length;e>d;d++)c[d]=a(b[d]);return c};return a.call(this.ops,function(a){return a.isRetain()?"retain "+a.chars:a.isInsert()?"insert '"+a.text+"'":"delete "+a.chars}).join(", ")},a.prototype.toJSON=function(){for(var a=[],b=0;b<this.ops.length;b++)this.ops[b].hasEmptyAttributes()||a.push(this.ops[b].attributes),"retain"===this.ops[b].type?a.push(this.ops[b].chars):"insert"===this.ops[b].type?a.push(this.ops[b].text):"delete"===this.ops[b].type&&a.push(-this.ops[b].chars);return 0===a.length&&a.push(0),a},a.fromJSON=function(b){for(var c=new a,d=0,e=b.length;e>d;d++){var g=b[d],h={};"object"==typeof g&&(h=g,d++,g=b[d]),"number"==typeof g?g>0?c.retain(g,h):c["delete"](-g):(f.assert("string"==typeof g),c.insert(g,h))}return c},a.prototype.apply=function(a,b,c){var d=this;if(b=b||[],c=c||[],a.length!==d.baseLength)throw new Error("The operation's base length must be equal to the string's length.");for(var e,g,h=[],i=0,j=0,k=this.ops,l=0,m=k.length;m>l;l++){var n=k[l];if(n.isRetain()){if(j+n.chars>a.length)throw new Error("Operation can't retain more characters than are left in the string.");for(h[i++]=a.slice(j,j+n.chars),e=0;e<n.chars;e++){var o=b[j+e]||{},p={};for(g in o)p[g]=o[g],f.assert(p[g]!==!1);for(g in n.attributes)n.attributes[g]===!1?delete p[g]:p[g]=n.attributes[g],f.assert(p[g]!==!1);c.push(p)}j+=n.chars}else if(n.isInsert())for(h[i++]=n.text,e=0;e<n.text.length;e++){var q={};for(g in n.attributes)q[g]=n.attributes[g],f.assert(q[g]!==!1);c.push(q)}else j+=n.chars}if(j!==a.length)throw new Error("The operation didn't operate on the whole string.");var r=h.join("");return f.assert(r.length===c.length),r},a.prototype.invert=function(b){for(var c=0,d=new a,e=this.ops,f=0,g=e.length;g>f;f++){var h=e[f];h.isRetain()?(d.retain(h.chars),c+=h.chars):h.isInsert()?d["delete"](h.text.length):(d.insert(b.slice(c,c+h.chars)),c+=h.chars)}return d},a.prototype.compose=function(b){function c(a,b,c){var d,e={};for(d in a)e[d]=a[d];for(d in b)c&&b[d]===!1?delete e[d]:e[d]=b[d];return e}var d=this;if(d.targetLength!==b.baseLength)throw new Error("The base length of the second operation has to be the target length of the first operation");for(var e,f=new a,g=d.clone().ops,h=b.clone().ops,i=0,j=0,k=g[i++],l=h[j++];;){if("undefined"==typeof k&&"undefined"==typeof l)break;if(k&&k.isDelete())f["delete"](k.chars),k=g[i++];else if(l&&l.isInsert())f.insert(l.text,l.attributes),l=h[j++];else{if("undefined"==typeof k)throw new Error("Cannot compose operations: first operation is too short.");if("undefined"==typeof l)throw new Error("Cannot compose operations: first operation is too long.");if(k.isRetain()&&l.isRetain())e=c(k.attributes,l.attributes),k.chars>l.chars?(f.retain(l.chars,e),k.chars-=l.chars,l=h[j++]):k.chars===l.chars?(f.retain(k.chars,e),k=g[i++],l=h[j++]):(f.retain(k.chars,e),l.chars-=k.chars,k=g[i++]);else if(k.isInsert()&&l.isDelete())k.text.length>l.chars?(k.text=k.text.slice(l.chars),l=h[j++]):k.text.length===l.chars?(k=g[i++],l=h[j++]):(l.chars-=k.text.length,k=g[i++]);else if(k.isInsert()&&l.isRetain())e=c(k.attributes,l.attributes,!0),k.text.length>l.chars?(f.insert(k.text.slice(0,l.chars),e),k.text=k.text.slice(l.chars),l=h[j++]):k.text.length===l.chars?(f.insert(k.text,e),k=g[i++],l=h[j++]):(f.insert(k.text,e),l.chars-=k.text.length,k=g[i++]);else{if(!k.isRetain()||!l.isDelete())throw new Error("This shouldn't happen: op1: "+JSON.stringify(k)+", op2: "+JSON.stringify(l));k.chars>l.chars?(f["delete"](l.chars),k.chars-=l.chars,l=h[j++]):k.chars===l.chars?(f["delete"](l.chars),k=g[i++],l=h[j++]):(f["delete"](k.chars),l.chars-=k.chars,k=g[i++])}}}return f},a.prototype.shouldBeComposedWith=function(a){if(this.isNoop()||a.isNoop())return!0;var d=c(this),e=c(a),f=b(this),g=b(a);return f&&g?f.isInsert()&&g.isInsert()?d+f.text.length===e:f.isDelete()&&g.isDelete()?e+g.chars===d||d===e:!1:!1},a.prototype.shouldBeComposedWithInverted=function(a){if(this.isNoop()||a.isNoop())return!0;var d=c(this),e=c(a),f=b(this),g=b(a);return f&&g?f.isInsert()&&g.isInsert()?d+f.text.length===e||d===e:f.isDelete()&&g.isDelete()?e+g.chars===d:!1:!1},a.transformAttributes=function(a,b){var c,d={},e={},g={};for(c in a)g[c]=!0;for(c in b)g[c]=!0;for(c in g){var h=a[c],i=b[c];f.assert(null!=h||null!=i),null==h?e[c]=i:null==i?d[c]=h:h===i||(d[c]=h)}return[d,e]},a.transform=function(b,c){if(b.baseLength!==c.baseLength)throw new Error("Both operations have to have the same base length");for(var d=new a,e=new a,f=b.clone().ops,g=c.clone().ops,h=0,i=0,j=f[h++],k=g[i++];;){if("undefined"==typeof j&&"undefined"==typeof k)break;if(j&&j.isInsert())d.insert(j.text,j.attributes),e.retain(j.text.length),j=f[h++];else if(k&&k.isInsert())d.retain(k.text.length),e.insert(k.text,k.attributes),k=g[i++];else{if("undefined"==typeof j)throw new Error("Cannot transform operations: first operation is too short.");if("undefined"==typeof k)throw new Error("Cannot transform operations: first operation is too long.");var l;if(j.isRetain()&&k.isRetain()){var m=a.transformAttributes(j.attributes,k.attributes);j.chars>k.chars?(l=k.chars,j.chars-=k.chars,k=g[i++]):j.chars===k.chars?(l=k.chars,j=f[h++],k=g[i++]):(l=j.chars,k.chars-=j.chars,j=f[h++]),d.retain(l,m[0]),e.retain(l,m[1])}else if(j.isDelete()&&k.isDelete())j.chars>k.chars?(j.chars-=k.chars,k=g[i++]):j.chars===k.chars?(j=f[h++],k=g[i++]):(k.chars-=j.chars,j=f[h++]);else if(j.isDelete()&&k.isRetain())j.chars>k.chars?(l=k.chars,j.chars-=k.chars,k=g[i++]):j.chars===k.chars?(l=k.chars,j=f[h++],k=g[i++]):(l=j.chars,k.chars-=j.chars,j=f[h++]),d["delete"](l);else{if(!j.isRetain()||!k.isDelete())throw new Error("The two operations aren't compatible");j.chars>k.chars?(l=k.chars,j.chars-=k.chars,k=g[i++]):j.chars===k.chars?(l=j.chars,j=f[h++],k=g[i++]):(l=j.chars,k.chars-=j.chars,j=f[h++]),e["delete"](l)}}}return[d,e]},a.prototype.transform=function(b){return a.transform(this,b)},a}();var d=d||{};d.AnnotationList=function(){function a(a,b){if(!a)throw new Error("AnnotationList assertion failed"+(b?": "+b:""))}function b(a,b){this.pos=a,this.length=b.length,this.annotation=b.annotation,this.attachedObject_=b.attachedObject}function c(a,b){this.pos=a,this.length=b.length,this.annotation=b.annotation,this.node_=b}function e(a){this.head_=new f(0,h),this.changeHandler_=a}function f(a,b){this.length=a,this.annotation=b,this.attachedObject=null,this.next=null}var g=d.Span;b.prototype.getAttachedObject=function(){return this.attachedObject_},c.prototype.attachObject=function(a){this.node_.attachedObject=a};var h={equals:function(){return!1}};return e.prototype.insertAnnotatedSpan=function(b,c){this.wrapOperation_(new g(b.pos,0),function(d,e){a(!e||null===e.next);var g=new f(b.length,c);if(e){a(b.pos>d&&b.pos<d+e.length);var i=new f(0,h);return i.next=new f(b.pos-d,e.annotation),i.next.next=g,g.next=new f(d+e.length-b.pos,e.annotation),i.next}return g})},e.prototype.removeSpan=function(b){0!==b.length&&this.wrapOperation_(b,function(c,d){a(null!==d);var e=new f(0,h),g=e;for(b.pos>c&&(g.next=new f(b.pos-c,d.annotation),g=g.next);b.end()>c+d.length;)c+=d.length,d=d.next;var i=c+d.length-b.end();return i>0&&(g.next=new f(i,d.annotation)),e.next})},e.prototype.updateSpan=function(b,c){0!==b.length&&this.wrapOperation_(b,function(d,e){a(null!==e);var g=new f(0,h),i=g,j=d,k=b.pos-j;for(a(k<e.length),k>0&&(i.next=new f(k,e.annotation),i=i.next,j+=i.length);null!==e&&b.end()>=d+e.length;){var l=d+e.length-j;i.next=new f(l,c(e.annotation,l)),i=i.next,d+=e.length,e=e.next,j=d}var m=b.end()-j;return m>0&&(a(m<e.length),i.next=new f(m,c(e.annotation,m)),i=i.next,j+=i.length,i.next=new f(d+e.length-j,e.annotation)),g.next})},e.prototype.wrapOperation_=function(a,d){if(a.pos<0)throw new Error("Span start cannot be negative.");var e,g=[],h=[],i=this.getAffectedNodes_(a);null!==i.start?(e=i.end.next,i.end.next=null):e=i.succ;var j=d(i.startPos,i.start),k=!1,l=!1;if(j){this.mergeNodesWithSameAnnotations_(j);var m;for(i.pred&&i.pred.annotation.equals(j.annotation)?(k=!0,j.length+=i.pred.length,i.beforePred.next=j,m=i.predPos):(i.beforeStart.next=j,m=i.startPos);j.next;)h.push(new c(m,j)),m+=j.length,j=j.next;i.succ&&i.succ.annotation.equals(j.annotation)?(j.length+=i.succ.length,l=!0,j.next=i.succ.next):j.next=e,h.push(new c(m,j))}else i.pred&&i.succ&&i.pred.annotation.equals(i.succ.annotation)?(k=!0,l=!0,j=new f(i.pred.length+i.succ.length,i.pred.annotation),i.beforePred.next=j,j.next=i.succ.next,h.push(new c(i.startPos-i.pred.length,j))):i.beforeStart.next=e;k&&g.push(new b(i.predPos,i.pred));for(var n=i.startPos,o=i.start;null!==o;)g.push(new b(n,o)),n+=o.length,o=o.next;l&&g.push(new b(n,i.succ)),this.changeHandler_(g,h)},e.prototype.getAffectedNodes_=function(a){for(var b={},c=null,d=this.head_,e=d.next,f=0;null!==e&&a.pos>=f+e.length;)f+=e.length,c=d,d=e,e=e.next;if(null===e&&(0!==a.length||a.pos!==f))throw new Error("Span start exceeds the bounds of the AnnotationList.");for(b.startPos=f,0===a.length&&a.pos===f?b.start=null:b.start=e,b.beforeStart=d,f===a.pos&&f>0?(b.pred=d,b.predPos=f-d.length,b.beforePred=c):b.pred=null;null!==e&&a.end()>f;)f+=e.length,d=e,e=e.next;if(a.end()>f)throw new Error("Span end exceeds the bounds of the AnnotationList.");return 0===a.length&&a.end()===f?b.end=null:b.end=d,b.succ=f===a.end()?e:null,b},e.prototype.mergeNodesWithSameAnnotations_=function(a){if(a)for(var b=null,c=a;c;)b&&b.annotation.equals(c.annotation)?(b.length+=c.length,b.next=c.next):b=c,c=c.next},e.prototype.forEach=function(a){for(var b=this.head_.next;null!==b;)a(b.length,b.annotation,b.attachedObject),b=b.next},e.prototype.getAnnotatedSpansForPos=function(a){for(var c=0,d=this.head_.next,e=null;null!==d&&c+d.length<=a;)c+=d.length,e=d,d=d.next;if(null===d&&c!==a)throw new Error("pos exceeds the bounds of the AnnotationList");var f=[];return c===a&&e&&f.push(new b(c-e.length,e)),d&&f.push(new b(c,d)),f},e.prototype.getAnnotatedSpansForSpan=function(a){if(0===a.length)return[];for(var b=[],c=this.getAffectedNodes_(a),d=c.startPos,e=c.start;null!==e&&d<a.end();){var f=Math.max(d,a.pos),h=Math.min(d+e.length,a.end()),i=new g(f,h-f);i.annotation=e.annotation,b.push(i),d+=e.length,e=e.next}return b},e.prototype.getAllAnnotations=function(){for(var a=[],b=this.head_.next;null!==b;)a.push(b.annotation),b=b.next;return a},e.prototype.count=function(){for(var b=0,c=this.head_.next,d=null;null!==c;)d&&a(!d.annotation.equals(c.annotation)),d=c,c=c.next,b++;return b},f.prototype.clone=function(){var a=new f(this.spanLength,this.annotation);return a.next=this.next,a},e}();var d=d||{};d.Cursor=function(){"use strict";function a(a,b){this.position=a,this.selectionEnd=b}return a.fromJSON=function(b){return new a(b.position,b.selectionEnd)},a.prototype.equals=function(a){return this.position===a.position&&this.selectionEnd===a.selectionEnd},a.prototype.compose=function(a){return a},a.prototype.transform=function(b){function c(a){for(var c=a,d=b.ops,e=0,f=b.ops.length;f>e&&(d[e].isRetain()?a-=d[e].chars:d[e].isInsert()?c+=d[e].text.length:(c-=Math.min(a,d[e].chars),a-=d[e].chars),!(0>a));e++);return c}var d=c(this.position);return this.position===this.selectionEnd?new a(d,d):new a(d,c(this.selectionEnd))},a}();var d=d||{};d.FirebaseAdapter=function(){function a(a,b,c,d,e){this.ref_=a,this.ready_=!1,this.firebaseCallbacks_=[],this.zombie_=!1,this.deviceId_=b||a.push().key,this.color_=d||null,this.name_=e||null,this.document_=new f,this.revision_=0,this.pendingReceivedRevisions_={},c||(c=a.push().key),this.setUserId(c);var g=a.root.child(".info/connected"),h=this;this.firebaseOn_(g,"value",function(a){a.val()===!0&&h.initializeUserData_()},this),this.on("ready",function(){h.monitorCursors_()}),setTimeout(function(){h.monitorHistory_()},0)}function b(a,b){if(!a)throw new Error(b||"assertion error")}function c(a){if(0>a)return"";if(0===a)return"A0";for(var b="";a>0;){var c=a%i.length;b=i[c]+b,a-=c,a/=i.length}var d=i[b.length+9];return d+b}function e(a){b(a.length>0&&a[0]===i[a.length+8]);for(var c=0,d=1;d<a.length;d++)c*=i.length,c+=i.indexOf(a[d]);return c}"undefined"==typeof firebase&&"function"==typeof require&&"function"!=typeof Firebase&&(firebase=require("firebase"));var f=d.TextOperation,g=d.utils,h=100;g.makeEventEmitter(a,["ready","cursor","operation","ack","retry"]),a.prototype.dispose=function(){var a=this;return this.ready_?(this.removeFirebaseCallbacks_(),this.userRef_&&(this.userRef_.child("id").remove(),this.userRef_.child("cursor").remove(),this.userRef_.child("color").remove(),this.userRef_.child("name").remove()),this.ref_=null,this.document_=null,void(this.zombie_=!0)):void this.on("ready",function(){a.dispose()})},a.prototype.setUserId=function(a){this.userRef_&&(this.userRef_.child("id").remove(),this.userRef_.child("id").onDisconnect().cancel(),this.userRef_.child("cursor").remove(),this.userRef_.child("cursor").onDisconnect().cancel(),this.userRef_.child("color").remove(),this.userRef_.child("color").onDisconnect().cancel(),this.userRef_.child("name").remove(),this.userRef_.child("name").onDisconnect().cancel()),this.userId_=a,this.userRef_=this.ref_.child("users").child(this.deviceId_),this.initializeUserData_()},a.prototype.onUsersChange=function(a){this.onUsersChangeCallback=a},a.prototype.isHistoryEmpty=function(){return b(this.ready_,"Not ready yet."),0===this.revision_},a.prototype.sendOperation=function(a,d){function e(a,b){f.ref_.child("history").child(a).transaction(function(a){return null===a?b:void 0},function(c,h,i){if(c){if("disconnect"!==c.message)throw g.log("Transaction failure!",c),c;f.sent_&&f.sent_.id===a?setTimeout(function(){e(a,b)},0):d&&d(c,!1)}else d&&d(null,h)},!1)}var f=this;if(!this.ready_)return void this.on("ready",function(){f.trigger("retry")});b(this.document_.targetLength===a.baseLength,"sendOperation() called with invalid operation.");var h=c(this.revision_);this.sent_={id:h,op:a},e(h,{a:f.userId_,o:a.toJSON(),t:firebase.database.ServerValue.TIMESTAMP})},a.prototype.setId=function(a){this.userRef_.child("id").set(a),this.userId_=a},a.prototype.sendCursor=function(a){this.userRef_.child("cursor").set(a),this.cursor_=a},a.prototype.setColor=function(a){this.userRef_.child("color").set(a),this.color_=a},a.prototype.setName=function(a){this.userRef_.child("name").set(a),this.name_=a},a.prototype.getDocument=function(){return this.document_},a.prototype.registerCallbacks=function(a){for(var b in a)this.on(b,a[b])},a.prototype.getLastRevision=function(){return c(this.revision_-1)},a.prototype.getRevisionsFromRevision=function(a,b){var c=this,d=[];a||(a="A0"),c.ref_.child("history").startAt(null,a).once("value",function(a){c.zombie_||(a.forEach(function(a){var b=a.val();d.push({id:a.key,author:b.a,timestamp:parseInt(b.t,10)})}),b(d))})},a.prototype.getDocumentAtRevision=function(a,b){function d(a,b,d){var e=g.ref_.child("history").startAt(null,a).endAt(null,b);e.once("value",function(a){if(!g.zombie_){a.forEach(function(a){i[a.key]=a.val()});for(var b=j,e=c(b);null!=i[e];){var k=i[e],l=null;try{l=f.fromJSON(k.o)}catch(m){return console.log(m),d(null)}l&&(h=h.compose(l)),delete i[e],b++,e=c(b)}d(h)}})}var g=this,h=new f,i=[],j=0;a||(a=c(0)),g.ref_.child("checkpoint").once("value",function(f){if(!g.zombie_){var h=f.child("id").val(),k=f.child("o").val(),l=f.child("a").val();return null!=k&&null!=h&&null!==l&&a>h?(i[h]={o:k,a:l},j=e(h),d(c(j+1),a,b)):d(c(0),a,b)}})},a.prototype.saveOmittedScene=function(a,b){this.ref_.child("omittedScenes").child(a).set(b)},a.prototype.getOmittedScene=function(a,b){this.ref_.child("omittedScenes").child(a).once("value",function(a){b(a.val())},function(a){b(null)})},a.prototype.deleteOmittedScene=function(a){this.ref_.child("omittedScenes").child(a).remove()},a.prototype.initializeUserData_=function(){this.userRef_.child("id").onDisconnect().remove(),this.userRef_.child("cursor").onDisconnect().remove(),this.userRef_.child("color").onDisconnect().remove(),this.userRef_.child("name").onDisconnect().remove(),this.userRef_.set({id:this.userId_||null,cursor:this.cursor_||null,color:this.color_||null,name:this.name_||null})},a.prototype.monitorCursors_=function(){function a(){c.onUsersChangeCallback&&b.once("value").then(function(a){var b=a.val(),d={};for(var e in b)if(b.hasOwnProperty(e)&&"backend"!==e){var f=b[e].id;f&&!d[f]&&(d[f]={name:b[e].name,color:b[e].color})}c.users=d,c.onUsersChangeCallback(d)})}var b=this.ref_.child("users"),c=this;this.firebaseOn_(b,"child_added",function(b){var d=b.key,e=b.val();c.trigger("cursor",d,e.id,e.cursor,e.color,e.name),a()}),this.firebaseOn_(b,"child_changed",function(b){var d=b.key,e=b.val();c.trigger("cursor",d,e.id,e.cursor,e.color,e.name),!e.id||c.users&&c.users[e.id]&&c.users[e.id].name===e.name&&c.users[e.id].color===e.color||a()}),this.firebaseOn_(b,"child_removed",function(b){var d=b.key;c.trigger("cursor",d),a()})},a.prototype.monitorHistory_=function(){var a=this;this.ref_.child("checkpoint").once("value",function(b){if(!a.zombie_){var c=b.child("id").val(),d=b.child("o").val(),f=b.child("a").val();null!=d&&null!=c&&null!==f?(a.pendingReceivedRevisions_[c]={o:d,a:f},a.checkpointRevision_=e(c),a.monitorHistoryStartingAt_(a.checkpointRevision_+1)):(a.checkpointRevision_=0,a.monitorHistoryStartingAt_(a.checkpointRevision_))}})},a.prototype.monitorHistoryStartingAt_=function(a){var b=this.ref_.child("history").startAt(null,c(a)),d=this;setTimeout(function(){d.firebaseOn_(b,"child_added",function(a){var b=a.key;d.pendingReceivedRevisions_[b]=a.val(),d.ready_&&d.handlePendingReceivedRevisions_()}),b.once("value",function(){d.handleInitialRevisions_()})},0)},a.prototype.handleInitialRevisions_=function(){b(!this.ready_,"Should not be called multiple times."),this.revision_=this.checkpointRevision_;for(var a=c(this.revision_),d=this.pendingReceivedRevisions_;null!=d[a];){var e=this.parseRevision_(d[a]);e?this.document_=this.document_.compose(e.operation):g.log("Invalid operation.",this.ref_.toString(),a,d[a]),delete d[a],this.revision_++,a=c(this.revision_)}this.trigger("operation",this.document_),this.ready_=!0;var f=this;setTimeout(function(){f.trigger("ready")},0)},a.prototype.handlePendingReceivedRevisions_=function(){for(var a=this.pendingReceivedRevisions_,b=c(this.revision_),d=!1;null!=a[b];){this.revision_++;var e=this.parseRevision_(a[b]);e?(this.document_=this.document_.compose(e.operation),this.sent_&&b===this.sent_.id?this.sent_.op.equals(e.operation)&&e.author===this.userId_?(this.revision_%h===0&&this.saveCheckpoint_(),this.sent_=null,this.trigger("ack")):(d=!0,this.trigger("operation",e.operation)):this.trigger("operation",e.operation)):g.log("Invalid operation.",this.ref_.toString(),b,a[b]),delete a[b],b=c(this.revision_)}d&&(this.sent_=null,this.trigger("retry"))},a.prototype.parseRevision_=function(a){if("object"!=typeof a)return null;if("string"!=typeof a.a||"object"!=typeof a.o)return null;var b=null;try{b=f.fromJSON(a.o)}catch(c){return null}return b.baseLength!==this.document_.targetLength?null:{author:a.a,operation:b}},a.prototype.saveCheckpoint_=function(){this.ref_.child("checkpoint").set({a:this.userId_,o:this.document_.toJSON(),id:c(this.revision_-1)})},a.prototype.firebaseOn_=function(a,b,c,d){return this.firebaseCallbacks_.push({ref:a,eventType:b,callback:c,context:d}),a.on(b,c,d),c},a.prototype.firebaseOff_=function(a,b,c,d){
a.off(b,c,d);for(var e=0;e<this.firebaseCallbacks_.length;e++){var f=this.firebaseCallbacks_[e];if(f.ref===a&&f.eventType===b&&f.callback===c&&f.context===d){this.firebaseCallbacks_.splice(e,1);break}}},a.prototype.removeFirebaseCallbacks_=function(){for(var a=0;a<this.firebaseCallbacks_.length;a++){var b=this.firebaseCallbacks_[a];b.ref.off(b.eventType,b.callback,b.context)}this.firebaseCallbacks_=[]};var i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";return a}();var d=d||{};d.RichTextToolbar=function(){function a(a){this.imageInsertionUI=a,this.element_=this.makeElement_()}var b=d.utils;return b.makeEventEmitter(a,["bold","italic","underline","strike","font","font-size","color","left","center","right","unordered-list","ordered-list","todo-list","indent-increase","indent-decrease","undo","redo","insert-image"]),a.prototype.element=function(){return this.element_},a.prototype.makeButton_=function(a,c){var d=this;c=c||a;var e=b.elt("a",[b.elt("span","",{"class":"firepad-tb-"+c})],{"class":"firepad-btn"});return b.on(e,"click",b.stopEventAnd(function(){d.trigger(a)})),e},a.prototype.makeElement_=function(){var a=this,c=this.makeFontDropdown_(),d=this.makeFontSizeDropdown_(),e=this.makeColorDropdown_(),f=[b.elt("div",[c],{"class":"firepad-btn-group"}),b.elt("div",[d],{"class":"firepad-btn-group"}),b.elt("div",[e],{"class":"firepad-btn-group"}),b.elt("div",[a.makeButton_("bold"),a.makeButton_("italic"),a.makeButton_("underline"),a.makeButton_("strike","strikethrough")],{"class":"firepad-btn-group"}),b.elt("div",[a.makeButton_("unordered-list","list-2"),a.makeButton_("ordered-list","numbered-list"),a.makeButton_("todo-list","list")],{"class":"firepad-btn-group"}),b.elt("div",[a.makeButton_("indent-decrease"),a.makeButton_("indent-increase")],{"class":"firepad-btn-group"}),b.elt("div",[a.makeButton_("left","paragraph-left"),a.makeButton_("center","paragraph-center"),a.makeButton_("right","paragraph-right")],{"class":"firepad-btn-group"}),b.elt("div",[a.makeButton_("undo"),a.makeButton_("redo")],{"class":"firepad-btn-group"})];a.imageInsertionUI&&f.push(b.elt("div",[a.makeButton_("insert-image")],{"class":"firepad-btn-group"}));var g=b.elt("div",f,{"class":"firepad-toolbar-wrapper"}),h=b.elt("div",null,{"class":"firepad-toolbar"});return h.appendChild(g),h},a.prototype.makeFontDropdown_=function(){for(var a=["Arial","Comic Sans MS","Courier New","Impact","Times New Roman","Verdana"],c=[],d=0;d<a.length;d++){var e=b.elt("span",a[d]);e.setAttribute("style","font-family:"+a[d]),c.push({content:e,value:a[d]})}return this.makeDropdown_("Font","font",c)},a.prototype.makeFontSizeDropdown_=function(){for(var a=[9,10,12,14,18,24,32,42],c=[],d=0;d<a.length;d++){var e=b.elt("span",a[d].toString());e.setAttribute("style","font-size:"+a[d]+"px; line-height:"+(a[d]-6)+"px;"),c.push({content:e,value:a[d]})}return this.makeDropdown_("Size","font-size",c,"px")},a.prototype.makeColorDropdown_=function(){for(var a=["black","red","green","blue","yellow","cyan","magenta","grey"],c=[],d=0;d<a.length;d++){var e=b.elt("div");e.className="firepad-color-dropdown-item",e.setAttribute("style","background-color:"+a[d]),c.push({content:e,value:a[d]})}return this.makeDropdown_("Color","color",c)},a.prototype.makeDropdown_=function(a,c,d,e){function f(){l||(k.style.display="block",b.on(document,"click",g,!0),l=!0)}function g(){l&&(k.style.display="",b.off(document,"click",g,!0),l=!1),m=!0,setTimeout(function(){m=!1},0)}function h(a,d){"object"!=typeof a&&(a=document.createTextNode(String(a)));var f=b.elt("a",[a]);b.on(f,"click",b.stopEventAnd(function(){g(),i.trigger(c,d+e)})),k.appendChild(f)}e=e||"";var i=this,j=b.elt("a",a+" ▾",{"class":"firepad-btn firepad-dropdown"}),k=b.elt("ul",[],{"class":"firepad-dropdown-menu"});j.appendChild(k);for(var l=!1,m=!1,n=0;n<d.length;n++){var o=d[n].content,p=d[n].value;h(o,p)}return b.on(j,"click",b.stopEventAnd(function(){m||f()})),j},a}();var d=d||{};d.ScreenplayToolbar=function(){function a(){this.element_=this.makeElement_()}var b=d.utils;return b.makeEventEmitter(a,["screenplay-scene","screenplay-action","screenplay-character","screenplay-dialogue","screenplay-parenthetical","screenplay-transition","screenplay-act-start","screenplay-act-end","screenplay-auto-format","screenplay-centered"]),a.prototype.element=function(){return this.element_},a.prototype.makeButton_=function(a,c){var d=this;c=c||a;var e=b.elt("a",[b.elt("span","",{"class":"firepad-tb-"+c})],{"class":"firepad-btn"});return b.on(e,"click",b.stopEventAnd(function(){d.trigger(a)})),e},a.prototype.makeElement_=function(){var a=this,c=[b.elt("div",[a.makeButton_("screenplay-scene","pc-scene"),a.makeButton_("screenplay-action","pc-action"),a.makeButton_("screenplay-character","pc-character"),a.makeButton_("screenplay-dialogue","pc-dialogue"),a.makeButton_("screenplay-parenthetical","pc-parenthetical"),a.makeButton_("screenplay-transition","pc-transition"),a.makeButton_("screenplay-act-start","pc-act-start"),a.makeButton_("screenplay-act-end","pc-act-end")],{"class":"firepad-btn-group"}),b.elt("div",[a.makeButton_("screenplay-centered","pc-centered")],{"class":"firepad-btn-group"}),b.elt("div",[a.makeButton_("screenplay-auto-format","pc-auto-format")],{"class":"firepad-btn-group"})],d=b.elt("div",c,{"class":"firepad-toolbar-wrapper"}),e=b.elt("div",null,{"class":"firepad-toolbar"});return e.appendChild(d),e},a}();var d=d||{};d.WrappedOperation=function(){"use strict";function a(a,b){this.wrapped=a,this.meta=b}function b(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c])}function c(a,c){if(a&&"object"==typeof a){if("function"==typeof a.compose)return a.compose(c);var d={};return b(a,d),b(c,d),d}return c}function d(a,b){return a&&"object"==typeof a&&"function"==typeof a.transform?a.transform(b):a}return a.prototype.apply=function(){return this.wrapped.apply.apply(this.wrapped,arguments)},a.prototype.invert=function(){var b=this.meta;return new a(this.wrapped.invert.apply(this.wrapped,arguments),b&&"object"==typeof b&&"function"==typeof b.invert?b.invert.apply(b,arguments):b)},a.prototype.compose=function(b){return new a(this.wrapped.compose(b.wrapped),c(this.meta,b.meta))},a.transform=function(b,c){var e=b.wrapped.transform(c.wrapped);return[new a(e[0],d(b.meta,c.wrapped)),new a(e[1],d(c.meta,b.wrapped))]},a.prototype.transform=function(b){return a.transform(this,b)},a}();var d=d||{};d.UndoManager=function(){"use strict";function a(a){this.maxItems=a||50,this.state=c,this.dontCompose=!1,this.undoStack=[],this.redoStack=[]}function b(a,b){for(var c=[],d=b.constructor,e=a.length-1;e>=0;e--){var f=d.transform(a[e],b);"function"==typeof f[0].isNoop&&f[0].isNoop()||c.push(f[0]),b=f[1]}return c.reverse()}var c="normal",d="undoing",e="redoing";return a.prototype.add=function(a,b){if(this.state===d)this.redoStack.push(a),this.dontCompose=!0;else if(this.state===e)this.undoStack.push(a),this.dontCompose=!0;else{var c=this.undoStack;!this.dontCompose&&b&&c.length>0?c.push(a.compose(c.pop())):(c.push(a),c.length>this.maxItems&&c.shift()),this.dontCompose=!1,this.redoStack=[]}},a.prototype.transform=function(a){this.undoStack=b(this.undoStack,a),this.redoStack=b(this.redoStack,a)},a.prototype.performUndo=function(a){if(this.state=d,0===this.undoStack.length)throw new Error("undo not possible");a(this.undoStack.pop()),this.state=c},a.prototype.performRedo=function(a){if(this.state=e,0===this.redoStack.length)throw new Error("redo not possible");a(this.redoStack.pop()),this.state=c},a.prototype.canUndo=function(){return 0!==this.undoStack.length},a.prototype.canRedo=function(){return 0!==this.redoStack.length},a.prototype.isUndoing=function(){return this.state===d},a.prototype.isRedoing=function(){return this.state===e},a}();var d=d||{};d.Client=function(){"use strict";function a(){this.state=e}function b(){}function c(a){this.outstanding=a}function d(a,b){this.outstanding=a,this.buffer=b}a.prototype.setState=function(a){this.state=a},a.prototype.applyClient=function(a){this.setState(this.state.applyClient(this,a))},a.prototype.applyServer=function(a){this.setState(this.state.applyServer(this,a))},a.prototype.serverAck=function(){this.setState(this.state.serverAck(this))},a.prototype.serverRetry=function(){this.setState(this.state.serverRetry(this))},a.prototype.sendOperation=function(a){throw new Error("sendOperation must be defined in child class")},a.prototype.applyOperation=function(a){throw new Error("applyOperation must be defined in child class")},a.Synchronized=b,b.prototype.applyClient=function(a,b){return a.sendOperation(b),new c(b)},b.prototype.applyServer=function(a,b){return a.applyOperation(b),this},b.prototype.serverAck=function(a){throw new Error("There is no pending operation.")},b.prototype.serverRetry=function(a){throw new Error("There is no pending operation.")};var e=new b;return a.AwaitingConfirm=c,c.prototype.applyClient=function(a,b){return new d(this.outstanding,b)},c.prototype.applyServer=function(a,b){var d=this.outstanding.transform(b);return a.applyOperation(d[1]),new c(d[0])},c.prototype.serverAck=function(a){return e},c.prototype.serverRetry=function(a){return a.sendOperation(this.outstanding),this},a.AwaitingWithBuffer=d,d.prototype.applyClient=function(a,b){var c=this.buffer.compose(b);return new d(this.outstanding,c)},d.prototype.applyServer=function(a,b){var c=this.outstanding.transform(b),e=this.buffer.transform(c[1]);return a.applyOperation(e[1]),new d(c[0],e[0])},d.prototype.serverRetry=function(a){var b=this.outstanding.compose(this.buffer);return a.sendOperation(b),new c(b)},d.prototype.serverAck=function(a){return a.sendOperation(this.buffer),new c(this.buffer)},a}();var d=d||{};d.EditorClient=function(){"use strict";function a(a,b){this.cursorBefore=a,this.cursorAfter=b}function b(a,b){this.id=a,this.editorAdapter=b}function c(a,b){g.call(this),this.serverAdapter=a,this.editorAdapter=b,this.undoManager=new i,this.clients={};var c=this;this.editorAdapter.registerCallbacks({change:function(a,b){c.onChange(a,b)},cursorActivity:function(){c.onCursorActivity()},blur:function(){c.onBlur()},focus:function(){c.onFocus()}}),this.editorAdapter.registerUndo(function(){c.undo()}),this.editorAdapter.registerRedo(function(){c.redo()}),this.serverAdapter.registerCallbacks({ack:function(){c.serverAck(),c.focused&&c.state instanceof g.Synchronized&&(c.updateCursor(),c.sendCursor(c.cursor)),c.emitStatus()},retry:function(){c.serverRetry()},operation:function(a){c.applyServer(a)},cursor:function(a,b,d,e,f){if(c.serverAdapter.deviceId_!==a&&c.state instanceof g.Synchronized){var i=c.getClientObject(a);b&&i.setUserId(b),e&&i.setColor(e),f&&i.setName(f),d?i.updateCursor(h.fromJSON(d)):i.removeCursor()}}})}function e(a,b){function c(){}c.prototype=b.prototype,a.prototype=new c,a.prototype.constructor=a}function f(a){return a[a.length-1]}var g=d.Client,h=d.Cursor,i=d.UndoManager,j=d.WrappedOperation;return a.prototype.invert=function(){return new a(this.cursorAfter,this.cursorBefore)},a.prototype.compose=function(b){return new a(this.cursorBefore,b.cursorAfter)},a.prototype.transform=function(b){return new a(this.cursorBefore?this.cursorBefore.transform(b):null,this.cursorAfter?this.cursorAfter.transform(b):null)},b.prototype.setUserId=function(a){this.userId=a},b.prototype.setColor=function(a){this.color=a},b.prototype.setName=function(a){this.name=a},b.prototype.updateCursor=function(a){this.removeCursor(),this.cursor=a,this.marks=this.editorAdapter.setOtherCursor(this.id,this.cursor,this.color,this.userId,this.name)},b.prototype.removeCursor=function(){if(this.marks)for(var a=0;a<this.marks.length;a++)this.marks[a].clear()},e(c,g),c.prototype.getClientObject=function(a){var c=this.clients[a];return c?c:this.clients[a]=new b(a,this.editorAdapter)},c.prototype.applyUnredo=function(a){this.undoManager.add(this.editorAdapter.invertOperation(a)),this.editorAdapter.applyOperation(a.wrapped),this.cursor=a.meta.cursorAfter,this.cursor&&this.editorAdapter.setCursor(this.cursor),this.applyClient(a.wrapped)},c.prototype.undo=function(){var a=this;this.undoManager.canUndo()&&this.undoManager.performUndo(function(b){a.applyUnredo(b)})},c.prototype.redo=function(){var a=this;this.undoManager.canRedo()&&this.undoManager.performRedo(function(b){a.applyUnredo(b)})},c.prototype.onChange=function(b,c){var d=this.cursor;this.updateCursor();var e=this.undoManager.undoStack.length>0&&c.shouldBeComposedWithInverted(f(this.undoManager.undoStack).wrapped),g=new a(this.cursor,d);this.undoManager.add(new j(c,g),e),this.applyClient(b)},c.prototype.updateCursor=function(){this.cursor=this.editorAdapter.getCursor()},c.prototype.onCursorActivity=function(){var a=this.cursor;this.updateCursor(),!this.focused||a&&this.cursor.equals(a)||this.sendCursor(this.cursor)},c.prototype.onBlur=function(){this.cursor=null,this.sendCursor(null),this.focused=!1},c.prototype.onFocus=function(){this.focused=!0,this.onCursorActivity()},c.prototype.sendCursor=function(a){this.state instanceof g.AwaitingWithBuffer||this.serverAdapter.sendCursor(a)},c.prototype.sendOperation=function(a){this.serverAdapter.sendOperation(a),this.emitStatus()},c.prototype.applyOperation=function(a){this.editorAdapter.applyOperation(a),this.updateCursor(),this.undoManager.transform(new j(a,null))},c.prototype.emitStatus=function(){var a=this;setTimeout(function(){a.trigger("synced",a.state instanceof g.Synchronized)},0)},c}(),d.utils.makeEventEmitter(d.EditorClient,["synced"]);var d=d||{};d.AttributeConstants={BOLD:"b",ITALIC:"i",UNDERLINE:"u",STRIKE:"s",FONT:"f",FONT_SIZE:"fs",COLOR:"c",BACKGROUND_COLOR:"bc",ENTITY_SENTINEL:"ent",ELEMENT:"e",ELEMENT_COLOR:"ec",THREAD:"t",DIFF:"d",LINE_SENTINEL:"l",LINE_INDENT:"li",LINE_ALIGN:"la",LIST_TYPE:"lt",LINE_CLASS:"lc",LINE_CLASS_TYPE:"lct",SCENE_CODE:"sc",SCENE_ID:"si",SCENE_OMITTED:"so"},d.sentinelConstants={LINE_SENTINEL_CHARACTER:"",ENTITY_SENTINEL_CHARACTER:"",TRIGGER_AUTOFORMAT_SENTINEL_CHARACTER:""};var d=d||{};d.EntityManager=function(){function a(){this.entities_={};var a=["src","alt","width","height","style","class"];this.register("img",{render:function(a){b.assert(a.src,"image entity should have 'src'!");for(var c=["src","alt","width","height","style","class"],d="<img ",e=0;e<c.length;e++){var f=c[e];f in a&&(d+=" "+f+'="'+a[f]+'"')}return d+=">"},fromElement:function(b){for(var c={},d=0;d<a.length;d++){var e=a[d];b.hasAttribute(e)&&(c[e]=b.getAttribute(e))}return c}})}var b=d.utils;return a.prototype.register=function(a,b){d.utils.assert(b.render,"Entity options should include a 'render' function!"),d.utils.assert(b.fromElement,"Entity options should include a 'fromElement' function!"),this.entities_[a]=b},a.prototype.renderToElement=function(a,b){return this.tryRenderToElement_(a,"render",b)},a.prototype.exportToElement=function(a){var b=this.tryRenderToElement_(a,"export")||this.tryRenderToElement_(a,"getHtml")||this.tryRenderToElement_(a,"render");return b.setAttribute("data-firepad-entity",a.type),b},a.prototype.updateElement=function(a,b){var c=a.type,d=a.info;this.entities_[c]&&"undefined"!=typeof this.entities_[c].update&&this.entities_[c].update(d,b)},a.prototype.fromElement=function(a){var b=a.getAttribute("data-firepad-entity");if(b||(b=a.nodeName.toLowerCase()),b&&this.entities_[b]){var c=this.entities_[b].fromElement(a);return new d.Entity(b,c)}},a.prototype.tryRenderToElement_=function(a,b,c){var e=a.type,f=a.info;if(this.entities_[e]&&this.entities_[e][b]){var g=d.document||window&&window.document,h=this.entities_[e][b](f,c,g);if(h){if("string"==typeof h){var i=(d.document||document).createElement("div");return i.innerHTML=h,i.childNodes[0]}if("object"==typeof h)return d.utils.assert("undefined"!=typeof h.nodeType,"Error rendering "+e+" entity.  render() function must return an html string or a DOM element."),h}}},a.prototype.entitySupportsUpdate=function(a){return this.entities_[a]&&this.entities_[a].update},a}();var d=d||{};d.Entity=function(){function a(b,c){return this instanceof a?(this.type=b,void(this.info=c||{})):new a(b,c)}var b=d.AttributeConstants,c=b.ENTITY_SENTINEL,e=c+"_";return a.prototype.toAttributes=function(){var a={};a[c]=this.type;for(var b in this.info)a[e+b]=this.info[b];return a},a.fromAttributes=function(b){var d=b[c],f={};for(var g in b)0===g.indexOf(e)&&(f[g.substr(e.length)]=b[g]);return new a(d,f)},a}();var d=d||{};if("undefined"==typeof CodeMirror&&"function"==typeof require)try{CodeMirror=require("codemirror")}catch(e){console.log("CodeMirror not found")}"undefined"!=typeof CodeMirror&&(CodeMirror.TextMarker.prototype.getClassName=function(){return this.className||""}),d.RichTextCodeMirror=function(){function b(a,b,c,d){this.ready_=!1,this.codeMirror=a,this.options_=d||{},this.entityManager_=b,this.firebaseAdapter_=c,this.currentAttributes_=null,this.styleElements=[],this.shootingEvent=this.options_.shootingEvent||null,this.scenesFilterElements=[],this.showComments=this.options_.showComments||!1,this.showDiffAdditions=this.options_.showDiffAdditions||!1,this.setupDynamicStyles(),this.setupAnnotations(),n(this,"onCodeMirrorBeforeChange_"),n(this,"onCodeMirrorChange_"),n(this,"onCursorActivity_"),n(this,"onCopyOrCut_"),n(this,"onPaste_"),n(this,"onScroll_"),parseInt(CodeMirror.version)>=4?this.codeMirror.on("changes",this.onCodeMirrorChange_):this.codeMirror.on("change",this.onCodeMirrorChange_),this.codeMirror.on("beforeChange",this.onCodeMirrorBeforeChange_),this.codeMirror.on("cursorActivity",this.onCursorActivity_),this.codeMirror.on("copy",this.onCopyOrCut_),this.codeMirror.on("cut",this.onCopyOrCut_),this.codeMirror.on("paste",this.onPaste_),this.codeMirror.on("scroll",this.onScroll_),this.changeId_=0,this.outstandingChanges_={},this.dirtyLines_=[];var e=this;setTimeout(function(){e.reportScenesStatus()},1e3)}function e(a){this.attributes=a||{}}function f(a){var b=parseInt(a);if(isNaN(b)){for(var c="",d=!1,e=0;e<a.length-1&&!d;){var f=a.substring(e,e+1);if("Z"!==f){var g=String.fromCharCode(1+f.charCodeAt(0));c+=g,d=!0}else c+="A";e++}return d||(c+="A"),c+=a.substring(e)}return(b+1).toString()}function g(a){var b=parseInt(a);if(isNaN(b)){for(var c="",d=0;d<a.length-1;)c+="A",d++;return c+="A"+a.substring(d)}return"A"+a}function h(a){return a.replace(new RegExp("["+w+x+"]","g"),"")}function i(a,b){return a.line-b.line||a.ch-b.ch}function j(a,b){return i(a,b)<=0}function k(a){return a[a.length-1]}function l(a){if(0===a.length)return 0;for(var b=0,c=0;c<a.length;c++)b+=a[c].length;return b+a.length-1}function m(a){for(var b in a)return!1;return!0}function n(a,b){var c=a[b];a[b]=function(){c.apply(a,arguments)}}var o=d.AnnotationList,p=d.Span,q=d.utils,r=d.AttributeConstants,s="cmrt-",t="cmrt-",u={},v={},w=d.sentinelConstants.LINE_SENTINEL_CHARACTER,x=d.sentinelConstants.ENTITY_SENTINEL_CHARACTER,y=d.sentinelConstants.TRIGGER_AUTOFORMAT_SENTINEL_CHARACTER;return q.makeEventEmitter(b,["change","attributesChange","newLine"]),b.prototype.setReady=function(){var a=this,b=a.codeMirror,c=b.getLine(0);c&&c.length>0&&c[0]===y&&(b.replaceRange("",{line:0,ch:0},{line:0,ch:1},"+input"),setTimeout(function(){a.screenplayAutoFormat(!0)},100)),a.ready_=!0,setTimeout(function(){a.reportVisibleThreads()},0)},b.prototype.detach=function(){this.onScenesChangeCallback&&(this.onScenesChangeCallback=null),this.codeMirror.off("beforeChange",this.onCodeMirrorBeforeChange_),this.codeMirror.off("change",this.onCodeMirrorChange_),this.codeMirror.off("changes",this.onCodeMirrorChange_),this.codeMirror.off("cursorActivity",this.onCursorActivity_),this.codeMirror.off("copy",this.onCopyOrCut_),this.codeMirror.off("cut",this.onCopyOrCut_),this.codeMirror.off("paste",this.onPaste_),this.codeMirror.off("scroll",this.onScroll_),this.clearAnnotations(),this.clearDynamicStyles(),this.clearScenesFilterElements()},b.prototype.clearAnnotations=function(){this.annotationList_.updateSpan(new p(0,this.end()),function(a,b){return new e({})})},b.prototype.setupAnnotations=function(){var a=this;this.annotationList_=new o(function(b,c){a.onAnnotationsChanged_(b,c)}),this.initAnnotationList_()},b.prototype.clearDynamicStyles=function(){for(var a=0;a<this.styleElements.length;a++){const b=this.styleElements[a];b.parentNode.removeChild(b)}this.styleElements=[],u={},v={}},b.prototype.setupDynamicStyles=function(){u[r.COLOR]="color",u[r.BACKGROUND_COLOR]="background-color",u[r.FONT_SIZE]="font-size",u[r.LINE_INDENT]=function(a){return"padding-left: "+40*a+"px"},u[r.SCENE_CODE]=function(a){return'margin-left: 0; position: absolute; left: -60px; content: "'+a+'";'};var a=this.shootingEvent,b={};if(a){try{for(var c=0;c<a.scenes.length;c++)b[a.scenes[c].sceneId]=a.scenes[c].sceneType}catch(d){console.log("Firepad: invalid scenes array for the given shooting event")}var e=r.ELEMENT_COLOR+"-"+this.shootingEvent.id;u[e]=function(a){return"color: "+a+"; text-decoration: underline; font-weight: bold;"},this.showDiffAdditions&&(u[r.DIFF]=function(a){return"added"===a?"background-color: #CAFA94;":void 0})}else this.showComments&&(u[r.THREAD]=function(){return"background-color: #e3e3e3; position: relative;"});u[r.SCENE_ID]=function(c){return a?b[c]&&"PRIMARY"===b[c]?"font-family: 'firepad'; speak: none; font-style: normal; font-weight: normal; font-variant: normal; text-transform: none; line-height: 1; -webkit-font-smoothing: antialiased; content: \"\\e00c\"; margin-left: 0; position: absolute; right: -20px;":"font-family: 'verdana'; speak: none; font-style: normal; font-weight: normal; font-variant: normal; text-transform: none; line-height: 1; -webkit-font-smoothing: antialiased; content: \"||\"; margin-left: 0; position: absolute; right: -20px;":"font-family: 'firepad'; speak: none; font-style: normal; font-weight: normal; font-variant: normal; text-transform: none; line-height: 1; -webkit-font-smoothing: antialiased; content: \"\\e98f\"; margin-left: 0; position: absolute; right: -20px;"}},b.prototype.setShootingEvent=function(a){this.shootingEvent=a,this.options_.shootingEvent=a,this.clearDynamicStyles(),this.setupDynamicStyles(),this.clearScenesFilterElements(),this.filterScenes();for(var b=this.getAttributeSpans(0,this.end()),c=0;c<b.length;c++){var d=b[c].attributes;this.getClassNameForAttributes_(d)}},b.prototype.toggleAttribute=function(a,b){var c=b||!0;if(this.emptySelection_()){var d=this.getCurrentAttributes_();d[a]===c?delete d[a]:d[a]=c,this.currentAttributes_=d}else{var e=this.getCurrentAttributes_(),f=e[a]!==c?c:!1;this.setAttribute(a,f)}},b.prototype.setAttribute=function(a,b){var c=this.codeMirror;if(this.emptySelection_()){var d=this.getCurrentAttributes_();b===!1?delete d[a]:d[a]=b,this.currentAttributes_=d}else this.updateTextAttributes(c.indexFromPos(c.getCursor("start")),c.indexFromPos(c.getCursor("end")),function(c){b===!1?delete c[a]:c[a]=b}),this.updateCurrentAttributes_()},b.prototype.updateTextAttributes=function(a,b,c,d,f){var g=[],h=a,i=this;this.annotationList_.updateSpan(new p(a,b-a),function(a,b){var j={};for(var k in a.attributes)j[k]=a.attributes[k];(!j[r.LINE_SENTINEL]||f)&&c(j);var l={},n={};return i.computeChangedAttributes_(a.attributes,j,l,n),m(l)||g.push({start:h,end:h+b,attributes:l,attributesInverse:n,origin:d}),h+=b,new e(j)}),g.length>0&&this.trigger("attributesChange",this,g)},b.prototype.computeChangedAttributes_=function(a,b,c,d){var e,f={};for(e in a)f[e]=!0;for(e in b)f[e]=!0;for(e in f)e in b?e in a?a[e]!==b[e]&&(c[e]=b[e],d[e]=a[e]):(c[e]=b[e],d[e]=!1):(c[e]=!1,d[e]=a[e])},b.prototype.scrollToLine=function(a,b){var c=this;c.codeMirror.setCursor({line:a+(b?1:0),ch:1}),setTimeout(function(){var b=c.codeMirror.charCoords({line:a,ch:0},"local").top;c.codeMirror.scrollTo(null,b)},100)},b.prototype.scrollToScene=function(a){var b=this.getScenes(),c=b.find(function(b){return b.sceneCode===a});c&&(this.codeMirror.focus(),this.scrollToLine(c.lineNum,!0))},b.prototype.screenplayAutoFormat=function(b,d,e,f){var g=this,i=g.codeMirror.getCursor("head").line;setTimeout(function(){var j=[],k=[],l=g.codeMirror.firstLine(),m=g.codeMirror.lastLine(),n=i-1;if(!b){var o=!1,p=!1,q=!1,s=l,u=m;for("number"==typeof e?s=e:n>l&&(s=n-1),"number"==typeof f?u=f:m>n&&(u=n+1);!o;){if(!p)if(s>l){var v=g.getLineAttributes_(s);v[r.LINE_CLASS]&&"pc-action"!==v[r.LINE_CLASS]?s--:p=!0}else p=!0;if(!q)if(m>u){var v=g.getLineAttributes_(u);v[r.LINE_CLASS]&&"pc-action"!==v[r.LINE_CLASS]?u++:q=!0}else q=!0;o=p&&q}l=s,m=u}for(var w=l;m>=w;w++){var x=g.codeMirror.getLine(w);if(x){x=h(x).trim();var y=x,v=g.getLineAttributes_(w),z=y.match(a.scene_heading),A=y.match(a.character),B=y.match(a.parenthetical),C=!1,D=!1;if(m>w){var E=h(g.codeMirror.getLine(w+1));C=E.match(a.character),D=E.match(a.parenthetical)}(z||!A&&!B&&!D||A&&C)&&(y+="\n"),j.push({line:w,text:y}),v[r.SCENE_ID]||""!==x&&(v[r.LINE_CLASS]&&"auto"!==v[r.LINE_CLASS_TYPE]||k.push(w))}}for(var F=c.parse(j,{tokens:!0}),w=0;w<k.length;w++){var G=k[w],H=F.tokens[G];if(H){var I=null,J="auto";if("scene_heading"===H.type&&(I="pc-scene"),"transition"===H.type&&(I="pc-transition"),"parenthetical"===H.type&&(I="pc-parenthetical"),"dialogue"===H.type&&(I="pc-dialogue"),"action"===H.type&&(I="pc-action"),"character"===H.type&&(I="pc-character",J="user"),"centered"===H.type&&(I="pc-centered",H.text)){var K=g.codeMirror.getLine(G);g.codeMirror.replaceRange(H.text.trim(),{line:G,ch:0},{line:G,ch:K.length},t),J="user"}I&&g.updateLineAttributes(G,G,function(a){a[r.LINE_CLASS]=I,a[r.LINE_CLASS_TYPE]=J,delete a[r.SCENE_CODE]})}}if(!b&&"newline"===d){var L=g.getLineAttributes_(n);L[r.LINE_CLASS]&&("pc-character"===L[r.LINE_CLASS]?g.updateLineAttributes(i,i,function(a){a[r.LINE_CLASS]="pc-dialogue",a[r.LINE_CLASS_TYPE]="auto"}):"pc-parenthetical"===L[r.LINE_CLASS]?g.updateLineAttributes(i,i,function(a){a[r.LINE_CLASS]="pc-dialogue",a[r.LINE_CLASS_TYPE]="user"}):"pc-dialogue"===L[r.LINE_CLASS]?g.updateLineAttributes(i,i,function(a){a[r.LINE_CLASS]="pc-character",a[r.LINE_CLASS_TYPE]="user"}):g.updateLineAttributes(i,i,function(a){a[r.LINE_CLASS]="pc-action",a[r.LINE_CLASS_TYPE]="auto"})),g.onCursorActivity_()}},0)},b.prototype.lockScene=function(a,b){if(b&&"function"==typeof a)for(var c=this,d=c.codeMirror.firstLine(),e=c.codeMirror.lastLine(),f=d;e>=f;f++){var g=c.getLineAttributes_(f);if("pc-scene"===g[r.LINE_CLASS]&&g[r.SCENE_CODE]===b&&!g[r.SCENE_ID]){var i=c.codeMirror.getLine(f);if(i=h(i).trim(),""===i)return"Invalid scene title";var j=a();return c.updateLineAttributes(f,f,function(a){a[r.SCENE_ID]=j}),null}}},b.prototype.lockScenes=function(a,b){if("function"==typeof a){var c=this,d=c.codeMirror.firstLine(),e=c.codeMirror.lastLine(),f=[];c.recodeScenes();for(var g=d;e>=g;g++){var i=c.getLineAttributes_(g);if("pc-scene"===i[r.LINE_CLASS]){var j=i[r.SCENE_CODE];if(j&&!i[r.SCENE_ID]&&(!b||!b.length||b.includes(j))){var k=c.codeMirror.getLine(g);if(k=h(k).trim(),""!==k){var l=a();c.updateLineAttributes(g,g,function(a){a[r.SCENE_ID]=l})}else f.push({sceneCode:j,error:"Invalid scene title"})}}}return f}},b.prototype.deleteScene=function(a){for(var b=this,c=b.codeMirror.firstLine(),d=b.codeMirror.lastLine(),e=!1,f=!1,g=null,h=null,i={title:"",attributes:{},content:[]},j=c;d>=j;j++){var k=b.getLineAttributes_(j),l=b.codeMirror.getLine(j);if("pc-scene"===k[r.LINE_CLASS]&&k[r.SCENE_CODE]){if(e)break;if(k[r.SCENE_CODE]===a&&!k[r.SCENE_OMITTED])if(e=!0,i.title=l,i.attributes=k,k[r.SCENE_ID]){f=!0,b.updateLineAttributes(j,j,function(a){a[r.SCENE_OMITTED]=!0});var m=0,n=l.length;l[0]===w&&m++,b.codeMirror.replaceRange("OMIT",{line:j,ch:m},{line:j,ch:n},t)}else g=j,h=j}else e&&(i.content.push({text:l,attributes:k}),null===g&&(g=j),h=j)}e&&(f&&b.firebaseAdapter_.saveOmittedScene(a,i),b.codeMirror.replaceRange("",{line:g,ch:0},{line:h+1,ch:0},t))},b.prototype.restoreScene=function(a){for(var b=this,c=b.codeMirror.firstLine(),d=b.codeMirror.lastLine(),e=c;d>=e;e++){var f=b.getLineAttributes_(e),g=b.codeMirror.getLine(e);if("pc-scene"===f[r.LINE_CLASS]&&f[r.SCENE_CODE]===a&&f[r.SCENE_OMITTED])return void b.firebaseAdapter_.getOmittedScene(a,function(c){if(c){var d=g.length;b.codeMirror.replaceRange(c.title,{line:e,ch:0},{line:e,ch:d},t),b.updateLineAttributes(e,e,function(a){for(var b in c.attributes)c.attributes.hasOwnProperty(b)&&(a[b]=c.attributes[b]);delete a[r.SCENE_OMITTED]});for(var f=!0,h=0;h<c.content.length;h++){var i=e+h+1,j=null;if(f){var k=b.codeMirror.getLine(i);(0===k.length||b.areLineSentinelCharacters_(k))&&(j={line:i+1,ch:0}),f=!1}b.codeMirror.replaceRange(c.content[h].text+"\n",{line:i,ch:0},j,t),b.updateLineAttributes(i,i,function(a){for(var b in c.content[h].attributes)c.content[h].attributes.hasOwnProperty(b)&&(a[b]=c.content[h].attributes[b])})}b.firebaseAdapter_.deleteOmittedScene(a)}else console.log("Firepad: could not get omitted scene from firebase")})}},b.prototype.recodeScenes=function(){for(var a=this,b=a.codeMirror.firstLine(),c=a.codeMirror.lastLine(),d=[],e=!1,i=b;c>=i;i++){var j=a.getLineAttributes_(i);if("pc-scene"===j[r.LINE_CLASS]){var k=j[r.SCENE_ID],l="",m=a.codeMirror.getLine(i);m=h(m).trim(),k&&(e=!0,l=j[r.SCENE_CODE]),(k||m)&&d.push({lineNum:i,sceneId:k,sceneCode:l,sceneTitle:m})}}for(var n="0",i=0;i<d.length;i++){if(""===d[i].sceneCode){var o="";if(e)for(var p=f(n),q=!1;!q;){for(var s=!1,t=0;!s&&t<d.length;)d[t].sceneCode===p?s=!0:t++;s?i>=t?p=f(p):(p=g(n),n=p):(o=p,q=!0)}else o=(i+1).toString();d[i].sceneCode=o,a.updateLineAttributes(d[i].lineNum,d[i].lineNum,function(a){a[r.SCENE_CODE]=o})}n=d[i].sceneCode}},b.prototype.anchorThread=function(a){if(this.emptySelection_())return"threads must be anchored to a text selection";var b=this.getCurrentAttributes_();if(b[r.THREAD])return"the selected text is already attached to another thread";for(var c=this.annotationList_.getAllAnnotations(),d=0;d<c.length;d++)if(c[d].attributes[r.THREAD]===a)return"thread already anchored to the sceenplay";this.setAttribute(r.THREAD,a),this.onCursorActivity_();var e=this;setTimeout(function(){e.reportVisibleThreads()},0)},b.prototype.deleteThread=function(a){var b=this;setTimeout(function(){for(var c=b.codeMirror.firstLine(),d=b.codeMirror.lastLine(),e=[],f=c;d>=f;f++)for(var g=b.codeMirror.getLine(f),h=0;h<g.length;h++){var i=b.codeMirror.indexFromPos({line:f,ch:h}),j=b.annotationList_.getAnnotatedSpansForSpan(new p(i,1));j.length>0&&j[0].annotation.attributes[r.THREAD]===a&&e.push(i)}for(var f=0;f<e.length;f++)b.updateTextAttributes(e[f],e[f]+1,function(a){delete a[r.THREAD]});b.reportVisibleThreads()},0)},b.prototype.scrollToThread=function(a){var b=this;setTimeout(function(){for(var c=b.codeMirror.firstLine(),d=b.codeMirror.lastLine(),e=c;d>=e;e++)for(var f=b.codeMirror.getLine(e),g=0;g<f.length;g++){var h=b.codeMirror.indexFromPos({line:e,ch:g}),i=b.annotationList_.getAnnotatedSpansForSpan(new p(h,1));if(i.length>0&&i[0].annotation.attributes[r.THREAD]===a)return b.codeMirror.focus(),void b.scrollToLine(e,!0)}},0)},b.prototype.setSelectedThread=function(a){this.clearSelectedThread();var b=this;setTimeout(function(){for(var c=b.codeMirror.firstLine(),d=b.codeMirror.lastLine(),e=c,f=!1,g={},h=!1;!f&&d>=e;){for(var i=b.codeMirror.getLine(e),j=0;!f&&j<i.length;){var k=b.codeMirror.indexFromPos({line:e,ch:j}),l=b.annotationList_.getAnnotatedSpansForSpan(new p(k,1));l.length>0&&l[0].annotation.attributes[r.THREAD]===a?h||(g.from={line:e,ch:j},h=!0):h&&(g.to={line:e,ch:j},f=!0),j++}e++}b.codeMirror.markText(g.from,g.to,{className:"firepad-thread-selected"})},0)},b.prototype.clearSelectedThread=function(){var a=this;setTimeout(function(){var b=a.codeMirror.getAllMarks();b.forEach(function(a){"firepad-thread-selected"===a.className&&a.clear()})},0)},b.prototype.getAddedDiffScenes=function(a){var b=this;setTimeout(function(){for(var c={},d=b.codeMirror.firstLine(),e=b.codeMirror.lastLine(),f=null,g=d;e>=g;g++){var h=b.getLineAttributes_(g);if("pc-scene"===h[r.LINE_CLASS]&&(f=h[r.SCENE_ID]),f&&!c[f])for(var i=b.codeMirror.getLine(g),j=0;j<i.length;j++){var k=b.codeMirror.indexFromPos({line:g,ch:j}),l=b.annotationList_.getAnnotatedSpansForSpan(new p(k,1));if(l.length>0&&l[0].annotation.attributes[r.DIFF]){
c[f]=!0;break}}}var m=[];for(var n in c)c.hasOwnProperty(n)&&m.push(n);a(m)},0)},b.prototype.getAddedDiffLines=function(a){var b=this;return b.shootingEvent?void setTimeout(function(){for(var c=[],d=b.shootingEvent.scenes||[],e=b.codeMirror.firstLine(),f=b.codeMirror.lastLine(),g=!1,h=e;f>=h;h++){var i=b.getLineAttributes_(h);if("pc-scene"===i[r.LINE_CLASS]){var j=i[r.SCENE_ID],k=0;for(g=!1;k<d.length&&!g;)d[k].sceneId===j&&(g=!0),k++}if(g)for(var l=b.codeMirror.getLine(h),k=0;k<l.length;k++){var m=b.codeMirror.indexFromPos({line:h,ch:k}),n=b.annotationList_.getAnnotatedSpansForSpan(new p(m,1));if(n.length>0&&n[0].annotation.attributes[r.DIFF]){c.push(h);break}}}a(c)},0):a([])},b.prototype.deleteAddedDiffs=function(a){var b=this;return b.shootingEvent?void setTimeout(function(){for(var c=[],d=b.shootingEvent.scenes||[],e=b.codeMirror.firstLine(),f=b.codeMirror.lastLine(),g=!1,h=e;f>=h;h++){var i=b.getLineAttributes_(h);if("pc-scene"===i[r.LINE_CLASS]){var j=i[r.SCENE_ID],k=0;for(g=!1;k<d.length&&!g;)d[k].sceneId===j&&(g=!0),k++}if(g)for(var l=b.codeMirror.getLine(h),k=0;k<l.length;k++){var m=b.codeMirror.indexFromPos({line:h,ch:k}),n=b.annotationList_.getAnnotatedSpansForSpan(new p(m,1));n.length>0&&n[0].annotation.attributes[r.DIFF]&&c.push(m)}}for(var h=0;h<c.length;h++)b.updateTextAttributes(c[h],c[h]+1,function(a){delete a[r.DIFF]});a()},0):a()},b.prototype.toggleElement=function(a,b){if(this.shootingEvent&&""===this.shootingEvent.id)console.log("no shootingEvent option found");else{for(var c=this.codeMirror.getCursor("head").line,d=this.codeMirror.firstLine(),e=null;c>=d&&!e;){var f=this.getLineAttributes_(c);"pc-scene"===f[r.LINE_CLASS]&&(e=f[r.SCENE_ID]),c--}if(e){var g=this.getCurrentAttributes_(),h=r.ELEMENT+"-"+this.shootingEvent.id,i=r.ELEMENT_COLOR+"-"+this.shootingEvent.id,j=!0;return g[h]===a?(this.emptySelection_()&&this.selectElement(a),this.setAttribute(h,!1),this.setAttribute(i,!1),j=!1):(this.emptySelection_()&&this.selectWord(),this.setAttribute(h,a),this.setAttribute(i,b)),this.onCursorActivity_(),{sceneId:e,elementAdded:j}}console.log("Firepad: cursor not inside a scene")}return null},b.prototype.deleteElements=function(a){var b=this;if(this.shootingEvent&&""===this.shootingEvent.id)console.log("no shootingEvent option found");else{var c=r.ELEMENT+"-"+this.shootingEvent.id,d=r.ELEMENT_COLOR+"-"+this.shootingEvent.id;setTimeout(function(){for(var e=b.codeMirror.firstLine(),f=b.codeMirror.lastLine(),g=[],h=e;f>=h;h++)for(var i=b.codeMirror.getLine(h),j=0;j<i.length;j++){var k=b.codeMirror.indexFromPos({line:h,ch:j}),l=b.annotationList_.getAnnotatedSpansForSpan(new p(k,1));l.length>0&&(!a&&l[0].annotation.attributes[c]||l[0].annotation.attributes[c]===a)&&g.push(k)}for(var h=0;h<g.length;h++)b.updateTextAttributes(g[h],g[h]+1,function(a){delete a[c],delete a[d]})},0)}},b.prototype.getElements=function(){var a={};if(this.shootingEvent&&""===this.shootingEvent.id)console.log("no shootingEvent option found");else for(var b=r.ELEMENT+"-"+this.shootingEvent.id,c=this.annotationList_.getAllAnnotations(),d=0;d<c.length;d++){var e=c[d].attributes[b];e&&(a[e]=!0)}return a},b.prototype.toggleLineAttribute=function(a,b){var c,d=this.getCurrentLineAttributes_();c=a in d&&d[a]===b?!1:b,this.setLineAttribute(a,c)},b.prototype.setLineAttribute=function(a,b){this.updateLineAttributesForSelection(function(c){b===!1?delete c[a]:c[a]=b})},b.prototype.updateLineAttributesForSelection=function(a){var b=this.codeMirror,c=b.getCursor("start"),d=b.getCursor("end"),e=c.line,f=d.line,g=b.getLine(f),h=this.areLineSentinelCharacters_(g.substr(0,d.ch));f>e&&h&&f--,this.updateLineAttributes(e,f,a)},b.prototype.updateLineAttributes=function(a,b,c){for(var d=a;b>=d;d++){var e=this.codeMirror.getLine(d),f=this.codeMirror.indexFromPos({line:d,ch:0});if(e[0]!==w){var g={};g[r.LINE_SENTINEL]=!0,c(g),this.insertText(f,w,g)}else this.updateTextAttributes(f,f+1,c,null,!0)}},b.prototype.replaceText=function(a,b,c,d,e){this.changeId_++;var f=t+this.changeId_;this.outstandingChanges_[f]={origOrigin:e,attributes:d};var g=this.codeMirror,h=g.posFromIndex(a),i="number"==typeof b?g.posFromIndex(b):null;g.replaceRange(c,h,i,f)},b.prototype.insertText=function(a,b,c,d){var e=this.codeMirror,f=e.getCursor(),g="RTCMADAPTER"==d&&!e.somethingSelected()&&a==e.indexFromPos(f);this.replaceText(a,null,b,c,d),g&&e.setCursor(f)},b.prototype.removeText=function(a,b,c){var d=this.codeMirror;d.replaceRange("",d.posFromIndex(a),d.posFromIndex(b),c)},b.prototype.insertEntityAtCursor=function(a,b,c){var d=this.codeMirror,e=d.indexFromPos(d.getCursor("head"));this.insertEntityAt(e,a,b,c)},b.prototype.insertEntityAt=function(a,b,c,e){this.codeMirror;this.insertEntity_(a,new d.Entity(b,c),e)},b.prototype.insertEntity_=function(a,b,c){this.replaceText(a,null,x,b.toAttributes(),c)},b.prototype.getAttributeSpans=function(a,b){for(var c=[],d=this.annotationList_.getAnnotatedSpansForSpan(new p(a,b-a)),e=0;e<d.length;e++)c.push({length:d[e].length,attributes:d[e].annotation.attributes});return c},b.prototype.end=function(){var a=this.codeMirror.lineCount()-1;return this.codeMirror.indexFromPos({line:a,ch:this.codeMirror.getLine(a).length})},b.prototype.getRange=function(a,b){var c=this.codeMirror.posFromIndex(a),d=this.codeMirror.posFromIndex(b);return this.codeMirror.getRange(c,d)},b.prototype.initAnnotationList_=function(){var a=this.end();0!==a&&this.annotationList_.insertAnnotatedSpan(new p(0,a),new e)},b.prototype.onAnnotationsChanged_=function(a,b){var c,d={};this.tryToUpdateEntitiesInPlace(a,b);for(var e=0;e<a.length;e++){var f=a[e].annotation.attributes;r.LINE_SENTINEL in f&&(d[this.codeMirror.posFromIndex(a[e].pos).line]=!0),c=a[e].getAttachedObject(),c&&c.clear()}for(e=0;e<b.length;e++){var g=b[e].annotation,f=g.attributes,h=r.LINE_SENTINEL in f,i=r.ENTITY_SENTINEL in f,j=this.codeMirror.posFromIndex(b[e].pos);if(h)d[j.line]=!0;else if(i)this.markEntity_(b[e]);else{var k=this.getClassNameForAttributes_(f);if(""!==k){var l=this.codeMirror.posFromIndex(b[e].pos+b[e].length);c=this.codeMirror.markText(j,l,{className:k}),b[e].attachObject(c)}}}for(var m in d)this.dirtyLines_.push(this.codeMirror.getLineHandle(Number(m))),this.queueLineMarking_()},b.prototype.tryToUpdateEntitiesInPlace=function(a,b){for(var c=a.length;c--;)for(var d=a[c],e=b.length;e--;){var f=b[e];if(d.pos==f.pos&&d.length==f.length&&d.annotation.attributes.ent&&d.annotation.attributes.ent==f.annotation.attributes.ent){var g=f.annotation.attributes.ent;if(this.entityManager_.entitySupportsUpdate(g)){a.splice(c,1),b.splice(e,1);var h=d.getAttachedObject();h.update(f.annotation.attributes),f.attachObject(h)}}}},b.prototype.queueLineMarking_=function(){if(null==this.lineMarkTimeout_){var a=this;this.lineMarkTimeout_=setTimeout(function(){a.lineMarkTimeout_=null;for(var b=[],c=0;c<a.dirtyLines_.length;c++){var d=a.codeMirror.getLineNumber(a.dirtyLines_[c]);b.push(Number(d))}a.dirtyLines_=[],b.sort(function(a,b){return a-b});var e=-1;for(c=0;c<b.length;c++){var f=b[c];f>e&&(e=a.markLineSentinelCharactersForChangedLines_(f,f))}},0)}},b.prototype.addStyleWithCSS_=function(a){const b=document.getElementsByTagName("head")[0],c=document.createElement("style");c.type="text/css",c.styleSheet?c.styleSheet.cssText=a:c.appendChild(document.createTextNode(a)),b.appendChild(c),this.styleElements.push(c)},b.prototype.getClassNameForAttributes_=function(a){var b="";for(var c in a){var e=a[c];if(c===r.LINE_SENTINEL)d.utils.assert(e===!0,"LINE_SENTINEL attribute should be true if it exists.");else{var f=(this.options_.cssPrefix||s)+c;if(e!==!0){c===r.FONT_SIZE&&"string"!=typeof e&&(e+="px");var g=e.toString().replace(/[^A-Za-z0-9-_]/g,"-");if(f+="-"+g,u[c]&&(v[c]||(v[c]={}),!v[c][g])){var h=u[c],i="function"==typeof h?h(e):h+": "+e,j="";c==r.LINE_INDENT?j="pre."+f:c==r.SCENE_CODE?a[r.SCENE_ID]&&(j="."+f+"::before"):j=c==r.SCENE_ID?"."+f+"::after":"."+f,j&&(this.addStyleWithCSS_(j+" { "+i+" }"),v[c][g]=!0)}}b=b+" "+f}}return b},b.prototype.markEntity_=function(a){for(var b=a.annotation.attributes,c=d.Entity.fromAttributes(b),e=this.codeMirror,f=this,g=[],h=0;h<a.length;h++){var i=e.posFromIndex(a.pos+h),j=e.posFromIndex(a.pos+h+1),k={collapsed:!0,atomic:!0,inclusiveLeft:!1,inclusiveRight:!1},l=this.createEntityHandle_(c,a.pos),m=this.entityManager_.renderToElement(c,l);m&&(k.replacedWith=m);var n=e.markText(i,j,k);g.push(n),l.setMarker(n)}a.attachObject({clear:function(){for(var a=0;a<g.length;a++)g[a].clear()},update:function(a){for(var b=d.Entity.fromAttributes(a),c=0;c<g.length;c++)f.entityManager_.updateElement(b,g[c].replacedWith)}}),this.queueRefresh_()},b.prototype.queueRefresh_=function(){var a=this;this.refreshTimer_||(this.refreshTimer_=setTimeout(function(){a.codeMirror.refresh(),a.refreshTimer_=null},0))},b.prototype.createEntityHandle_=function(a,b){function c(){if(h){var a=h.find();return a?i.codeMirror.indexFromPos(a.from):null}return b}function e(){var a=c();null!=a&&(i.codeMirror.focus(),i.removeText(a,a+1))}function f(b){var e=d.AttributeConstants,f=e.ENTITY_SENTINEL,g=f+"_",h=c();i.updateTextAttributes(h,h+1,function(c){for(var d in c)delete c[d];c[f]=a.type;for(var e in b)c[g+e]=b[e]})}function g(a){h=a}var h=null,i=this;return{find:c,remove:e,replace:f,setMarker:g}},b.prototype.lineClassRemover_=function(a){var b=this.codeMirror,c=b.getLineHandle(a);return{clear:function(){b.removeLineClass(c,"text",".*")}}},b.prototype.emptySelection_=function(){var a=this.codeMirror.getCursor("start"),b=this.codeMirror.getCursor("end");return a.line===b.line&&a.ch===b.ch},b.prototype.onLockedScenesDeleteIntent=function(a){this.onLockedScenesDeleteIntentCallback=a},b.prototype.onLockedSceneTitleEdited=function(a){this.onLockedSceneTitleEditedCallback=a},b.prototype.onCodeMirrorBeforeChange_=function(a,b){if(this.ready_&&b.origin&&0!==b.origin.indexOf(t)&&"RTCMADAPTER"!==b.origin){for(var c=this,d=c.getScenes(b.from.line,b.to.line,!0),e=0;e<d.length;e++)if(d[e].sceneOmitted)return void b.cancel();if(1===d.length){var f=d[0],g="edit",h=b.from.line<f.lineNum||b.from.line===f.lineNum&&b.from.ch<=0,i=b.to.line>f.lineNum||b.to.line===f.lineNum&&b.to.ch>=1,j="+delete"===b.origin&&b.from.line===f.lineNum&&b.to.line===f.lineNum&&1===b.from.ch&&1===b.to.ch,k=b.from.line===f.lineNum&&1===b.from.ch&&b.to.line>f.lineNum;if((h&&i||j||k)&&(g="delete"),"edit"===g)c.onLockedSceneTitleEditedCallback&&setTimeout(function(){c.onLockedSceneTitleEditedCallback(f)},0),b.update(b.from,b.to,b.text);else if("delete"===g)return c.onLockedScenesDeleteIntentCallback&&setTimeout(function(){c.onLockedScenesDeleteIntentCallback(d)},0),void b.cancel()}else if(d.length>1)return"+delete"===b.origin||"cut"===b.origin?c.onLockedScenesDeleteIntentCallback&&setTimeout(function(){c.onLockedScenesDeleteIntentCallback(d)},0):console.log("Firepad: Intent of deleting a locked scene blocked"),void b.cancel()}},b.prototype.onCodeMirrorChange_=function(a,b){if("object"==typeof b.from){for(var c=[];b;)c.push(b),b=b.next;b=c}for(var d=this.convertCoordinateSystemForChanges_(b),f=[],g=0;g<d.length;g++){var h=d[g],i=h.start,j=(h.end,h.text),k=h.removed,l=h.origin;if(k.length>0){for(var m=this.annotationList_.getAnnotatedSpansForSpan(new p(i,k.length)),n=0,o=0;o<m.length;o++){var q=m[o];f.push({start:i,end:i+q.length,removedAttributes:q.annotation.attributes,removed:k.substr(n,q.length),attributes:{},text:"",origin:h.origin}),n+=q.length}this.annotationList_.removeSpan(new p(i,k.length))}if(j.length>0){var s;if("+input"===h.origin||"paste"===h.origin){if(s=this.currentAttributes_||{},s[r.DIFF]="added","paste"===h.origin){var t=this,u=a.posFromIndex(i),v=a.posFromIndex(i+j.length);setTimeout(function(){t.screenplayAutoFormat(!1,"paste",u.line,v.line)},100)}}else l in this.outstandingChanges_?(s=this.outstandingChanges_[l].attributes,l=this.outstandingChanges_[l].origOrigin,delete this.outstandingChanges_[l]):s={};this.annotationList_.insertAnnotatedSpan(new p(i,j.length),new e(s)),f.push({start:i,end:i,removedAttributes:{},removed:"",text:j,attributes:s,origin:l})}}this.markLineSentinelCharactersForChanges_(b),f.length>0&&this.trigger("change",this,f)},b.prototype.onCopyOrCut_=function(a,b){if("tag"===this.options_.screenplayMode&&"cut"===b.type)return void b.preventDefault();if(b.clipboardData&&b.clipboardData.clearData&&b.clipboardData.setData){var c=a.getSelection("\n"),d=h(c);if(!d)return;for(var e=a.getCursor("start"),f=a.getCursor("end"),g=[],i=e.line;i<=f.line;i++){var j=a.getLine(i),k=this.getLineAttributes_(i),l={};l[r.LINE_SENTINEL]=!0,k[r.LINE_CLASS]&&(l[r.LINE_CLASS]=k[r.LINE_CLASS]),k[r.LINE_CLASS_TYPE]&&(l[r.LINE_CLASS_TYPE]=k[r.LINE_CLASS_TYPE]),i===e.line&&e.ch>1&&(j=a.getRange(e,{line:i,ch:j.length}),l=null),i===f.line&&f.ch<j.length&&(j=a.getRange({line:i,ch:0},f)),g.push({text:h(j),attrs:l})}var m=JSON.stringify(g);"cut"===b.type&&a.replaceSelection("",null,"cut"),b.clipboardData.clearData(),b.clipboardData.setData("text",d),b.clipboardData.setData("procliq",m),b.preventDefault()}},b.prototype.onPaste_=function(a,b){if("tag"===this.options_.screenplayMode)return void b.preventDefault();if(b.clipboardData&&b.clipboardData.getData){var c=b.clipboardData.getData("procliq");if(""!==c)try{var d=JSON.parse(c);if(d.length>1){b.preventDefault();var e=a.getCursor("start"),f=a.getCursor("end"),g=e.line,h=a.getLine(f.line);if(f.ch<h.length){var i=h.substring(f.ch);d[d.length-1].text+=i,a.extendSelection(e,{line:f.line,ch:h.length})}a.replaceSelection("",null,"cut");for(var j=0;j<d.length;j++){var k=d[j].text,l=d[j].attrs,m=1;if(g===e.line&&e.ch>1&&(l=null,m=e.ch),j<d.length-1&&(k+="\n"),l){var n=a.indexFromPos({line:g,ch:0});this.insertText(n,w,l)}var n=a.indexFromPos({line:g,ch:m});this.insertText(n,k,{}),g++}}}catch(o){console.log(o)}}},b.prototype.onScroll_=function(a){if("edit"===this.options_.screenplayMode){var b=this;setTimeout(function(){b.reportVisibleThreads()},0)}},b.prototype.reportVisibleThreads=function(){if(this.onVisibleThreadsChangeCallback){var a=this.codeMirror,b=a.getWrapperElement().getBoundingClientRect(),c=a.lineAtHeight(b.top,"window"),d=a.lineAtHeight(b.bottom,"window");if(c===this.visibleThreadsFrom&&d===this.visibleThreadsTo)return;this.visibleThreadsFrom=c,this.visibleThreadsTo=d;for(var e={},f="",g=this.visibleThreadsFrom;g<=this.visibleThreadsTo;g++){var h=this.codeMirror.getLine(g);if(h)for(var i=0;i<h.length;i++){var j={line:g,ch:i},k=this.codeMirror.indexFromPos(j),l=this.annotationList_.getAnnotatedSpansForSpan(new p(k,1));if(l.length>0&&l[0].annotation.attributes[r.THREAD]){var m=l[0].annotation.attributes[r.THREAD];e[m]||(e[m]=j,f+=m+"|",f+=g+"|",f+=i+"|")}}}f!==this.serializedThreads&&(this.serializedThreads=f,this.onVisibleThreadsChangeCallback(e))}},b.prototype.convertCoordinateSystemForChanges_=function(a){function b(a,b){return function(c){return j(c,b.from)?a(c):j(b.to,c)?a({line:c.line+b.text.length-1-(b.to.line-b.from.line),ch:b.to.line<c.line?c.ch:b.text.length<=1?c.ch-(b.to.ch-b.from.ch)+l(b.text):c.ch-b.to.ch+k(b.text).length})+l(b.removed)-l(b.text):b.from.line===c.line?a(b.from)+c.ch-b.from.ch:a(b.from)+l(b.removed.slice(0,c.line-b.from.line))+1+c.ch}}for(var c=this,d=function(a){return c.codeMirror.indexFromPos(a)},e=[],f=a.length-1;f>=0;f--){var g=a[f];d=b(d,g);var h=d(g.from),i=g.removed.join("\n"),m=g.text.join("\n");e.unshift({start:h,end:h+i.length,removed:i,text:m,origin:g.origin})}return e},b.prototype.markLineSentinelCharactersForChanges_=function(a){for(var b=Number.MAX_VALUE,c=-1,d=0;d<a.length;d++){var e=a[d],f=e.from.line;e.from.ch;(e.removed.length>1||e.removed[0].indexOf(w)>=0)&&(b=Math.min(b,f),c=Math.max(c,f)),e.text.length>1?(b=Math.min(b,f),c=Math.max(c,f+e.text.length-1)):e.text[0].indexOf(w)>=0&&(b=Math.min(b,f),c=Math.max(c,f))}c=Math.min(c,this.codeMirror.lineCount()-1),this.markLineSentinelCharactersForChangedLines_(b,c)},b.prototype.markLineSentinelCharactersForChangedLines_=function(a,b){if(a<Number.MAX_VALUE)for(;a>0&&this.lineIsListItemOrIndented_(a-1);)a--;if(b>-1)for(var c=this.codeMirror.lineCount();c>b+1&&this.lineIsListItemOrIndented_(b+1);)b++;for(var d=[],e=this.codeMirror,f=a;b>=f;f++){var g=e.getLine(f),h=e.getLineHandle(f);if(e.removeLineClass(h,"text",".*"),g.length>0)for(var i=g.indexOf(w);i>=0;){for(var j=i;i<g.length&&g[i]===w;){for(var k=e.findMarksAt({line:f,ch:i}),l=0;l<k.length;l++)k[l].isForLineSentinel&&k[l].clear();i++}this.markLineSentinelCharacters_(f,j,i,d),i=g.indexOf(w,i)}else d=[]}return b},b.prototype.markLineSentinelCharacters_=function(a,b,c,d){var e=this.codeMirror,f=null,g=null,h=function(){var a=g.find();return a?a.from.line:null};if(0===b){var i=this.getLineAttributes_(a),j=i[r.LIST_TYPE],k=i[r.LINE_INDENT]||0;for(j&&0===k&&(k=1);k>=d.length;)d.push(1);"o"===j?(f=this.makeOrderedListElement_(d[k]),d[k]++):"u"===j?(f=this.makeUnorderedListElement_(),d[k]=1):"t"===j?(f=this.makeTodoListElement_(!1,h),d[k]=1):"tc"===j&&(f=this.makeTodoListElement_(!0,h),d[k]=1);var l=this.getClassNameForAttributes_(i);""!==l&&this.codeMirror.addLineClass(a,"text",l),d=d.slice(0,k+1)}var m={inclusiveLeft:!0,collapsed:!0};f&&(m.replacedWith=f);var g=e.markText({line:a,ch:b},{line:a,ch:c},m);g.isForLineSentinel=!0},b.prototype.makeOrderedListElement_=function(a){return q.elt("div",a+".",{"class":"firepad-list-left"})},b.prototype.makeUnorderedListElement_=function(){return q.elt("div","•",{"class":"firepad-list-left"})},b.prototype.toggleTodo=function(a){var b,c=r.LIST_TYPE,d=this.getCurrentLineAttributes_();c in d&&("t"===d[c]||"tc"===d[c])?"t"===d[c]?b="tc":"tc"===d[c]&&(b=a?"t":!1):b="t",this.setLineAttribute(c,b)},b.prototype.makeTodoListElement_=function(a,b){var c={type:"checkbox","class":"firepad-todo-left"};a&&(c.checked=!0);var d=q.elt("input",!1,c),e=this;return q.on(d,"click",q.stopEventAnd(function(a){e.codeMirror.setCursor({line:b(),ch:1}),e.toggleTodo(!0)})),d},b.prototype.lineIsListItemOrIndented_=function(a){var b=this.getLineAttributes_(a);return(b[r.LIST_TYPE]||!1)!==!1||0!==(b[r.LINE_INDENT]||0)},b.prototype.onCursorChange=function(a){this.onCursorChangeCallback=a},b.prototype.filterScenes=function(){if(this.shootingEvent){for(var a=this.shootingEvent.scenes||[],b=[],c=0,d=!1,e=!1,f=!0,g=this.codeMirror.firstLine(),h=this.codeMirror.lastLine(),i=g;h>=i;i++){var j=this.getLineAttributes_(i);if("pc-scene"===j[r.LINE_CLASS]){for(var k=j[r.SCENE_ID],l=!1,m=!1,n=0;n<a.length&&!l;)a[n].sceneId===k&&(l=!0,"PRIMARY"!==a[n].sceneType&&(m=!0)),n++;if(l)if(i===g&&(d=!0),f)f=!1;else{var o=document.createElement("div");o.className=e?"firepad-scene-end-secondary":"firepad-scene-end";var p=this.codeMirror.addLineWidget(i,o,{above:!0});this.scenesFilterElements.push({type:"widget",widget:p})}l&&!d?(b.push({startLine:c,endLine:i}),d=!0):!l&&d&&(c=i,d=!1),l&&m&&!e?e=!0:l&&!m&&e&&(e=!1)}if(d&&e){var q="wrap",s="firepad-secondary-scene",t=this.codeMirror.addLineClass(i,q,s);this.scenesFilterElements.push({type:"lineClass",handle:t,where:q,"class":s})}}var u=document.createElement("div");u.className=e?"firepad-scene-end-secondary":"firepad-scene-end";var p=this.codeMirror.addLineWidget(h,u,{});this.scenesFilterElements.push({type:"widget",widget:p}),d||b.push({startLine:c,endLine:h+1});for(var i=0;i<b.length;i++){var v=b[i].startLine,w=b[i].endLine;w>b[i].startLine&&w--;var x=this.codeMirror.getLine(w).length,y=this.codeMirror.markText({line:v,ch:0},{line:w,ch:x},{inclusiveLeft:!0,inclusiveRight:!0,collapsed:!0});this.scenesFilterElements.push({type:"mark",mark:y})}}},b.prototype.clearScenesFilterElements=function(){for(var a=0;a<this.scenesFilterElements.length;a++)"lineClass"===this.scenesFilterElements[a].type?this.codeMirror.removeLineClass(this.scenesFilterElements[a].handle,this.scenesFilterElements[a].where,this.scenesFilterElements[a]["class"]):"widget"===this.scenesFilterElements[a].type?this.scenesFilterElements[a].widget.clear():"mark"===this.scenesFilterElements[a].type&&this.scenesFilterElements[a].mark.clear();this.scenesFilterElements=[]},b.prototype.getCurrentScene=function(){var a=this.codeMirror,b=a.getCursor("head");if(!b)return null;for(var c=a.firstLine(),d=b.line,e=d;e>=c;e--){var f=this.getLineAttributes_(e);if("pc-scene"===f[r.LINE_CLASS]){var g=f[r.SCENE_ID],i=f[r.SCENE_CODE],j=f[r.SCENE_OMITTED];if(i){var k=this.codeMirror.getLine(e);return k=h(k).trim(),{lineNum:e,sceneId:g,sceneCode:i,sceneTitle:k,sceneOmitted:!!j,sceneLocked:!!g}}}}return null},b.prototype.getNextScene=function(){var a=this.codeMirror,b=a.getCursor("head"),c=this.getScenes();return b?c.find(function(a){return a.lineNum>b.line}):c[c.length-1]},b.prototype.prepareForNewScene=function(){var a=this.getNextScene(),b=a?a.lineNum:this.codeMirror.lastLine();if(a){var c=this.codeMirror.indexFromPos({line:b,ch:0});this.insertText(c,"\n",{}),this.insertText(c,"\n",{})}this.scrollToLine(b),this.setLineAttribute(r.LINE_CLASS,"pc-scene"),this.codeMirror.focus()},b.prototype.getScenes=function(a,b,c){for(var d=this,a="number"==typeof a?a:d.codeMirror.firstLine(),b="number"==typeof b?b:d.codeMirror.lastLine(),e=[],f=a;b>=f;f++){var g=d.getLineAttributes_(f);if("pc-scene"===g[r.LINE_CLASS]){var i=g[r.SCENE_ID],j=g[r.SCENE_CODE],k=g[r.SCENE_OMITTED];if(j&&(!c||c&&i)){var l=d.codeMirror.getLine(f);l=h(l).trim(),e.push({lineNum:f,sceneId:i,sceneCode:j,sceneTitle:l,sceneOmitted:!!k,sceneLocked:!!i})}}}return e},b.prototype.onScenesChange=function(a){this.onScenesChangeCallback=a},b.prototype.reportScenesStatus=function(){var a=this;if(a.ready_&&(a.recodeScenes(),a.onScenesChangeCallback&&"function"==typeof a.onScenesChangeCallback)){for(var b=a.getScenes(),c="",d=0;d<b.length;d++)c+=b[d].sceneId+"|",c+=b[d].sceneCode+"|",c+=b[d].sceneTitle+"|",c+=b[d].sceneOmitted+"|",c+=b[d].sceneLocked+"|";c!==a.serializedScenes&&(a.serializedScenes=c,a.onScenesChangeCallback(b))}setTimeout(function(){a.reportScenesStatus()},5e3)},b.prototype.onVisibleThreadsChange=function(a){this.onVisibleThreadsChangeCallback=a},b.prototype.onCursorActivity_=function(){var a=this;setTimeout(function(){if(a.updateCurrentAttributes_(),a.updateToolbar(),a.onCursorChangeCallback){const b=a.getCurrentLineAttributes_(),c=b[r.LINE_CLASS]||null;var d=a.getCurrentAttributes_(),e=null,f=null;if(a.shootingEvent&&""!==a.shootingEvent.id){var g=r.ELEMENT+"-"+a.shootingEvent.id;e=d[g]||null}else f=d[r.THREAD]||null;var h={elementId:e,threadId:f,lineClass:c,currentScene:a.getCurrentScene()};a.onCursorChangeCallback(h)}},1)},b.prototype.elementMarkerPos=function(a){if(this.shootingEvent)for(var b=this.codeMirror.getCursor("head"),c=this.codeMirror.findMarksAt(b),d=this.options_.cssPrefix+r.ELEMENT+"-"+this.shootingEvent.id+"-"+a,e=0;e<c.length;e++){var f=c[e].getClassName();if(f.indexOf(d)>=0)return c[e].find()}return null},b.prototype.selectElement=function(a){var b=this.elementMarkerPos(a);b&&this.codeMirror.setSelection(b.from,b.to)},b.prototype.selectWord=function(){var a=this.codeMirror.findWordAt(this.codeMirror.getCursor());a&&this.codeMirror.setSelection(a.anchor,a.head)},b.prototype.updateToolbar=function(){if("screenplay"===this.options_.mode&&this.options_.toolbar){var a=this.getCurrentLineAttributes_(),b=document.getElementsByClassName("firepad-btn");if(b&&b.length>0){for(var c=0;c<b.length;c++)b[c].classList.remove("firepad-btn-selected"),b[c].classList.remove("firepad-btn-selected-auto");if(a&&a[r.LINE_CLASS]&&(b=document.getElementsByClassName("firepad-tb-"+a[r.LINE_CLASS]),b&&b.length>0)){var d="firepad-btn-selected";a[r.LINE_CLASS_TYPE]&&"auto"===a[r.LINE_CLASS_TYPE]&&(d="firepad-btn-selected-auto"),b[0].parentElement.classList.add(d)}}}},b.prototype.getCurrentAttributes_=function(){return this.currentAttributes_||this.updateCurrentAttributes_(),this.currentAttributes_},b.prototype.updateCurrentAttributes_=function(){var a=this.codeMirror,b=a.indexFromPos(a.getCursor("anchor")),c=a.indexFromPos(a.getCursor("head")),e=c;if(b>c){for(;e<this.end();){var f=this.getRange(e,e+1);if("\n"!==f&&f!==w)break;e++}e<this.end()&&e++}else for(;e>0&&(f=this.getRange(e-1,e),"\n"===f||f===w);)e--;var g=this.annotationList_.getAnnotatedSpansForPos(e);this.currentAttributes_={};var h={};g.length>0&&!(r.LINE_SENTINEL in g[0].annotation.attributes)?h=g[0].annotation.attributes:g.length>1&&(d.utils.assert(!(r.LINE_SENTINEL in g[1].annotation.attributes),"Cursor can't be between two line sentinel characters."),h=g[1].annotation.attributes);for(var i in h)"l"!==i&&"lt"!==i&&"li"!==i&&0!==i.indexOf(r.ENTITY_SENTINEL)&&(this.currentAttributes_[i]=h[i])},b.prototype.getCurrentLineAttributes_=function(){var a=this.codeMirror,b=a.getCursor("anchor"),c=a.getCursor("head"),d=c.line;return 0===c.ch&&b.line<c.line&&d--,this.getLineAttributes_(d)},b.prototype.getLineAttributes_=function(a){var b={},c=this.codeMirror.getLine(a);if(c.length>0&&c[0]===w){var e=this.codeMirror.indexFromPos({line:a,ch:0}),f=this.annotationList_.getAnnotatedSpansForSpan(new p(e,1));d.utils.assert(1===f.length);for(var g in f[0].annotation.attributes)b[g]=f[0].annotation.attributes[g]}return b},b.prototype.newline=function(){var a=this.codeMirror,b=this;if(this.emptySelection_()){var c=a.getCursor("head"),d=c.line,e=c.ch,f=this.getLineAttributes_(d),g=f[r.LIST_TYPE];g&&1===a.getLine(d).length?this.updateLineAttributes(d,d,function(a){delete a[r.LIST_TYPE],delete a[r.LINE_INDENT]}):1>=e?a.replaceRange("\n",{line:d,ch:0},{line:d,ch:0},"+input"):(a.replaceSelection("\n","end","+input"),this.updateLineAttributes(d+1,d+1,function(a){for(var c in f)c!==r.LINE_CLASS&&c!==r.LINE_CLASS_TYPE&&c!==r.SCENE_CODE&&c!==r.SCENE_ID&&(a[c]=f[c]);"tc"===g&&(a[r.LIST_TYPE]="t"),b.trigger("newLine",{line:d+1,attr:a})}))}else a.replaceSelection("\n","end","+input");setTimeout(function(){b.updateCurrentAttributes_(),b.updateToolbar()},100)},b.prototype.deleteLeft=function(){var a=this.codeMirror,b=a.getCursor("head"),c=this.getLineAttributes_(b.line),d=c[r.LIST_TYPE],e=c[r.LINE_INDENT],f=this.emptySelection_()&&1===b.ch,g=b.line>a.firstLine()?a.getLine(b.line-1):"",h=b.line>a.firstLine()?this.areLineSentinelCharacters_(g):!1;f&&d?this.updateLineAttributes(b.line,b.line,function(a){delete a[r.LIST_TYPE],delete a[r.LINE_INDENT]}):f&&e&&e>0?this.unindent():h?a.replaceRange("",{line:b.line-1,ch:0},{line:b.line,ch:0},"+input"):a.deleteH(-1,"char")},b.prototype.deleteRight=function(){var a=this.codeMirror,b=a.getCursor("head"),c=a.getLine(b.line),d=this.areLineSentinelCharacters_(c),e=b.line+1<a.lineCount()?a.getLine(b.line+1):"";this.emptySelection_()&&d&&e[0]===w?(a.replaceRange("",{line:b.line,ch:0},{line:b.line+1,ch:0},"+input"),a.setCursor({line:b.line,ch:0})):a.deleteH(1,"char")},b.prototype.indent=function(){this.updateLineAttributesForSelection(function(a){var b=a[r.LINE_INDENT],c=a[r.LIST_TYPE];b?a[r.LINE_INDENT]++:c?a[r.LINE_INDENT]=2:a[r.LINE_INDENT]=1})},b.prototype.unindent=function(){this.updateLineAttributesForSelection(function(a){var b=a[r.LINE_INDENT];b&&b>1?a[r.LINE_INDENT]=b-1:(delete a[r.LIST_TYPE],delete a[r.LINE_INDENT])})},b.prototype.getText=function(){return this.codeMirror.getValue().replace(new RegExp(w,"g"),"")},b.prototype.areLineSentinelCharacters_=function(a){for(var b=0;b<a.length;b++)if(a[b]!==w)return!1;return!0},e.prototype.equals=function(a){if(!(a instanceof e))return!1;var b;for(b in this.attributes)if(a.attributes[b]!==this.attributes[b])return!1;for(b in a.attributes)if(a.attributes[b]!==this.attributes[b])return!1;return!0},b}();var d=d||{};d.RichTextCodeMirrorAdapter=function(){"use strict";function a(a){this.rtcm=a,this.cm=a.codeMirror,g(this,"onChange"),g(this,"onAttributesChange"),g(this,"onCursorActivity"),g(this,"onFocus"),g(this,"onBlur"),this.rtcm.on("change",this.onChange),this.rtcm.on("attributesChange",this.onAttributesChange),this.cm.on("cursorActivity",this.onCursorActivity),this.cm.on("focus",this.onFocus),this.cm.on("blur",this.onBlur)}function b(a,b){return a.line<b.line?-1:a.line>b.line?1:a.ch<b.ch?-1:a.ch>b.ch?1:0}function c(a,c){return 0===b(a,c)}function e(a){var b=a.lineCount()-1;return a.indexFromPos({line:b,ch:a.getLine(b).length})}function f(a,b){if(!a)throw new Error(b||"assertion error")}function g(a,b){var c=a[b];a[b]=function(){c.apply(a,arguments)}}function h(a){for(var b in a)return!1;return!0}function i(a,b){if("string"!=typeof a)throw new TypeError("Expected a string");a=a.replace(/^#/,""),3===a.length&&(a=a[0]+a[0]+a[1]+a[1]+a[2]+a[2]);var c=parseInt(a,16),d=[c>>16,c>>8&255,255&c],e="rgb";return j(b)&&(e="rgba",d.push(b)),e+"("+d.join(",")+")"}function j(a){return null!==a&&void 0!==a}var k=d.TextOperation,l=d.WrappedOperation,m=d.Cursor;return a.prototype.detach=function(){this.rtcm.off("change",this.onChange),this.rtcm.off("attributesChange",this.onAttributesChange),this.cm.off("cursorActivity",this.onCursorActivity),this.cm.off("focus",this.onFocus),this.cm.off("blur",this.onBlur)},a.operationFromCodeMirrorChanges=function(a,b){for(var c=e(b),d=(new k).retain(c),f=(new k).retain(c),g=a.length-1;g>=0;g--){var h=a[g],i=h.start,j=c-i-h.text.length;d=(new k).retain(i)["delete"](h.removed.length).insert(h.text,h.attributes).retain(j).compose(d),f=f.compose((new k).retain(i)["delete"](h.text.length).insert(h.removed,h.removedAttributes).retain(j)),c+=h.removed.length-h.text.length}return[d,f]},a.operationFromAttributesChanges=function(a,b){for(var c=e(b),d=new k,g=new k,h=0,i=0;i<a.length;i++){var j=a[i],l=j.start-h;f(l>=0),d.retain(l),g.retain(l);var m=j.end-j.start;d.retain(m,j.attributes),g.retain(m,j.attributesInverse),h=j.start+m}return d.retain(c-h),g.retain(c-h),[d,g]},a.prototype.registerCallbacks=function(a){this.callbacks=a},a.prototype.onChange=function(b,c){if("RTCMADAPTER"!==c[0].origin){var d=a.operationFromCodeMirrorChanges(c,this.cm);this.trigger("change",d[0],d[1])}},a.prototype.onAttributesChange=function(b,c){if("RTCMADAPTER"!==c[0].origin){var d=a.operationFromAttributesChanges(c,this.cm);this.trigger("change",d[0],d[1])}},a.prototype.onCursorActivity=function(){var a=this;setTimeout(function(){a.trigger("cursorActivity")},1)},a.prototype.onFocus=function(){this.trigger("focus")},a.prototype.onBlur=function(){this.cm.somethingSelected()||this.trigger("blur")},a.prototype.getValue=function(){return this.cm.getValue()},a.prototype.getCursor=function(){var a,b=this.cm,d=b.getCursor(),e=b.indexFromPos(d);if(b.somethingSelected()){var f=b.getCursor(!0),g=c(d,f)?b.getCursor(!1):f;a=b.indexFromPos(g)}else a=e;return new m(e,a)},a.prototype.setCursor=function(a){this.cm.setSelection(this.cm.posFromIndex(a.position),this.cm.posFromIndex(a.selectionEnd))},a.prototype.addStyleRule=function(a){if("undefined"!=typeof document&&null!==document){if(!this.addedStyleRules){this.addedStyleRules={};var b=document.createElement("style");document.documentElement.getElementsByTagName("head")[0].appendChild(b),this.addedStyleSheet=b.sheet}if(!this.addedStyleRules[a])return this.addedStyleRules[a]=!0,this.addedStyleSheet.insertRule(a,0)}},a.prototype.setOtherCursor=function(a,b,c,d,e){var f=this.cm.posFromIndex(b.position),g=this.rtcm.end();if("string"==typeof c&&c.match(/^#[a-fA-F0-9]{3,6}$/)&&"object"==typeof b&&"number"==typeof b.position&&"number"==typeof b.selectionEnd&&!(b.position<0||b.position>g||b.selectionEnd<0||b.selectionEnd>g)){var h=[];if(b.position!==b.selectionEnd){var j="selection-"+c.replace("#",""),k=.4,l="."+j+" { background: "+i(c)+";\n background: "+i(c,k)+";}";this.addStyleRule(l);var m,n;b.selectionEnd>b.position?(m=f,n=this.cm.posFromIndex(b.selectionEnd)):(m=this.cm.posFromIndex(b.selectionEnd),n=f),h.push(this.cm.markText(m,n,{className:j}))}var o=document.createElement("div");o.style.color="white",o.style.display="block",o.innerHTML='<span style="position: absolute; background-color: '+c+'; top: -18px; left: -2px; padding: 0 4px; font-size: .9rem; white-space: nowrap;">'+e+"</span>";var p=document.createElement("span");p.className="other-client",p.style.width="2px",p.style.backgroundColor=c,p.style.marginLeft=p.style.marginRight="-1px",p.style.height="20px",p.setAttribute("data-clientid",d),
p.style.zIndex=0,p.style.position="absolute",p.innerHTML='<div style="position: absolute; height: 20px; top: -4px; margin-left: -2px;"><div style="width: 6px; height: 6px; background:'+c+' "></div></div>',p.appendChild(o);var q=!1,r=function(){setTimeout(function(){q||(o.style.display="none")},2e3)};return p.addEventListener("mouseover",function(){p.parentNode&&(q=!0,o.style.display="block")}),p.addEventListener("mouseout",function(){q=!1,r()}),h.push(this.cm.setBookmark(f,{widget:p,insertLeft:!0})),r(),h}},a.prototype.trigger=function(a){var b=Array.prototype.slice.call(arguments,1),c=this.callbacks&&this.callbacks[a];c&&c.apply(this,b)},a.prototype.applyOperation=function(a){a.ops.length>10&&this.rtcm.codeMirror.getWrapperElement().setAttribute("style","display: none");for(var b=a.ops,c=0,d=0,e=b.length;e>d;d++){var f=b[d];f.isRetain()?(h(f.attributes)||this.rtcm.updateTextAttributes(c,c+f.chars,function(a){for(var b in f.attributes)f.attributes[b]===!1?delete a[b]:a[b]=f.attributes[b]},"RTCMADAPTER",!0),c+=f.chars):f.isInsert()?(this.rtcm.insertText(c,f.text,f.attributes,"RTCMADAPTER"),c+=f.text.length):f.isDelete()&&this.rtcm.removeText(c,c+f.chars,"RTCMADAPTER")}a.ops.length>10&&(this.rtcm.codeMirror.getWrapperElement().setAttribute("style",""),this.rtcm.codeMirror.refresh())},a.prototype.registerUndo=function(a){this.cm.undo=a},a.prototype.registerRedo=function(a){this.cm.redo=a},a.prototype.invertOperation=function(a){for(var b,c,d=0,e=this.rtcm.codeMirror,f=new k,g=0;g<a.wrapped.ops.length;g++){var i=a.wrapped.ops[g];if(i.isRetain())if(h(i.attributes))f.retain(i.chars),d+=i.chars;else for(b=this.rtcm.getAttributeSpans(d,d+i.chars),c=0;c<b.length;c++){var j={};for(var m in i.attributes){var n=i.attributes[m],o=b[c].attributes[m];n===!1?o&&(j[m]=o):n!==o&&(j[m]=o||!1)}f.retain(b[c].length,j),d+=b[c].length}else if(i.isInsert())f["delete"](i.text.length);else if(i.isDelete()){var p=e.getRange(e.posFromIndex(d),e.posFromIndex(d+i.chars));b=this.rtcm.getAttributeSpans(d,d+i.chars);var q=0;for(c=0;c<b.length;c++)f.insert(p.substr(q,b[c].length),b[c].attributes),q+=b[c].length;d+=i.chars}}return new l(f,a.meta.invert())},a}();var d=d||{};d.Formatting=function(){function a(b){return this instanceof a?void(this.attributes=b||{}):new a(b)}var b=d.AttributeConstants;return a.prototype.cloneWithNewAttribute_=function(b,c){var d={};for(var e in this.attributes)d[e]=this.attributes[e];return c===!1?delete d[b]:d[b]=c,new a(d)},a.prototype.bold=function(a){return this.cloneWithNewAttribute_(b.BOLD,a)},a.prototype.italic=function(a){return this.cloneWithNewAttribute_(b.ITALIC,a)},a.prototype.underline=function(a){return this.cloneWithNewAttribute_(b.UNDERLINE,a)},a.prototype.strike=function(a){return this.cloneWithNewAttribute_(b.STRIKE,a)},a.prototype.font=function(a){return this.cloneWithNewAttribute_(b.FONT,a)},a.prototype.fontSize=function(a){return this.cloneWithNewAttribute_(b.FONT_SIZE,a)},a.prototype.color=function(a){return this.cloneWithNewAttribute_(b.COLOR,a)},a.prototype.backgroundColor=function(a){return this.cloneWithNewAttribute_(b.BACKGROUND_COLOR,a)},a}();var d=d||{};d.Text=function(){function a(b,c){return this instanceof a?(this.text=b,void(this.formatting=c||d.Formatting())):new a(b,c)}return a}();var d=d||{};d.LineFormatting=function(){function a(c){return this instanceof a?(this.attributes=c||{},void(this.attributes[b.LINE_SENTINEL]=!0)):new a(c)}var b=d.AttributeConstants;return a.LIST_TYPE={NONE:!1,ORDERED:"o",UNORDERED:"u",TODO:"t",TODOCHECKED:"tc"},a.prototype.cloneWithNewAttribute_=function(b,c){var d={};for(var e in this.attributes)d[e]=this.attributes[e];return c===!1?delete d[b]:d[b]=c,new a(d)},a.prototype.indent=function(a){return this.cloneWithNewAttribute_(b.LINE_INDENT,a)},a.prototype.align=function(a){return this.cloneWithNewAttribute_(b.LINE_ALIGN,a)},a.prototype.setClass=function(a){return this.cloneWithNewAttribute_(b.LINE_CLASS,a)},a.prototype.setClassType=function(a){return this.cloneWithNewAttribute_(b.LINE_CLASS_TYPE,a)},a.prototype.listItem=function(a){return d.utils.assert(a===!1||"u"===a||"o"===a||"t"===a||"tc"===a),this.cloneWithNewAttribute_(b.LIST_TYPE,a)},a.prototype.getIndent=function(){return this.attributes[b.LINE_INDENT]||0},a.prototype.getAlign=function(){return this.attributes[b.LINE_ALIGN]||0},a.prototype.getClass=function(){return this.attributes[b.LINE_CLASS]||""},a.prototype.getClassType=function(){return this.attributes[b.LINE_CLASS_TYPE]||""},a.prototype.getListItem=function(){return this.attributes[b.LIST_TYPE]||!1},a}();var d=d||{};d.Line=function(){function a(b,c){return this instanceof a?("[object Array]"!==Object.prototype.toString.call(b)&&(b="undefined"==typeof b?[]:[b]),this.textPieces=b,void(this.formatting=c||d.LineFormatting())):new a(b,c)}return a}();var d=d||{};d.ParseHtml=function(){function a(a,b,c){this.listType=a||i.UNORDERED,this.lineFormatting=b||d.LineFormatting(),this.textFormatting=c||d.Formatting()}function b(){this.lines=[],this.currentLine=[],this.currentLineListItemType=null}function c(c,f){var g=(d.document||document).createElement("div");g.innerHTML=c,j=f;var h=new b,i=new a;return e(g,i,h),h.lines}function e(a,b,c){if(a.nodeType===k.ELEMENT_NODE){var e=j.fromElement(a);if(e)return void c.currentLine.push(new d.Text(d.sentinelConstants.ENTITY_SENTINEL_CHARACTER,new d.Formatting(e.toAttributes())))}switch(a.nodeType){case k.TEXT_NODE:var l=a.nodeValue.replace(/[ \n\t]+/g," ");c.currentLine.push(d.Text(l,b.textFormatting));break;case k.ELEMENT_NODE:var m=a.getAttribute("style")||"";b=h(b,m);var n=a.getAttribute("class")||"";n&&b.lineFormatting.setClass(n);var o=a.getAttribute("class-type")||"";switch(o&&b.lineFormatting.setClassType(o),a.nodeName.toLowerCase()){case"div":case"h1":case"h2":case"h3":case"p":c.newlineIfNonEmpty(b),f(a,b,c),c.newlineIfNonEmpty(b);break;case"center":b=b.withAlign("center"),c.newlineIfNonEmpty(b),f(a,b.withAlign("center"),c),c.newlineIfNonEmpty(b);break;case"b":case"strong":f(a,b.withTextFormatting(b.textFormatting.bold(!0)),c);break;case"u":f(a,b.withTextFormatting(b.textFormatting.underline(!0)),c);break;case"i":case"em":f(a,b.withTextFormatting(b.textFormatting.italic(!0)),c);break;case"s":f(a,b.withTextFormatting(b.textFormatting.strike(!0)),c);break;case"font":var p=a.getAttribute("face"),q=a.getAttribute("color"),r=parseInt(a.getAttribute("size"));p&&(b=b.withTextFormatting(b.textFormatting.font(p))),q&&(b=b.withTextFormatting(b.textFormatting.color(q))),r&&(b=b.withTextFormatting(b.textFormatting.fontSize(r))),f(a,b,c);break;case"br":c.newline(b);break;case"ul":c.newlineIfNonEmptyOrListItem(b);var s="firepad-todo"===a.getAttribute("class")?i.TODO:i.UNORDERED;f(a,b.withListType(s).withIncreasedIndent(),c),c.newlineIfNonEmpty(b);break;case"ol":c.newlineIfNonEmptyOrListItem(b),f(a,b.withListType(i.ORDERED).withIncreasedIndent(),c),c.newlineIfNonEmpty(b);break;case"li":g(a,b,c);break;case"style":break;default:f(a,b,c)}}}function f(a,b,c){if(a.hasChildNodes())for(var d=0;d<a.childNodes.length;d++)e(a.childNodes[d],b,c)}function g(a,b,c){c.newlineIfNonEmptyOrListItem(b);var d="firepad-checked"===a.getAttribute("class")?i.TODOCHECKED:b.listType;c.makeListItem(d);var e=c.currentLine;f(a,b,c),(e===c.currentLine||c.currentLine.length>0)&&c.newline(b)}function h(a,b){for(var c=a.textFormatting,e=a.lineFormatting,f=b.split(";"),g=0;g<f.length;g++){var h=f[g].split(":");if(2===h.length){var i=d.utils.trim(h[0]).toLowerCase(),j=d.utils.trim(h[1]).toLowerCase();switch(i){case"text-decoration":var k=j.indexOf("underline")>=0,l=j.indexOf("line-through")>=0;c=c.underline(k).strike(l);break;case"font-weight":var m="bold"===j||parseInt(j)>=600;c=c.bold(m);break;case"font-style":var n="italic"===j||"oblique"===j;c=c.italic(n);break;case"color":c=c.color(j);break;case"background-color":c=c.backgroundColor(j);break;case"text-align":e=e.align(j);break;case"font-size":var o=null,p=["px","pt","%","em","xx-small","x-small","small","medium","large","x-large","xx-large","smaller","larger"];d.utils.stringEndsWith(j,p)?o=j:parseInt(j)&&(o=parseInt(j)+"px"),o&&(c=c.fontSize(o));break;case"font-family":var q=d.utils.trim(j.split(",")[0]);q=q.replace(/['"]/g,""),q=q.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()}),c=c.font(q)}}}return a.withLineFormatting(e).withTextFormatting(c)}var i=d.LineFormatting.LIST_TYPE;a.prototype.withTextFormatting=function(b){return new a(this.listType,this.lineFormatting,b)},a.prototype.withLineFormatting=function(b){return new a(this.listType,b,this.textFormatting)},a.prototype.withListType=function(b){return new a(b,this.lineFormatting,this.textFormatting)},a.prototype.withIncreasedIndent=function(){var b=this.lineFormatting.indent(this.lineFormatting.getIndent()+1);return new a(this.listType,b,this.textFormatting)},a.prototype.withAlign=function(b){var c=this.lineFormatting.align(b);return new a(this.listType,c,this.textFormatting)},b.prototype.newlineIfNonEmpty=function(a){this.cleanLine_(),this.currentLine.length>0&&this.newline(a)},b.prototype.newlineIfNonEmptyOrListItem=function(a){this.cleanLine_(),(this.currentLine.length>0||null!==this.currentLineListItemType)&&this.newline(a)},b.prototype.newline=function(a){this.cleanLine_();var b=a.lineFormatting;null!==this.currentLineListItemType&&(b=b.listItem(this.currentLineListItemType),this.currentLineListItemType=null),this.lines.push(d.Line(this.currentLine,b)),this.currentLine=[]},b.prototype.makeListItem=function(a){this.currentLineListItemType=a},b.prototype.cleanLine_=function(){if(this.currentLine.length>0){var a=this.currentLine.length-1;this.currentLine[0].text=this.currentLine[0].text.replace(/^ +/,""),this.currentLine[a].text=this.currentLine[a].text.replace(/ +$/g,"");for(var b=0;b<this.currentLine.length;b++)this.currentLine[b].text=this.currentLine[b].text.replace(/\u00a0/g," ")}1===this.currentLine.length&&""===this.currentLine[0].text&&(this.currentLine=[])};var j,k=k||{ELEMENT_NODE:1,TEXT_NODE:3};return c}();var d=d||{};d.SerializeHtml=function(){function a(a){return a===i.ORDERED?"<ol>":a===i.UNORDERED?"<ul>":'<ul class="firepad-todo">'}function b(a){return a===i.ORDERED?"</ol>":"</ul>"}function c(a,b){return a===b||a===i.TODO&&b===i.TODOCHECKED||a===i.TODOCHECKED&&b===i.TODO}function e(a){return a.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\u00a0/g,"&nbsp;")}function f(f,l){for(var m="",n=!0,o=[],p=!1,q=!0,r=!0,s=0,t=f.ops[s],u=0,v=!1;t;){g.assert(t.isInsert());var w=t.attributes;if(n){n=!1;var x=0,y=null,z="left",A="",B="",C="",D="";h.LINE_SENTINEL in w&&(x=w[h.LINE_INDENT]||0,y=w[h.LIST_TYPE]||null,z=w[h.LINE_ALIGN]||"left",A=w[h.LINE_CLASS]||"",B=w[h.LINE_CLASS_TYPE]||"",C=w[h.SCENE_CODE]||"",D=w[h.SCENE_ID]||""),y&&(x=x||1),p?(m+="</li>",p=!1):q||(r&&(m+="<br/>"),m+="</div>"),q=!1,g.assert(x>=0,"Indent must not be negative.");for(;o.length>x||x===o.length&&null!==y&&!c(y,o[o.length-1]);)m+=b(o.pop());for(;o.length<x;){var E=y||i.UNORDERED;v=y==i.TODO||y==i.TODOCHECKED||v,m+=a(E),o.push(E)}var F="left"!==z?' style="text-align:'+z+'"':"",G="";if(y){switch(y){case i.TODOCHECKED:G=' class="firepad-checked"';break;case i.TODO:G=' class="firepad-unchecked"'}m+="<li"+G+F+">",p=!0}else{G=A?' class="'+A+'"':"";var H=B?' class-type="'+B+'"':"",I=C?"<span class='scene-code-print' >"+C+"</span>":"",J=D?' scene-id="'+D+'"':"";m+="<div"+G+H+J+F+">"+I}r=!0}if(h.LINE_SENTINEL in w)t=f.ops[++s];else if(h.ENTITY_SENTINEL in w){for(var K=0;K<t.text.length;K++){var L=d.Entity.fromAttributes(w),M=l.exportToElement(L);m+=M.outerHTML}t=f.ops[++s]}else{var N="",O="";for(var P in w){var Q,R,S=w[P];P===h.BOLD||P===h.ITALIC||P===h.UNDERLINE||P===h.STRIKE?(g.assert(S===!0),Q=R=P):P===h.FONT_SIZE?(Q='span style="font-size: '+S,Q+="string"!=typeof S||-1===S.indexOf("px",S.length-2)?'px"':'"',R="span"):P===h.FONT?(Q='span style="font-family: '+S+'"',R="span"):P===h.COLOR?(Q='span style="color: '+S+'"',R="span"):P===h.BACKGROUND_COLOR&&(Q='span style="background-color: '+S+'"',R="span"),Q&&(N+="<"+Q+">"),R&&(O="</"+R+">"+O)}var T=t.text,U=T.indexOf("\n");U>=0?(n=!0,t=U<T.length-1?new d.TextOp("insert",T.substr(U+1),w):f.ops[++s],T=T.substr(0,U)):t=f.ops[++s],T=T.replace(/  +/g,function(a){return new Array(a.length+1).join(" ")}).replace(/^ /," ").replace(/ $/," "),T.length>0&&(r=!1);var V="",W=!w[h.LINE_CLASS]||"pc-action"===w[h.LINE_CLASS];50>u?u+=T.length>=80?parseInt(T.length/80)+1+(W?1:0):(W?1:0)+1:(V="<span style='display:block; page-break-after:always;'></span>",u=0),m+=N+e(T)+V+O}}for(p?m+="</li>":q||(r&&(m+="&nbsp;"),m+="</div>");o.length>0;)m+=b(o.pop());return v&&(m=j+m),k+"<div class='CodeMirror'>"+m+"</div>"}var g=d.utils,h=d.AttributeConstants,i=d.LineFormatting.LIST_TYPE,j='<style>ul.firepad-todo { list-style: none; margin-left: 0; padding-left: 0; } ul.firepad-todo > li { padding-left: 1em; text-indent: -1em; } ul.firepad-todo > li:before { content: "\\2610"; padding-right: 5px; } ul.firepad-todo > li.firepad-checked:before { content: "\\2611"; padding-right: 5px; }</style>\n',k='<style> @page { size: A4; margin-top: 1in; margin-right: 1in; margin-bottom: 1in; margin-left: 1.5in; } @media print { * { font-size: 12pt !important; } .CodeMirror { width: 8.3in; } } .CodeMirror:after { font-family: monospace; } .b { font-weight: bold; } .i { font-style: italic; } .u { text-decoration: underline; } .s { text-decoration: line-through; } .u.s { text-decoration: underline line-through; } .f-arial { font-family: Arial, Helvetica, sans-serif; } .left { text-align: left; } .center { text-align: center; } .right { text-align: right; }  .pc-scene { text-align: left; text-transform: uppercase; font-weight: bold; } .pc-action { text-align: left; padding: 12pt 0 !important; } .pc-character { padding-left: 2.5in !important; padding-right: 0 !important; text-transform: uppercase; } .pc-dialogue { margin-left: 1.5in !important; width: 3.5in !important; } .pc-parenthetical { padding-left: 2in !important; padding-right: 1.5in !important; } .pc-transition { text-align: right; text-transform: uppercase; } .-pc-act-start { text-align: center; text-transform: uppercase; text-decoration: underline; } .-pc-act-end { text-align: center; text-transform: uppercase; text-decoration: underline; } .-pc-centered { text-align: center; } pre.o, pre.u, pre.t, pre.tc { padding-left: 40px; } .list-left { display: inline-block; margin-left: -40px; width: 40px; padding-right: 5px; text-align: right; } .todo-left { display: inline-block; margin-left: -20px; width: 20px; } .btn-group { margin: 5px 7px 0 0; display: inline-block; } a.btn, a.btn:visited, a.btn:active { font-family: "Arial" sans-serif; cursor: pointer; text-decoration: none; padding: 6px 6px 4px 6px; text-align: center; vertical-align: middle; font-size: 14px; background-color: #fcfcfc; border: 1px solid #c9c9c9; color: grey; } a.btn:hover, a.btn-selected { color: #fff; background-color: dimgrey; text-decoration: none; } a.btn-selected-auto { color: #fff; background-color: dimgrey; text-decoration: none; opacity: 0.5; } a.btn:active { -webkit-box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.05); -moz-box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.05); box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.05); } .btn-group > .btn { -webkit-border-radius: 0; -moz-border-radius: 0; border-radius: 0; margin-left: -1px; } .btn-group > .btn:first-child { border-bottom-left-radius: 6px; border-top-left-radius: 6px; -webkit-border-bottom-left-radius: 6px; -webkit-border-top-left-radius: 6px; -moz-border-radius-bottomleft: 6px; -moz-border-radius-topleft: 6px; margin-left: 0px; } .btn-group > .btn:last-child { border-bottom-right-radius: 6px; border-top-right-radius: 6px; -webkit-border-bottom-right-radius: 6px; -webkit-border-top-right-radius: 6px; -moz-border-radius-bottomright: 6px; -moz-border-radius-topright: 6px; } .dropdown { position: relative; } .dropdown-menu { position: absolute; top: 100%; left: 0; z-index: 1000; display: none; float: left; padding: 4px 0; margin: 4px 0 0; list-style: none; background-color: #ffffff; border: 1px solid #ccc; border: 1px solid rgba(0, 0, 0, 0.2); *border-right-width: 2px; *border-bottom-width: 2px; -webkit-border-radius: 5px; -moz-border-radius: 5px; border-radius: 5px; -webkit-box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2); -moz-box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2); box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2); -webkit-background-clip: padding-box; -moz-background-clip: padding; background-clip: padding-box; } .dropdown-menu a { text-align: left; display: block; padding: 3px 15px; clear: both; font-weight: normal; line-height: 18px; color: #333333; white-space: nowrap; } .dropdown-menu a:hover { color: #fff; text-decoration: none; background-color: #ffbf86; } .color-dropdown-item { height: 25px; width: 25px; } .dialog { position: absolute; left: 0px; top: 0px; width: 100%; height: 100%; z-index: 1000; } .dialog-div { position: relative; width: 400px; height: 100px; margin: 100px auto; background-color: #fff; border: 1px solid #000; padding: 15px; } .dialog-input { width: 80%; display: block; padding: 5px 5px; margin: 10px 10px 10px 5px; clear: both; font-weight: normal; line-height: 25px; color: #333333; white-space: nowrap; } @font-face { font-family: "firepad"; src: url("firepad.woff"); } .bold, .italic, .underline, .strikethrough, .list, .list-2, .numbered-list, .paragraph-left, .paragraph-center, .paragraph-right, .paragraph-justify, .menu, .link, .undo, .redo, .box-add, .box-remove, .print, .indent-decrease, .indent-increase, .insert-image, .bubble { font-family: "firepad"; speak: none; font-style: normal; font-weight: normal; font-variant: normal; text-transform: none; line-height: 1; -webkit-font-smoothing: antialiased; } .bold:before { content: "e000"; } .italic:before { content: "e001"; } .underline:before { content: "e002"; } .strikethrough:before { content: "e003"; } .list:before { content: "e004"; } .list-2:before { content: "e005"; } .numbered-list:before { content: "e006"; } .paragraph-left:before { content: "e007"; } .paragraph-center:before { content: "e008"; } .paragraph-right:before { content: "e009"; } .paragraph-justify:before { content: "e00a"; } .menu:before { content: "e00b"; } .link:before { content: "e00c"; } .undo:before { content: "e00d"; } .redo:before { content: "e00e"; } .box-add:before { content: "e010"; } .box-remove:before { content: "e011"; } .print:before { content: "e012"; } .indent-decrease:before { content: "e013"; } .indent-increase:before { content: "e014"; } .insert-image:before { content: "e015"; } .bubble:before { content: "e00f"; } .scene, .action, .character, .dialogue, .parenthetical, .transition, .act-start, .act-end, .centered, .auto-format { font-family: "firepad"; speak: none; font-style: normal; font-weight: normal; font-variant: normal; text-transform: none; line-height: 1; -webkit-font-smoothing: antialiased; } .scene:before { content: "Scene"; font-family: monospace; } .action:before { content: "Action"; font-family: monospace; } .character:before { content: "Character"; font-family: monospace; } .dialogue:before { content: "Dialogue"; font-family: monospace; } .parenthetical:before { content: "Parenthetical"; font-family: monospace; } .transition:before { content: "Transition"; font-family: monospace; } .act-start:before { content: "Act Start"; font-family: monospace; } .act-end:before { content: "Act End"; font-family: monospace; } .centered:before { content: "e008"; } .pc-auto-format:before { content: "Auto Format"; font-family: monospace; } .scene-start { height: 25px; border-top: 1px solid lightgrey; } .scene-end { height: 15px; } .scene-end-with-border { height: 15px; border-bottom: 1px solid lightgrey; } .secondary-scene { background-color: #f3f3f3; color: #4c4c4c; } </style>\n';return f}();var d=d||{};d.SerializeJson=function(){function a(a,e){function f(a,b,c,d,e){const f={format:a.replace("pc-",""),content:d};b&&(f.scene_code=b),c&&(f.scene_id=c),k.size+=e,k.lines.push(f)}for(var g=!0,h=!0,i=0,j=a.ops[i],k={size:0,lines:[]},l="",m="",n="",o=0,p=[];j;){b.assert(j.isInsert());var q=j.attributes;if(g&&(g=!1,h||(f(l,m,n,p,o),l="",m="",n="",o=0,p=[]),h=!1,c.LINE_SENTINEL in q&&(l=q[c.LINE_CLASS]||"",m=q[c.SCENE_CODE]||"",n=q[c.SCENE_ID]||"")),c.LINE_SENTINEL in q||c.ENTITY_SENTINEL in q)j=a.ops[++i];else{var r=j.text,s=r.indexOf("\n");s>=0?(g=!0,j=s<r.length-1?new d.TextOp("insert",r.substr(s+1),q):a.ops[++i],r=r.substr(0,s)):j=a.ops[++i];var t={};for(var u in q){var v=q[u];if(e){var w=c.ELEMENT+"-"+e;u===w&&(t.element_id=v)}else u===c.THREAD&&(t.thread_id=v)}o+=r.length,e?p.length>0&&p[p.length-1].attrs.element_id===t.element_id?p[p.length-1].text+=r:p.push({text:r,attrs:t}):p.length>0&&p[p.length-1].attrs.thread_id===t.thread_id?p[p.length-1].text+=r:p.push({text:r,attrs:t})}}return h||f(l,m,n,p,o),k}var b=d.utils,c=d.AttributeConstants;return a}();var d=d||{};d.SerializePdfMake=function(){function a(a,e){function f(a,b,c,d,e){var f=a.replace("pc-","");"scene"===f||"character"===f||"transition"===f?d=d.toUpperCase():"act-start"===f||"act-end"===f?f="centered":""===f&&(f="action");const g={text:d,style:f};b&&(g.text=b+"  "+g.text,g.sceneCode=b),c&&(g.sceneId=c),l.content.push(g),l.size+=e}var g=!0,h=!0,i=0,j=a.ops[i],k={fontSize:11};e&&(k.font=e);for(var l={size:0,content:[],pageSize:"LETTER",pageOrientation:"portrait",pageMargins:[108,92,72,72],defaultStyle:k,styles:{scene:{margin:[0,24,0,0],bold:!0},action:{margin:[0,12,0,0]},character:{margin:[144,12,18,0]},dialogue:{margin:[72,0,108,0]},parenthetical:{margin:[108,0,144,0]},transition:{margin:[0,12,0,0],alignment:"right"},centered:{margin:[0,12,0,0],alignment:"center"}},header:function(a,b,c){var d=a.toString()+".";return{text:d,alignment:"right",margin:[0,72,72,0]}}},m="",n="",o="",p="",q=0;j;){b.assert(j.isInsert());var r=j.attributes;if(g&&(g=!1,h||(f(m,n,o,p,q),m="",n="",o="",p="",q=0),h=!1,c.LINE_SENTINEL in r&&(m=r[c.LINE_CLASS]||"",n=r[c.SCENE_CODE]||"",o=r[c.SCENE_ID]||"")),c.LINE_SENTINEL in r||c.ENTITY_SENTINEL in r)j=a.ops[++i];else{var s=j.text,t=s.indexOf("\n");t>=0?(g=!0,j=t<s.length-1?new d.TextOp("insert",s.substr(t+1),r):a.ops[++i],s=s.substr(0,t)):j=a.ops[++i],p+=s,q+=s.length}}return h||f(m,n,o,p,q),l}var b=d.utils,c=d.AttributeConstants;return a}();var d=d||{};d.SerializeText=function(){function a(a){function e(a,b){const c=a.replace("pc-","");j+='{line format="'+c+'"}'+b+"\n"}for(var f=!0,g=!0,h=0,i=a.ops[h],j="",k="",l="";i;){b.assert(i.isInsert());var m=i.attributes;if(f&&(f=!1,g||(e(k,l),k="",l=""),g=!1,c.LINE_SENTINEL in m&&(k=m[c.LINE_CLASS]||"")),c.LINE_SENTINEL in m||c.ENTITY_SENTINEL in m)i=a.ops[++h];else{var n=i.text,o=n.indexOf("\n");o>=0?(f=!0,i=o<n.length-1?new d.TextOp("insert",n.substr(o+1),m):a.ops[++h],n=n.substr(0,o)):i=a.ops[++h];var p=!1,q={};for(var r in m){var s=m[r],t=c.ELEMENT+"-",u=c.ELEMENT_COLOR+"-";if(0===r.indexOf(t)){var v=r.replace(t,"");q[v]||(q[v]={}),q[v].id=s,p=!0}if(0===r.indexOf(u)){var v=r.replace(u,"");q[v]||(q[v]={}),q[v].color=s}}var w="";if(p){var x="";for(var v in q)if(q.hasOwnProperty(v)){""!==x&&(x+="|");const y=q[v].id||"",z=q[v].color||"";x+=v+","+y+","+z}w='{elem attrs="'+x+'"}'+n+"{/elem}"}else w=n;l+=w}}return g||e(k,l),j}var b=d.utils,c=d.AttributeConstants;return a}();var d=d||{};d.textPiecesToInserts=function(a,b){function c(b,c){b instanceof d.Text&&(c=b.formatting.attributes,b=b.text),f.push({string:b,attributes:c}),a="\n"===b[b.length-1]}function e(b,e){a&&c(d.sentinelConstants.LINE_SENTINEL_CHARACTER,b.formatting.attributes);for(var f=0;f<b.textPieces.length;f++)c(b.textPieces[f]);e&&c("\n")}for(var f=[],g=0;g<b.length;g++)b[g]instanceof d.Line?e(b[g],g<b.length-1):c(b[g]);return f};var d=d||{};d.Headless=function(){function a(b){if(!(this instanceof a))return new a(b);var d,f;"string"==typeof b?(void 0===global.firebase&&"object"!=typeof d?(console.log("REQUIRING"),d=require("firebase")):d=global.firebase,f=d.database().refFromURL(b)):f=b,this.deviceId_="backend",this.ready_=!1,this.zombie_=!1,this.entityManager_=new e,this.firebaseAdapter_=new c(f,this.deviceId_);var g=this;g.firebaseAdapter_.on("ready",function(){g.ready_=!0})}var b=d.TextOperation,c=d.FirebaseAdapter,e=d.EntityManager,f=d.ParseHtml,g=d.sentinelConstants.TRIGGER_AUTOFORMAT_SENTINEL_CHARACTER,h=d.AttributeConstants;return a.prototype.getDocument=function(a){if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");if(this.ready_)return a(this.firebaseAdapter_.getDocument());var b=this;setTimeout(function(){b.getDocument(a)},100)},a.prototype.getDocumentAtRevision=function(a,b){if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");if(this.ready_)return this.firebaseAdapter_.getDocumentAtRevision(a,b);var c=this;setTimeout(function(){c.getDocumentAtRevision(a,b)},100)},a.prototype.getLastRevision=function(a){if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");if(this.ready_)return a(this.firebaseAdapter_.getLastRevision());var b=this;setTimeout(function(){b.getLastRevision(a)},100)},a.prototype.copyDocument=function(a,b){if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");var d=this,e=new c(a,this.deviceId_);e.on("ready",function(){d.getDocument(function(a){if(0===a.ops.length)return b(null);for(var c=0;c<a.ops.length;c++){var d=a.ops[c].attributes,f={};for(var g in d)g!==h.SCENE_CODE&&g!==h.SCENE_ID&&g!==h.SCENE_OMITTED&&g!==h.THREAD&&g!==h.DIFF&&0!==g.indexOf(h.ELEMENT+"-")&&0!==g.indexOf(h.ELEMENT_COLOR+"-")&&(f[g]=d[g]);a.ops[c].attributes=f}e.sendOperation(a,function(a){b(a)})})})},a.prototype.getText=function(a){if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");this.getDocument(function(b){var c=b.apply("");for(key in d.sentinelConstants)c=c.replace(new RegExp(d.sentinelConstants[key],"g"),"");a(c)})},a.prototype.setText=function(a,c){if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");a=g+a;var d=b().insert(a);this.sendOperationWithRetry(d,c)},a.prototype.initializeFakeDom=function(a){"object"==typeof document||"object"==typeof d.document?a():require("jsdom/lib/old-api.js").env("<head></head><body></body>",function(b,c){return d.document?(c.close(),a()):(d.document=c.document,void a())})},a.prototype.getJson=function(a,b,c){var e=this;if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");a?e.getDocumentAtRevision(a,function(a){c(d.SerializeJson(a,b))}):e.getDocument(function(a){c(d.SerializeJson(a,b))})},a.prototype.getJsonForPdfMake=function(a,b,c){var e=this;if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");a?e.getDocumentAtRevision(a,function(a){c(d.SerializePdfMake(a,b))}):e.getDocument(function(a){c(d.SerializePdfMake(a,b))})},a.prototype.getHtml=function(a){var b=this;if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");b.initializeFakeDom(function(){b.getDocument(function(c){a(d.SerializeHtml(c,b.entityManager_))})})},a.prototype.setHtml=function(a,c){var e=this;if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");e.initializeFakeDom(function(){for(var g=f(a,e.entityManager_),h=d.textPiecesToInserts(!0,g),i=new b,j=0;j<h.length;j++)i.insert(h[j].string,h[j].attributes);e.sendOperationWithRetry(i,c)})},a.prototype.sendOperationWithRetry=function(a,b){var c=this;c.getDocument(function(d){var e=a.clone()["delete"](d.targetLength);c.firebaseAdapter_.sendOperation(e,function(d,e){e?"undefined"!=typeof b&&b(null,e):c.sendOperationWithRetry(a,b)})})},a.prototype.dispose=function(){this.zombie_=!0,this.firebaseAdapter_.dispose()},a}();var d=d||{};if("undefined"==typeof CodeMirror&&"function"==typeof require)try{CodeMirror=require("codemirror")}catch(e){console.log("CodeMirror not found")}return d.Firepad=function(){function a(c,d,e){if(!(this instanceof a))return new a(c,d,e);if(!CodeMirror)throw new Error("Couldn't find CodeMirror.  Did you forget to include codemirror.js?");if(this.zombie_=!1,CodeMirror&&d instanceof CodeMirror){this.codeMirror_=this.editor_=d;var h=this.codeMirror_.getValue();if(""!==h)throw new Error("Can't initialize Firepad with a CodeMirror instance that already contains text.")}else this.codeMirror_=this.editor_=new CodeMirror(d);var i=this.codeMirror_.getWrapperElement();if(this.firepadWrapper_=n.elt("div",null,{"class":"firepad"}),i.parentNode.replaceChild(this.firepadWrapper_,i),this.firepadWrapper_.appendChild(i),n.on(i,"dragstart",n.stopEvent),this.editor_.firepad=this,this.options_=e||{},this.editorMode=this.getOption("mode","richtext"),this.toolbarEnabled=this.getOption("toolbar",!1),this.shortcutsEnabled=this.getOption("shortcuts",!1),this.imageInsertionUI=this.getOption("imageInsertionUI",!0),this.defaultText=this.getOption("defaultText",null),this.userId=this.getOption("userId",c.push().key),this.userColor=this.getOption("userColor",b(this.userId)),this.userName=this.getOption("userName",""),this.screenplayMode=this.getOption("screenplayMode","edit"),this.shootingEvent=this.getOption("shootingEvent",null),this.showComments=this.getOption("showComments",!1),this.showDiffAdditions=this.getOption("showDiffAdditions",!1),this.readOnly=this.getOption("readOnly",!1),this.options_.cssPrefix="firepad-",this.options_.screenplayMode=this.screenplayMode,this.options_.shootingEvent=this.shootingEvent,this.options_.showComments=this.showComments,this.options_.showDiffAdditions=this.showDiffAdditions,"richtext"===this.editorMode)this.firepadWrapper_.className+=" firepad-richtext";else{if("screenplay"!==this.editorMode)throw new Error("Invalid editor mode. The allowed values are 'richtext' and 'screenplay'.");if(this.firepadWrapper_.className+=" firepad-screenplay","tag"===this.screenplayMode){if(!this.shootingEvent)throw new Error("A shootingEvent is required for the screenplay tag mode.");this.codeMirror_.setOption("readOnly",!0),this.shortcutsEnabled=!1}}this.readOnly&&this.codeMirror_.setOption("readOnly",!0),this.shortcutsEnabled&&("richtext"===this.editorMode?(CodeMirror.keyMap.richtext||this.initializeRichtextKeyMap_(),this.codeMirror_.setOption("keyMap","richtext")):"screenplay"===this.editorMode&&(CodeMirror.keyMap.screenplay||this.initializeScreenplayKeyMap_(),this.codeMirror_.setOption("keyMap","screenplay"))),this.toolbarEnabled&&(this.firepadWrapper_.className+=" firepad-with-toolbar","richtext"===this.editorMode?this.addRichtextToolbar_():"screenplay"===this.editorMode&&this.addScreenplayToolbar_()),this.codeMirror_&&this.codeMirror_.refresh(),this.entityManager_=new l,this.firebaseAdapter_=new j(c,null,this.userId,this.userColor,this.userName),this.richTextCodeMirror_=new g(this.codeMirror_,this.entityManager_,this.firebaseAdapter_,this.options_),this.editorAdapter_=new f(this.richTextCodeMirror_),this.client_=new k(this.firebaseAdapter_,this.editorAdapter_);var m=this;this.firebaseAdapter_.on("cursor",function(){m.trigger.apply(m,["cursor"].concat([].slice.call(arguments)))}),this.codeMirror_&&this.richTextCodeMirror_.on("newLine",function(){m.trigger.apply(m,["newLine"].concat([].slice.call(arguments)))}),this.firebaseAdapter_.on("ready",function(){m.ready_=!0,m.richTextCodeMirror_.setReady(),m.defaultText&&m.isHistoryEmpty()&&m.setText(m.defaultText),"screenplay"===m.editorMode&&"tag"===m.screenplayMode?setTimeout(function(){m.richTextCodeMirror_.filterScenes(),m.trigger("ready")},0):m.trigger("ready")}),this.client_.on("synced",function(a){m.trigger("synced",a)}),"Microsoft Internet Explorer"==navigator.appName&&navigator.userAgent.match(/MSIE 8\./)&&(window.onload=function(){var a=document.getElementsByTagName("head")[0],b=document.createElement("style");b.type="text/css",b.styleSheet.cssText=":before,:after{content:none !important;}",
a.appendChild(b),setTimeout(function(){a.removeChild(b)},0)})}function b(a){for(var b=1,c=0;c<a.length;c++)b=17*(b+a.charCodeAt(c))%360;var d=b/360;return e(d,1,.75)}function c(a,b,c){function d(a){var b=Math.round(255*a).toString(16);return 1===b.length?"0"+b:b}return"#"+d(a)+d(b)+d(c)}function e(a,b,d){if(0===b)return c(d,d,d);var e=.5>d?d*(1+b):d+b-b*d,f=2*d-e,g=function(a){return 0>a&&(a+=1),a>1&&(a-=1),1>6*a?f+6*(e-f)*a:1>2*a?e:2>3*a?f+6*(e-f)*(2/3-a):f};return c(g(a+1/3),g(a),g(a-1/3))}if(!d.RichTextCodeMirrorAdapter)throw new Error("Oops! It looks like you're trying to include lib/firepad.js directly.  This is actually one of many source files that make up firepad.  You want dist/firepad.js instead.");var f=d.RichTextCodeMirrorAdapter,g=d.RichTextCodeMirror,h=d.RichTextToolbar,i=d.ScreenplayToolbar,j=d.FirebaseAdapter,k=d.EditorClient,l=d.EntityManager,m=d.AttributeConstants,n=d.utils;return n.makeEventEmitter(a),a.fromCodeMirror=a,a.prototype.dispose=function(){this.zombie_=!0;var a=this.codeMirror_.getWrapperElement();this.firepadWrapper_.removeChild(a),this.firepadWrapper_.parentNode.replaceChild(a,this.firepadWrapper_),this.editor_.firepad=null,!this.codeMirror_||"richtext"!==this.codeMirror_.getOption("keyMap")&&"screenplay"!==this.codeMirror_.getOption("keyMap")||this.codeMirror_.setOption("keyMap","default"),this.firebaseAdapter_.dispose(),this.editorAdapter_.detach(),this.richTextCodeMirror_&&this.richTextCodeMirror_.detach()},a.prototype.setUserId=function(a){this.userId=a,this.firebaseAdapter_.setUserId(a)},a.prototype.setUserColor=function(a){this.userColor=a,this.firebaseAdapter_.setColor(a)},a.prototype.setShootingEvent=function(a){if("screenplay"===this.editorMode&&"tag"===this.screenplayMode){this.shootingEvent=a,this.options_.shootingEvent=this.shootingEvent;var b=this;setTimeout(function(){b.richTextCodeMirror_.setShootingEvent(b.shootingEvent),b.trigger("ready")},0)}else console.log("Firepad: 'setShootingEvent' is only available for the screenplay tag mode")},a.prototype.onUsersChange=function(a){this.firebaseAdapter_.onUsersChange(a)},a.prototype.scrollToLine=function(a){this.richTextCodeMirror_.scrollToLine(a)},a.prototype.scrollToScene=function(a){this.richTextCodeMirror_.scrollToScene(a)},a.prototype.prepareForNewScene=function(){return this.readOnly?void console.log("Firepad: read only mode"):void this.richTextCodeMirror_.prepareForNewScene()},a.prototype.onCursorChange=function(a){this.richTextCodeMirror_.onCursorChange(a)},a.prototype.onScenesChange=function(a){this.richTextCodeMirror_.onScenesChange(a)},a.prototype.onLockedScenesDeleteIntent=function(a){this.richTextCodeMirror_.onLockedScenesDeleteIntent(a)},a.prototype.onLockedSceneTitleEdited=function(a){this.richTextCodeMirror_.onLockedSceneTitleEdited(a)},a.prototype.onVisibleThreadsChange=function(a){this.richTextCodeMirror_.onVisibleThreadsChange(a)},a.prototype.getRevisionsFromRevision=function(a,b){this.firebaseAdapter_.getRevisionsFromRevision(a,b)},a.prototype.getDocumentAtRevisionForDiff=function(a,b){if(!a)return b("");var c=this;c.firebaseAdapter_.getDocumentAtRevision(a,function(a){if(null===a)return b(null);var e=null;e="screenplay"===c.editorMode?d.SerializeText(a):d.SerializeHtml(a,c.entityManager_),b(e)})},a.prototype.getText=function(){return this.assertReady_("getText"),this.richTextCodeMirror_.getText()},a.prototype.setText=function(a){return this.assertReady_("setText"),this.readOnly?void console.log("Firepad: read only mode"):(this.codeMirror_.getWrapperElement().setAttribute("style","display: none"),this.codeMirror_.setValue(""),this.insertText(0,a),this.codeMirror_.getWrapperElement().setAttribute("style",""),this.codeMirror_.refresh(),void this.editorAdapter_.setCursor({position:0,selectionEnd:0}))},a.prototype.insertTextAtCursor=function(a){return this.readOnly?void console.log("Firepad: read only mode"):void this.insertText(this.codeMirror_.indexFromPos(this.codeMirror_.getCursor()),a)},a.prototype.insertText=function(a,b){if(this.assertReady_("insertText"),this.readOnly)return void console.log("Firepad: read only mode");"[object Array]"!==Object.prototype.toString.call(b)&&(b=[b]);var c=this;c.codeMirror_.operation(function(){for(var e=0===a,f=d.textPiecesToInserts(e,b),g=0;g<f.length;g++){var h=f[g].string,i=f[g].attributes;c.richTextCodeMirror_.insertText(a,h,i),a+=h.length}})},a.prototype.getOperationForSpan=function(a,b){for(var c=this.richTextCodeMirror_.getRange(a,b),e=this.richTextCodeMirror_.getAttributeSpans(a,b),f=0,g=new d.TextOperation,h=0;h<e.length;h++)g.insert(c.substr(f,e[h].length),e[h].attributes),f+=e[h].length;return g},a.prototype.getJson=function(a){if("screenplay"===this.editorMode){var b=this.getOperationForSpan(0,this.codeMirror_.getValue().length);return d.SerializeJson(b,a)}return console.log("Firepad: json serialization is only implemented for the screenplay format"),null},a.prototype.getJsonForPdfMake=function(a){if("screenplay"===this.editorMode){var b=this.getOperationForSpan(0,this.codeMirror_.getValue().length);return d.SerializePdfMake(b,a)}return console.log("Firepad: json for pdfmake serialization is only implemented for the screenplay format"),null},a.prototype.getTextFromSelection=function(){return this.richTextCodeMirror_.emptySelection_()&&this.richTextCodeMirror_.selectWord(),this.codeMirror_.getSelection()},a.prototype.getHtml=function(){return this.getHtmlFromRange(null,null)},a.prototype.getHtmlFromSelection=function(){var a=this.codeMirror_.getCursor("start"),b=this.codeMirror_.getCursor("end"),c=this.codeMirror_.indexFromPos(a),d=this.codeMirror_.indexFromPos(b);return this.getHtmlFromRange(c,d)},a.prototype.getHtmlFromRange=function(a,b){this.assertReady_("getHtmlFromRange");var c=null!=a&&null!=b?this.getOperationForSpan(a,b):this.getOperationForSpan(0,this.codeMirror_.getValue().length);return d.SerializeHtml(c,this.entityManager_)},a.prototype.insertHtml=function(a,b){if(this.readOnly)return void console.log("Firepad: read only mode");var c=d.ParseHtml(b,this.entityManager_);this.insertText(a,c)},a.prototype.insertHtmlAtCursor=function(a){return this.readOnly?void console.log("Firepad: read only mode"):void this.insertHtml(this.codeMirror_.indexFromPos(this.codeMirror_.getCursor()),a)},a.prototype.setHtml=function(a){if(this.readOnly)return void console.log("Firepad: read only mode");var b=d.ParseHtml(a,this.entityManager_);this.setText(b)},a.prototype.isHistoryEmpty=function(){return this.assertReady_("isHistoryEmpty"),this.firebaseAdapter_.isHistoryEmpty()},a.prototype.bold=function(){return this.readOnly?void console.log("Firepad: read only mode"):(this.richTextCodeMirror_.toggleAttribute(m.BOLD),void this.codeMirror_.focus())},a.prototype.italic=function(){return this.readOnly?void console.log("Firepad: read only mode"):(this.richTextCodeMirror_.toggleAttribute(m.ITALIC),void this.codeMirror_.focus())},a.prototype.underline=function(){return this.readOnly?void console.log("Firepad: read only mode"):(this.richTextCodeMirror_.toggleAttribute(m.UNDERLINE),void this.codeMirror_.focus())},a.prototype.strike=function(){return this.readOnly?void console.log("Firepad: read only mode"):(this.richTextCodeMirror_.toggleAttribute(m.STRIKE),void this.codeMirror_.focus())},a.prototype.fontSize=function(a){return this.readOnly?void console.log("Firepad: read only mode"):(this.richTextCodeMirror_.setAttribute(m.FONT_SIZE,a),void this.codeMirror_.focus())},a.prototype.font=function(a){return this.readOnly?void console.log("Firepad: read only mode"):(this.richTextCodeMirror_.setAttribute(m.FONT,a),void this.codeMirror_.focus())},a.prototype.color=function(a){return this.readOnly?void console.log("Firepad: read only mode"):(this.richTextCodeMirror_.setAttribute(m.COLOR,a),void this.codeMirror_.focus())},a.prototype.highlight=function(){return this.readOnly?void console.log("Firepad: read only mode"):(this.richTextCodeMirror_.toggleAttribute(m.BACKGROUND_COLOR,"rgba(255,255,0,.65)"),void this.codeMirror_.focus())},a.prototype.anchorThread=function(a){if(this.readOnly)return void console.log("Firepad: read only mode");var b=null;return"screenplay"===this.editorMode&&"edit"===this.screenplayMode?(b=this.richTextCodeMirror_.anchorThread(a),this.codeMirror_.focus()):console.log("Firepad: 'anchorThread' is only available for the screenplay edit mode"),b},a.prototype.setSelectedThread=function(a){if(this.readOnly)return void console.log("Firepad: read only mode");var b=null;return"screenplay"===this.editorMode&&"edit"===this.screenplayMode?(b=this.richTextCodeMirror_.setSelectedThread(a),this.codeMirror_.focus()):console.log("Firepad: 'setSelectedThread' is only available for the screenplay edit mode"),b},a.prototype.clearSelectedThread=function(a){if(this.readOnly)return void console.log("Firepad: read only mode");var b=null;return"screenplay"===this.editorMode&&"edit"===this.screenplayMode?(b=this.richTextCodeMirror_.clearSelectedThread(a),this.codeMirror_.focus()):console.log("Firepad: 'clearSelectedThread' is only available for the screenplay edit mode"),b},a.prototype.deleteThread=function(a){return this.readOnly?void console.log("Firepad: read only mode"):void("screenplay"===this.editorMode&&"edit"===this.screenplayMode?(this.richTextCodeMirror_.deleteThread(a),this.codeMirror_.focus()):console.log("Firepad: 'deleteThread' is only available for the screenplay edit mode"))},a.prototype.scrollToThread=function(a){"screenplay"===this.editorMode&&"edit"===this.screenplayMode?this.richTextCodeMirror_.scrollToThread(a):console.log("Firepad: 'scrollToThread' is only available for the screenplay edit mode")},a.prototype.getAddedDiffScenes=function(a){this.richTextCodeMirror_.getAddedDiffScenes(a)},a.prototype.getAddedDiffLines=function(a){"screenplay"===this.editorMode&&"tag"===this.screenplayMode?this.richTextCodeMirror_.getAddedDiffLines(a):console.log("Firepad: 'getDiffLines' is only available for the screenplay tag mode")},a.prototype.deleteAddedDiffs=function(a){return this.readOnly?void console.log("Firepad: read only mode"):void("screenplay"===this.editorMode&&"tag"===this.screenplayMode?this.richTextCodeMirror_.deleteAddedDiffs(a):console.log("Firepad: 'deleteDiffs' is only available for the screenplay tag mode"))},a.prototype.toggleElement=function(a,b){if(this.readOnly)return void console.log("Firepad: read only mode");var c=null;return"screenplay"===this.editorMode&&"tag"===this.screenplayMode?(c=this.richTextCodeMirror_.toggleElement(a,b),this.codeMirror_.focus()):console.log("Firepad: 'toggleElement' is only available for the screenplay tag mode"),c},a.prototype.deleteElement=function(a){return this.readOnly?void console.log("Firepad: read only mode"):void("screenplay"===this.editorMode&&"tag"===this.screenplayMode?(this.richTextCodeMirror_.deleteElements(a),this.codeMirror_.focus()):console.log("Firepad: 'deleteElement' is only available for the screenplay tag mode"))},a.prototype.deleteAllElements=function(){return this.readOnly?void console.log("Firepad: read only mode"):void("screenplay"===this.editorMode&&"tag"===this.screenplayMode?(this.richTextCodeMirror_.deleteElements(),this.codeMirror_.focus()):console.log("Firepad: 'deleteAllElements' is only available for the screenplay tag mode"))},a.prototype.getElements=function(){return"screenplay"===this.editorMode&&"tag"===this.screenplayMode?this.richTextCodeMirror_.getElements():void console.log("Firepad: 'getElements' is only available for the screenplay tag mode")},a.prototype.align=function(a){if(this.readOnly)return void console.log("Firepad: read only mode");if("left"!==a&&"center"!==a&&"right"!==a)throw new Error('align() must be passed "left", "center", or "right".');this.richTextCodeMirror_.setLineAttribute(m.LINE_ALIGN,a),this.codeMirror_.focus()},a.prototype.setLineClass=function(a){function b(){d.richTextCodeMirror_.setLineAttribute(m.LINE_CLASS,!1),d.richTextCodeMirror_.setLineAttribute(m.LINE_CLASS_TYPE,!1),d.richTextCodeMirror_.setLineAttribute(m.SCENE_CODE,!1),"pc-scene"===f&&setTimeout(function(){d.richTextCodeMirror_.recodeScenes()},0)}function c(){d.richTextCodeMirror_.setLineAttribute(m.LINE_CLASS,a),d.richTextCodeMirror_.setLineAttribute(m.LINE_CLASS_TYPE,"user"),"pc-scene"===a&&setTimeout(function(){d.richTextCodeMirror_.recodeScenes()},0)}if(this.readOnly)return void console.log("Firepad: read only mode");if("screenplay"===this.editorMode&&"edit"===this.screenplayMode){var d=this,e=d.richTextCodeMirror_.getCurrentLineAttributes_(),f=e[m.LINE_CLASS],g=e[m.SCENE_ID];if(g)return void console.log("Scene is locked");!a||f&&a&&f===a?b():"pc-scene"===f?(b(),c()):c(),setTimeout(function(){d.richTextCodeMirror_.updateToolbar()},100),d.codeMirror_.focus()}else console.log("Firepad: 'setLineClass' is only available for the screenplay edit mode")},a.prototype.deleteScene=function(a,b){if(this.readOnly)return void console.log("Firepad: read only mode");if("screenplay"===this.editorMode&&"edit"===this.screenplayMode){var c=this;setTimeout(function(){c.richTextCodeMirror_.deleteScene(a),b&&b()},0)}else console.log("Firepad: 'deleteScene' is only available for the screenplay edit mode")},a.prototype.restoreScene=function(a,b){if(this.readOnly)return void console.log("Firepad: read only mode");if("screenplay"===this.editorMode&&"edit"===this.screenplayMode){var c=this;setTimeout(function(){c.richTextCodeMirror_.restoreScene(a),b&&b()},0)}else console.log("Firepad: 'restoreScene' is only available for the screenplay edit mode")},a.prototype.lockScene=function(a,b,c){if(this.readOnly)return void console.log("Firepad: read only mode");if("screenplay"===this.editorMode&&"edit"===this.screenplayMode){var d=this;setTimeout(function(){var e=d.richTextCodeMirror_.lockScene(a,b);if(c){var f=d.richTextCodeMirror_.getScenes();c(f,e)}},0)}else console.log("Firepad: 'lockScene' is only available for the screenplay edit mode")},a.prototype.lockScenes=function(a,b,c){if(this.readOnly)return void console.log("Firepad: read only mode");if("screenplay"===this.editorMode&&"edit"===this.screenplayMode){var d=this;2===arguments.length&&"function"==typeof b&&(c=b,b=[]),setTimeout(function(){var e=d.richTextCodeMirror_.lockScenes(a,b);if(c){var f=d.richTextCodeMirror_.getScenes();c(f,e)}},0)}else console.log("Firepad: 'lockScenes' is only available for the screenplay edit mode")},a.prototype.screenplayAutoFormat=function(){return this.readOnly?void console.log("Firepad: read only mode"):void("screenplay"===this.editorMode&&"edit"===this.screenplayMode?this.richTextCodeMirror_.screenplayAutoFormat(!0):console.log("Firepad: 'screenplayAutoFormat' is only available for the screenplay edit mode"))},a.prototype.orderedList=function(){return this.readOnly?void console.log("Firepad: read only mode"):(this.richTextCodeMirror_.toggleLineAttribute(m.LIST_TYPE,"o"),void this.codeMirror_.focus())},a.prototype.unorderedList=function(){return this.readOnly?void console.log("Firepad: read only mode"):(this.richTextCodeMirror_.toggleLineAttribute(m.LIST_TYPE,"u"),void this.codeMirror_.focus())},a.prototype.todo=function(){return this.readOnly?void console.log("Firepad: read only mode"):(this.richTextCodeMirror_.toggleTodo(),void this.codeMirror_.focus())},a.prototype.newline=function(){return this.readOnly?void console.log("Firepad: read only mode"):(this.richTextCodeMirror_.newline(),void("screenplay"===this.editorMode&&"edit"===this.screenplayMode&&this.richTextCodeMirror_.screenplayAutoFormat(!1,"newline")))},a.prototype.deleteLeft=function(){return this.readOnly?void console.log("Firepad: read only mode"):void this.richTextCodeMirror_.deleteLeft()},a.prototype.deleteRight=function(){return this.readOnly?void console.log("Firepad: read only mode"):void this.richTextCodeMirror_.deleteRight()},a.prototype.indent=function(){return this.readOnly?void console.log("Firepad: read only mode"):(this.richTextCodeMirror_.indent(),void this.codeMirror_.focus())},a.prototype.unindent=function(){return this.readOnly?void console.log("Firepad: read only mode"):(this.richTextCodeMirror_.unindent(),void this.codeMirror_.focus())},a.prototype.undo=function(){return this.readOnly?void console.log("Firepad: read only mode"):void this.codeMirror_.undo()},a.prototype.redo=function(){return this.readOnly?void console.log("Firepad: read only mode"):void this.codeMirror_.redo()},a.prototype.insertEntity=function(a,b,c){return this.readOnly?void console.log("Firepad: read only mode"):void this.richTextCodeMirror_.insertEntityAtCursor(a,b,c)},a.prototype.insertEntityAt=function(a,b,c,d){return this.readOnly?void console.log("Firepad: read only mode"):void this.richTextCodeMirror_.insertEntityAt(a,b,c,d)},a.prototype.registerEntity=function(a,b){return this.readOnly?void console.log("Firepad: read only mode"):void this.entityManager_.register(a,b)},a.prototype.getOption=function(a,b){return a in this.options_?this.options_[a]:b},a.prototype.assertReady_=function(a){if(!this.ready_)throw new Error('You must wait for the "ready" event before calling '+a+".");if(this.zombie_)throw new Error("You can't use a Firepad after calling dispose()!  [called "+a+"]")},a.prototype.makeImageDialog_=function(){this.makeDialog_("img","Insert image url")},a.prototype.makeDialog_=function(a,b){var c=this,d=function(){var a=document.getElementById("overlay");a.style.visibility="hidden",c.firepadWrapper_.removeChild(a)},e=function(){var b=document.getElementById("overlay");b.style.visibility="hidden";var d=document.getElementById(a).value;null!==d&&c.insertEntity(a,{src:d}),c.firepadWrapper_.removeChild(b)},f=n.elt("input",null,{"class":"firepad-dialog-input",id:a,type:"text",placeholder:b,autofocus:"autofocus"}),g=n.elt("a","Submit",{"class":"firepad-btn",id:"submitbtn"});n.on(g,"click",n.stopEventAnd(e));var h=n.elt("a","Cancel",{"class":"firepad-btn"});n.on(h,"click",n.stopEventAnd(d));var i=n.elt("div",[g,h],{"class":"firepad-btn-group"}),j=n.elt("div",[f,i],{"class":"firepad-dialog-div"}),k=n.elt("div",[j],{"class":"firepad-dialog",id:"overlay"});this.firepadWrapper_.appendChild(k)},a.prototype.addRichtextToolbar_=function(){this.toolbar=new h(this.imageInsertionUI),this.toolbar.on("undo",this.undo,this),this.toolbar.on("redo",this.redo,this),this.toolbar.on("bold",this.bold,this),this.toolbar.on("italic",this.italic,this),this.toolbar.on("underline",this.underline,this),this.toolbar.on("strike",this.strike,this),this.toolbar.on("font-size",this.fontSize,this),this.toolbar.on("font",this.font,this),this.toolbar.on("color",this.color,this),this.toolbar.on("left",function(){this.align("left")},this),this.toolbar.on("center",function(){this.align("center")},this),this.toolbar.on("right",function(){this.align("right")},this),this.toolbar.on("ordered-list",this.orderedList,this),this.toolbar.on("unordered-list",this.unorderedList,this),this.toolbar.on("todo-list",this.todo,this),this.toolbar.on("indent-increase",this.indent,this),this.toolbar.on("indent-decrease",this.unindent,this),this.toolbar.on("insert-image",this.makeImageDialog_,this),this.firepadWrapper_.insertBefore(this.toolbar.element(),this.firepadWrapper_.firstChild)},a.prototype.addScreenplayToolbar_=function(){this.toolbar=new i,this.toolbar.on("screenplay-scene",function(){this.setLineClass("pc-scene")},this),this.toolbar.on("screenplay-action",function(){this.setLineClass("pc-action")},this),this.toolbar.on("screenplay-character",function(){this.setLineClass("pc-character")},this),this.toolbar.on("screenplay-dialogue",function(){this.setLineClass("pc-dialogue")},this),this.toolbar.on("screenplay-parenthetical",function(){this.setLineClass("pc-parenthetical")},this),this.toolbar.on("screenplay-transition",function(){this.setLineClass("pc-transition")},this),this.toolbar.on("screenplay-act-start",function(){this.setLineClass("pc-act-start")},this),this.toolbar.on("screenplay-act-end",function(){this.setLineClass("pc-act-end")},this),this.toolbar.on("screenplay-centered",function(){this.setLineClass("pc-centered")},this),this.toolbar.on("screenplay-auto-format",this.screenplayAutoFormat,this),this.firepadWrapper_.insertBefore(this.toolbar.element(),this.firepadWrapper_.firstChild)},a.prototype.initializeRichtextKeyMap_=function(){function a(a){return function(b){setTimeout(function(){a.call(b.firepad)},0)}}CodeMirror.keyMap.richtext={"Ctrl-B":a(this.bold),"Cmd-B":a(this.bold),"Ctrl-I":a(this.italic),"Cmd-I":a(this.italic),"Ctrl-U":a(this.underline),"Cmd-U":a(this.underline),"Ctrl-H":a(this.highlight),"Cmd-H":a(this.highlight),Enter:a(this.newline),Delete:a(this.deleteRight),Backspace:a(this.deleteLeft),Tab:a(this.indent),"Shift-Tab":a(this.unindent),fallthrough:["default"]}},a.prototype.initializeScreenplayKeyMap_=function(){function a(a){return function(b){setTimeout(function(){a.call(b.firepad)},0)}}CodeMirror.keyMap.screenplay={Enter:a(this.newline),Delete:a(this.deleteRight),Backspace:a(this.deleteLeft),fallthrough:["default"]}},a}(this),d.Firepad.Formatting=d.Formatting,d.Firepad.Text=d.Text,d.Firepad.Entity=d.Entity,d.Firepad.LineFormatting=d.LineFormatting,d.Firepad.Line=d.Line,d.Firepad.TextOperation=d.TextOperation,d.Firepad.Headless=d.Headless,d.Firepad.RichTextCodeMirrorAdapter=d.RichTextCodeMirrorAdapter,d.Firepad},this);